
ACTION_IF FILE_EXISTS ~atweaks/lib/temp.tpa~ BEGIN //stuff that's pending inclusion in WeiDU
  INCLUDE ~atweaks/lib/temp.tpa~
END

//Adds immunity to the provided spell to blindness-causing spells and items
DEFINE_ACTION_FUNCTION add_blindness_immunity BEGIN
  COPY_EXISTING spdr101.spl  override
		spin595.spl  override
		spin878.spl  override
		spin893.spl  override
		spin929.spl  override
		spin931.spl  override
		sppr704.spl  override
		sppr707.spl  override
		spwi106.spl  override
		spwi118.spl  override
		spwi224.spl  override
		spwi714.spl  override
		spwi815.spl  override
		spwi958.spl  override
		spwm178.spl  override
		chalcy2.itm  override
		gorwom4.itm  override
		halb06.itm   override
		sorb.itm     override
		sw1h51.itm   override
		wand19.itm   override
    PHP_EACH array_as_argument AS idx => f_Spell BEGIN
      LPF add_conditional_immunity
	INT_VAR f_Condition = 74
	STR_VAR f_Spell
      END
    END
    CLEAR_ARRAY array_as_argument
  BUT_ONLY
END

//Deletes all extended effects from the source spell and sets casting time for all extended headers to f_CastingTime
DEFINE_PATCH_FUNCTION prep_for_gate INT_VAR f_CastingTime = 1 BEGIN
  READ_LONG  0x64 ao
  READ_LONG  0x6a eo
  READ_SHORT 0x70 ei
  FOR (i=0;i<SHORT_AT 0x68;++i) BEGIN
    WRITE_SHORT ao + 0x28*i + 0x12 f_CastingTime
    WRITE_SHORT ao + 0x28*i + 0x20 ei
    READ_SHORT  ao + 0x28*i + 0x1e ne
    FOR (j=0;j<ne;++j) BEGIN
      DELETE_BYTES eo + 0x30*(j + ei) 0x30
      --j
      --ne
    END
    WRITE_SHORT ao + 0x28*i + 0x1e ne
    ei += ne
  END
END

//Adds an opcode 206 (protection from spell) with the resref f_Spell to the extended header of the source spell or item,
//if an effect of type f_Condition is found on the header
//the string which is displayed when the spell fails can be set via f_Strref which defaults to 0 (meaning no message)
DEFINE_PATCH_FUNCTION add_conditional_immunity INT_VAR f_Condition = 999 f_Strref = 0 BEGIN
  PATCH_IF SOURCE_SIZE > 0x71 BEGIN
    READ_LONG  0x64 ao
    READ_LONG  0x6a eo
    READ_SHORT 0x70 ei
    al = "%SOURCE_EXT%" STRING_EQUAL_CASE spl ? 0x28 : 0x38
    FOR (i=0;i<SHORT_AT 0x68;++i) BEGIN
      WRITE_SHORT ao + al*i + 0x20 ei
      READ_SHORT  ao + al*i + 0x1e ne
      FOR (j=0;j<ne;++j) BEGIN
        READ_SHORT eo + 0x30*(ei + j) type
        PATCH_IF type = f_Condition BEGIN
          READ_ASCII   eo + 0x30*(ei + j) copy (0x30)
          INSERT_BYTES eo + 0x30*(ei + j) 0x30
            WRITE_ASCIIE eo + 0x30*(ei + j)        "%copy%"
            WRITE_SHORT  eo + 0x30*(ei + j)        206 //immunity to spell
            WRITE_LONG   eo + 0x30*(ei + j) + 0x4  "%f_Strref%"
            WRITE_ASCIIE eo + 0x30*(ei + j) + 0x14 "%f_Spell%" #8
          ++ne
          j=ne
        END
      END
      WRITE_SHORT ao + al*i + 0x1e ne
      ei+=ne
    END
  END
END

//Deletes all effects and extended headers from the source item or spell and inserts a new extended header of type f_Type (defaults to f_Type = 1),
//provided f_Type >= 0
//if the source file is an item file and f_Type = 1, the function launches an auxilliary function to set up the basics of the melee header
//FAILs if the source file is too small or doesn't have an ITM or SPL file extension
DEFINE_PATCH_FUNCTION prep_itm_spl INT_VAR f_Type = 1 BEGIN
  PATCH_IF SOURCE_SIZE > 0x71 AND ("%SOURCE_EXT%" STRING_EQUAL_CASE itm OR "%SOURCE_EXT%" STRING_EQUAL_CASE spl) BEGIN
    al = "%SOURCE_EXT%" STRING_EQUAL_CASE spl ? 0x28 : 0x38
    READ_LONG  0x64 ao
    READ_SHORT 0x68 na
    READ_LONG  0x6a eo
    FOR (i = na - 1; i >= 0; --i) BEGIN
      READ_SHORT ao + al*i + 0x1e ne
      READ_SHORT ao + al*i + 0x20 ei
      FOR (j = ne - 1; j >= 0; --j) BEGIN
        DELETE_BYTES eo + 0x30*(ei + j) 0x30
      END
      DELETE_BYTES ao + al*i al
      --na
      eo -= al
    END
    READ_SHORT 0x70 ne
    FOR (i=0;i<ne;++i) BEGIN
      DELETE_BYTES eo + 0x30*i 0x30
      --ne
      --i
    END
    WRITE_SHORT 0x70 ne
    PATCH_IF f_Type >= 0 BEGIN
      INSERT_BYTES ao al
      WRITE_BYTE ao f_Type
      ++na
      eo+=al
    END
    WRITE_SHORT 0x68 na
    WRITE_LONG  0x6a eo
    READ_ASCII 0x3a f_Icon
    PATCH_IF f_Type = 1 AND al = 0x38 BEGIN
      LPF configure_weapon_header STR_VAR f_Icon END
    END
  END ELSE BEGIN
    PATCH_FAIL ~File %SOURCE_FILE% is below required size or of unrecognised type.~
  END
END

DEFINE_PATCH_FUNCTION configure_header
  INT_VAR
    f_Header = "-1"
    f_TargetType = "-1"

    f_Type = "-1"
    f_Identify = "-1"
    f_Slot = "-1"
    f_Target = "-1"
    f_Range = "-1"
    f_Launcher = "-1"
    f_Speed = "-1"
    f_ToHit = "-1"
    f_Damage = "-1"
    f_NumDice = "-1"
    f_DieSize = "-1"
    f_DamageType = "-1"
    f_Flags = "-1"
    f_Charges = "-1"
    f_Drained = "-1"
    f_Projectile = "-1"
    f_Overhand = "-1"
    f_Backhand = "-1"
    f_Thrust = "-1"
    f_Arrow = "-1"
    f_Bolt = "-1"
    f_Bullet = "-1"
  STR_VAR
    f_Icon = flEmpty
BEGIN
  READ_LONG  0x64 ao
  FOR (i=0;i<SHORT_AT 0x68;++i) BEGIN
    READ_BYTE ao + 0x38*i type
    PATCH_IF type = f_TargetType OR i = f_Header OR (f_Header < 0 AND f_TargetType < 0) BEGIN
      WRITE_BYTE   ao + 0x38*i        f_Type < 0 ? THIS : f_Type
      WRITE_BYTE   ao + 0x38*i + 0x2  f_Slot < 0 ? THIS : f_Slot
      PATCH_IF "%f_Icon%" STRING_COMPARE flEmpty BEGIN
        WRITE_ASCIIE ao + 0x38*i + 0x4  "%f_Icon%"
      END
      WRITE_BYTE   ao + 0x38*i + 0xc  f_Target < 0 ? THIS : f_Target
      WRITE_SHORT  ao + 0x38*i + 0xe  f_Range < 0 ? THIS : f_Range
      WRITE_BYTE   ao + 0x38*i + 0x12 f_Speed < 0 ? THIS : f_Speed
      WRITE_SHORT  ao + 0x38*i + 0x14 f_ToHit < 0 ? THIS : f_ToHit
      WRITE_BYTE   ao + 0x38*i + 0x16 f_DieSize < 0 ? THIS : f_DieSize
      WRITE_BYTE   ao + 0x38*i + 0x18 f_NumDice < 0 ? THIS : f_NumDice
      WRITE_SHORT  ao + 0x38*i + 0x1a f_Damage < 0 ? THIS : f_Damage
      WRITE_SHORT  ao + 0x38*i + 0x1c f_DamageType < 0 ? THIS : f_DamageType
      WRITE_SHORT  ao + 0x38*i + 0x22 f_Charges < 0 ? THIS : f_Charges
      WRITE_SHORT  ao + 0x38*i + 0x24 f_Drained < 0 ? THIS : f_Drained
      WRITE_LONG   ao + 0x38*i + 0x26 f_Flags < 0 ? THIS : f_Flags
      WRITE_SHORT  ao + 0x38*i + 0x2a f_Projectile < 0 ? THIS : f_Projectile
      WRITE_SHORT  ao + 0x38*i + 0x2c f_Overhand < 0 ? THIS : f_Overhand
      WRITE_SHORT  ao + 0x38*i + 0x2e f_Backhand < 0 ? THIS : f_Backhand
      WRITE_SHORT  ao + 0x38*i + 0x30 f_Thrust < 0 ? THIS : f_Thrust
      WRITE_SHORT  ao + 0x38*i + 0x32 f_Arrow < 0 ? THIS : f_Arrow
      WRITE_SHORT  ao + 0x38*i + 0x34 f_Bolt < 0 ? THIS : f_Bolt
      WRITE_SHORT  ao + 0x38*i + 0x36 f_Bullet < 0 ? THIS : f_Bullet
    END
  END
END

//Writes to the more and less common fields of the item melee header
DEFINE_PATCH_FUNCTION configure_weapon_header
  INT_VAR
    f_Slot = 1
    f_Target = 1
    f_Range = 1
    f_Speed = 0
    f_ToHit = 0
    f_Damage = 0
    f_NumDice = 0
    f_DieSize = 0
    f_DamageType = 0
    f_Flags = 1
    f_Charges = 0
    f_Drained = 1
    f_Projectile = 1
    f_Overhand = 34
    f_Backhand = 33
    f_Thrust = 33
    f_Arrow = 0
    f_Bolt = 0
    f_Bullet = 0
  STR_VAR
    f_Icon = ~~
BEGIN
  LPF configure_header
    INT_VAR
      f_TargetType = 1
      f_Slot
      f_Target
      f_Range
      f_Speed
      f_ToHit
      f_Damage
      f_NumDice
      f_DieSize
      f_DamageType
      f_Flags
      f_Charges
      f_Drained
      f_Projectile
      f_Overhand
      f_Backhand
      f_Thrust
      f_Arrow
      f_Bolt
      f_Bullet
    STR_VAR
      f_Icon
  END
END

DEFINE_ACTION_FUNCTION get_from_file_by_row_count INT_VAR f_Label_col = 0 STR_VAR f_Label = "" f_File = "" RET f_Value BEGIN
  ACTION_IF "%f_Label%" STR_CMP "" AND "%f_File%" STR_CMP "" BEGIN
    COPY_EXISTING "%f_File%" override
      READ_2DA_ENTRIES_NOW buff 2
      FOR (i = 0; i < buff; ++i) BEGIN
        READ_2DA_ENTRY_FORMER buff i f_Label_col label
        PATCH_IF "%label%" STRING_EQUAL_CASE "%f_Label%" BEGIN
          f_Value = i - 1 // -1 because row 0 is (2DA|IDS) V1.0
          i = buff
        END
      END
    BUT_ONLY
  END
END

DEFINE_ACTION_FUNCTION get_from_file_by_assoc INT_VAR f_Label_col = 0 f_Value_col = 1 STR_VAR f_Label = "" f_File = "" RET f_Value BEGIN
  ACTION_IF "%f_Label%" STR_CMP "" AND "%f_File%" STR_CMP "" BEGIN
    COPY_EXISTING "%f_File%" override
      READ_2DA_ENTRIES_NOW buff 2
      FOR (i = buff - 1; i >= 0; --i) BEGIN
        READ_2DA_ENTRY_FORMER buff i f_Label_col label
        PATCH_IF "%label%" STRING_EQUAL_CASE "%f_Label%" BEGIN
          READ_2DA_ENTRY_FORMER buff i f_Value_col f_Value
          i = "-1"
        END
      END
    BUT_ONLY
  END
END

DEFINE_ACTION_FUNCTION get_sectype STR_VAR f_Label = "" RET f_Value BEGIN
  LAF get_from_file_by_row_count STR_VAR f_Label f_File = msectype.2da RET f_Value = f_Value END
END

DEFINE_ACTION_FUNCTION get_projectile STR_VAR f_Label = "" RET f_Value BEGIN
  LAF get_from_file_by_assoc INT_VAR f_Label_col = 1 f_Value_col = 0 STR_VAR f_Label f_File = missile.ids RET f_Value = f_Value END
END

//Creates copies of the first header up to f_FillLimit (default is 20 headers)
DEFINE_PATCH_FUNCTION fill_headers INT_VAR f_FillLimit = 20 BEGIN
  al = "%SOURCE_EXT%" STRING_EQUAL_CASE spl ? 0x28 : 0x38
  READ_LONG   0x64 ao
  READ_SHORT  0x68 na
  READ_LONG   0x6a eo
  READ_ASCII  ao ab_copy (al)
  number = f_FillLimit - na
  FOR (i=0;i<number;++i) BEGIN
    INSERT_BYTES   ao + al*na al
      WRITE_ASCIIE ao + al*na "%ab_copy%"
    ++na
    eo += al
  END
  WRITE_SHORT 0x68 na
  WRITE_LONG  0x6a eo
END

//Writes to the more and less usual fields of the spell header (count starts at 1)
//writes to all headers if f_Header < 0 (default)
//Minimum level defaults to header number (starting from 1)
DEFINE_PATCH_FUNCTION configure_spell_header INT_VAR
                                                     f_Header = "-1"
                                                     f_Type = 1
                                                     f_Location = 2
                                                     f_Target = 1
                                                     f_Range = 30
                                                     f_Level = "-1"
                                                     f_CastTime = 1
                                                     f_Projectile = 1
                                              STR_VAR
                                                     f_Icon = ~~
BEGIN
  READ_LONG  0x64 ao
  READ_SHORT 0x68 na
  FOR (i=0;i<na;++i) BEGIN
    PATCH_IF (i+1) = f_Header OR f_Header < 0 BEGIN
     WRITE_ASCIIE ao + 0x28*i + 0x4  "%f_Icon%" #8
      WRITE_BYTE  ao + 0x28*i + 0x0  f_Type
      WRITE_SHORT ao + 0x28*i + 0x2  f_Location
      WRITE_BYTE  ao + 0x28*i + 0xc  f_Target
      WRITE_SHORT ao + 0x28*i + 0xe  f_Range
      WRITE_SHORT ao + 0x28*i + 0x10 f_Level < 0 ? i + 1 : f_Level
      WRITE_SHORT ao + 0x28*i + 0x12 f_CastTime
      WRITE_SHORT ao + 0x28*i + 0x26 f_Projectile
    END
  END
END

//Called from integrate_sectypes
DEFINE_PATCH_FUNCTION integrate_sectypes_inner BEGIN
  READ_LONG  0x64 ao
  READ_SHORT 0x68 na
  READ_LONG  0x6a eo
  READ_SHORT 0x6e ei1
  READ_SHORT 0x70 gne

  PATCH_IF "%SOURCE_EXT%" STRING_EQUAL_CASE itm BEGIN
    FOR (i=0;i<gne;++i) BEGIN
      READ_SHORT eo + 0x30*(ei1 + i)       type ELSE 999
      READ_LONG  eo + 0x30*(ei1 + i) + 0x8 p2   ELSE 999

      //This works as long as we always insert the new effects in front of the ones that trigger the insertion of a new effect
      PATCH_IF type = 206 BEGIN
        READ_ASCII eo + 0x30 * (ei1 + i) + 0x14 rr ELSE nil
        TO_LOWER rr
        SET $onequip_immunity("%rr%") = 1
      END

      //On-equip immunity
      PATCH_IF type = 101 AND VARIABLE_IS_SET $f_ImmunitySecType("%p2%") BEGIN
        PHP_EACH f_AddSecType AS file => SecTypeToAdd BEGIN
          PATCH_IF "%file%" STRING_MATCHES_REGEXP ".*\.spl$" = 0 AND SecTypeToAdd = $f_ImmunitySecType("%p2%") BEGIN
            INNER_PATCH "%file%" BEGIN
              READ_ASCII 0 spell (STRING_LENGTH "%file%" - 4)
            END
            TO_LOWER spell
            PATCH_IF !VARIABLE_IS_SET $onequip_immunity("%spell%") BEGIN
              INSERT_BYTES   eo + 0x30 * (ei1 + i)        0x30
                WRITE_SHORT  eo + 0x30 * (ei1 + i)        206 //protection from spell
                WRITE_BYTE   eo + 0x30 * (ei1 + i) + 0x2  1
                WRITE_BYTE   eo + 0x30 * (ei1 + i) + 0xc  2
                WRITE_BYTE   eo + 0x30 * (ei1 + i) + 0x12 100
                WRITE_ASCIIE eo + 0x30 * (ei1 + i) + 0x14 "%spell%" #8
              ++i
              ++gne
            END
          END
        END
      END
    END
  END

  WRITE_SHORT 0x70 gne
  ei = gne = 0 ? 0 : ei1 + gne //Some mod files have illegal values for ei1, but the engine disregards the illegal value because gne is 0; we do the same
  ne = 0
  al = "%SOURCE_EXT%" STRING_EQUAL_CASE itm ? 0x38 : 0x28

  //Check for effects to remove e.g. fear or disease and effects that grant immunity to e.g. fear or disease
  FOR (i=0;i<na AND ao + na*al < SOURCE_SIZE;++i) BEGIN
    ei += ne
    WRITE_SHORT ao + al*i + 0x20 ei
    READ_SHORT  ao + al*i + 0x1e ne
    FOR (j=0;j<ne;++j) BEGIN
      READ_SHORT eo + 0x30*(ei + j)        type   ELSE 999
      READ_BYTE  eo + 0x30*(ei + j) + 0x2  target ELSE 0
      READ_BYTE  eo + 0x30*(ei + j) + 0x3  power  ELSE 0
      READ_LONG  eo + 0x30*(ei + j) + 0x4  p1     ELSE 999
      READ_LONG  eo + 0x30*(ei + j) + 0x8  p2     ELSE 999
      READ_BYTE  eo + 0x30*(ei + j) + 0xc  timing ELSE 0
      READ_BYTE  eo + 0x30*(ei + j) + 0xd  dr     ELSE 0
      READ_LONG  eo + 0x30*(ei + j) + 0xe  time   ELSE 0

      //This works as long as we always insert the new effects in front of the ones that trigger the insertion of the new effect
      PATCH_IF type = 221 BEGIN
        SET $extended_sectype_immunity("%i%" "%p2%") = 1
      END
      PATCH_IF type = 206 BEGIN
        READ_ASCII eo + 0x30 * (ei + j) + 0x14 rr ELSE nil
        TO_LOWER rr
        SET $extended_spell_immunity("%i%" "%rr%") = 1
      END



      PATCH_IF VARIABLE_IS_SET $f_RemoveSecType("%type%") BEGIN
        check = $f_RemoveSecType("%type%")
        PATCH_IF !VARIABLE_IS_SET $extended_sectype_immunity("%i%" "%check%") BEGIN
          INSERT_BYTES  eo + 0x30*(ei + j)        0x30
            WRITE_SHORT eo + 0x30*(ei + j)        221 //remove sec type
            WRITE_BYTE  eo + 0x30*(ei + j) + 0x2  target
            WRITE_BYTE  eo + 0x30*(ei + j) + 0x3  power
            WRITE_LONG  eo + 0x30*(ei + j) + 0x4  9
            WRITE_LONG  eo + 0x30*(ei + j) + 0x8  $f_RemoveSecType("%type%")
            WRITE_BYTE  eo + 0x30*(ei + j) + 0xc  1
            WRITE_BYTE  eo + 0x30*(ei + j) + 0x12 100
          ++ne
          ++j
        END
      END



      PATCH_IF type = 101 AND VARIABLE_IS_SET $f_ImmunitySecType("%p2%") BEGIN
        PHP_EACH f_AddSecType AS file => SecTypeToAdd BEGIN
          PATCH_IF "%file%" STRING_MATCHES_REGEXP ".+\.spl$" = 0 AND SecTypeToAdd = $f_ImmunitySecType("%p2%") BEGIN
            INNER_PATCH "%file%" BEGIN
              READ_ASCII 0 spell (STRING_LENGTH "%file%" - 4)
            END
            TO_LOWER spell
            PATCH_IF !VARIABLE_IS_SET $extended_spell_immunity("%i%" "%spell%") BEGIN
              INSERT_BYTES   eo + 0x30*(ei + j)        0x30
                WRITE_SHORT  eo + 0x30*(ei + j)        206 //protection from spell
                WRITE_BYTE   eo + 0x30*(ei + j) + 0x2  target
                WRITE_BYTE   eo + 0x30*(ei + j) + 0x3  power
                WRITE_BYTE   eo + 0x30*(ei + j) + 0xc  timing
                WRITE_BYTE   eo + 0x30*(ei + j) + 0xd  dr
                WRITE_LONG   eo + 0x30*(ei + j) + 0xe  time
                WRITE_BYTE   eo + 0x30*(ei + j) + 0x12 100
                WRITE_ASCIIE eo + 0x30*(ei + j) + 0x14 "%spell%" #8
              ++ne
              ++j
            END
          END
        END
      END



    END
    WRITE_SHORT ao + al*i + 0x1e ne
  END
END

DEFINE_PATCH_FUNCTION integrate_sectype_cre BEGIN
  READ_LONG 0x2c4 eo

  // First, check out what's already there
  FOR (i = 0; i < LONG_AT 0x2c8; ++i) BEGIN
    p = eo + 0x108 * i + 0x8
    READ_LONG p fx ELSE 999
    PATCH_IF type = 206 BEGIN // Protecton from spell
      READ_ASCII p + 0x14 rr ELSE nil
      TO_LOWER rr
      SET $extended_spell_immunity("%rr%") = 1
    END
    PATCH_IF fx = 101 BEGIN // Immunity to effect
      READ_LONG p + 0x10 p2 ELSE 999
      SET $immunities("%p2%") = 1
    END
  END

  // Then we see what, if anything, we need to do
  PHP_EACH immunities AS type => i BEGIN
    PATCH_IF VARIABLE_IS_SET $f_ImmunitySecType("%type%") BEGIN
      PHP_EACH f_AddSecType AS file => SecTypeToAdd BEGIN
        PATCH_IF "%file%" STRING_MATCHES_REGEXP ".+\.spl$" = 0 AND SecTypeToAdd = $f_ImmunitySecType("%type%") BEGIN
          INNER_PATCH "%file%" BEGIN
            READ_ASCII 0 spell (STRING_LENGTH "%file%" - 4)
          END
          TO_LOWER spell
          PATCH_IF !VARIABLE_IS_SET $extended_spell_immunity("%spell%") BEGIN
            LPF ADD_CRE_EFFECT
              INT_VAR
                opcode = 206
                target = 1
                timing = 9
              STR_VAR
                resource = EVAL "%spell%"
            END
          END
        END
      END
    END
  END
END


//Add the SecTypes to items and spells that should grant immunity or be able to remove them
//Needs the three arrays:
//f_AddSecType(file) = SecType -> Associates a SecType with a specific file. Items and spells that grant immunity to e.g. disease will grant immunity to this particular file (spell) as well. Creatures with immunity effects will also be affected.
//f_ImmunitySecType(opcode) = SecType -> opcode is the opcode used to determine if a spell/item should grant immunity to the file (spell).
//f_RemoveSecType(opcode) = Secype -> opcode is the opcode used to determine if a spell/item should cure the secondary type.
//E.g. is your secondary type covers disease you would have:
//f_AddSecType(YourDisease-causingSpell.spl) = YourDiseaseSecType
//f_ImmunitySecType(78) = YourDiseaseSecType
//f_RemoveSecType(79) = YourDiseaseSecType
DEFINE_ACTION_FUNCTION integrate_sectypes BEGIN
  COPY_EXISTING_REGEXP GLOB ~.+\.\(spl\|itm\)$~ override
    PATCH_IF SOURCE_SIZE > 0x71 BEGIN
      LPF integrate_sectypes_inner END
    END
  BUT_ONLY
  COPY_EXISTING_REGEXP GLOB ~.+\.cre$~ override
    PATCH_IF SOURCE_SIZE > 0x2d3 BEGIN
      LPF integrate_sectype_cre END
    END
  BUT_ONLY
END

DEFINE_PATCH_MACRO update_fiend_xp BEGIN
  WRITE_LONG 0x14 THIS > newxpv ? THIS : newxpv
END


// The Shield spell and amulet should protect from RR/aTweaks' cloned Magic Missile
DEFINE_ACTION_FUNCTION magic_missile_shield BEGIN
ACTION_IF !FILE_CONTAINS_EVALUATED (spwi114.spl "RR#WI112") BEGIN
COPY_EXISTING ~spwi114.spl~ ~override~ // Shield (WIZARD_SHIELD)
  READ_LONG  0x64 "abil_off" ELSE 0
  READ_SHORT 0x68 "abil_num" ELSE 0
  READ_LONG  0x6a "fx_off"   ELSE 0
  SET "delta" = 0
  FOR (index = 0 ; index < abil_num ; index = index + 1) BEGIN
    READ_SHORT ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    SET "abil_fx_idx" = ("%abil_fx_idx%" + "%delta%")
    WRITE_SHORT ("%abil_off%" + 0x20 + (0x28 * "%index%")) "%abil_fx_idx%"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
     READ_SHORT ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "opcode"
     READ_ASCII ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "resref"
     READ_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%abil_fx_idx%" + "%index2%"))) "resref"
      PATCH_IF (("%opcode%" = "206") AND ("%resref%" STRING_EQUAL_CASE ~SPWI112~)) BEGIN           // effect #206: Protection from Spell
        READ_ASCII ("%fx_off%" +        (("%abil_fx_idx%" + "%index2%") * 0x30)) "clone_fx" (0x30) // clone effect
        SET "index2"= "%abil_fx_num%" // kills loop
        INSERT_BYTES            ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) 0x30                // new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        ("%abil_fx_idx%" * 0x30)) "%clone_fx%"        // cloned effect
          WRITE_ASCII           ("%fx_off%" + 0x14 + ("%abil_fx_idx%" * 0x30)) "RR#WI112" #8       // resref (RR/aTweaks cloned Magic Missile)
        SET "delta" = "%delta%" + 1
        WRITE_SHORT ("%abil_off%" + 0x1e + (0x28 * "%index%")) ("%abil_fx_num%" + 1)
      END
    END
  END
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~amul15.itm~   ~override~ // Shield Amulet
  READ_LONG  0x64 "abil_off" ELSE 0
  READ_SHORT 0x68 "abil_num" ELSE 0
  READ_LONG  0x6a "fx_off"   ELSE 0
  SET "abil_length" = 0x38
  SET "fx_delta" = 0
  FOR (index = 0 ; index < abil_num ; index = index + 1) BEGIN // start iterating through abilities
    READ_SHORT  ("%abil_off%" + 0x1e + ("%abil_length%" * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + ("%abil_length%" * "%index%")) "abil_fx_idx"
    SET "abil_fx_idx" = ("%abil_fx_idx%" + "%fx_delta%")
    WRITE_SHORT ("%abil_off%" + 0x20 + ("%abil_length%" * "%index%")) ("%abil_fx_idx%")
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x08 + (0x30 * ("%abil_fx_idx%" + "%index2%"))) "param2"
      PATCH_IF (("%opcode%" = "142") AND ("%param2%" = "15")) BEGIN // display shield icon
        READ_ASCII ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "clone" (48) // clone fx
        INSERT_BYTES            ("%fx_off%" +        (0x30 * "%abil_fx_idx%")) 0x30           // insert new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        (0x30 * "%abil_fx_idx%")) "%clone%"      // clones effect
          WRITE_SHORT           ("%fx_off%" +        (0x30 * "%abil_fx_idx%")) "206"          // effect #206: Protection from Spell
          WRITE_LONG            ("%fx_off%" + 0x04 + (0x30 * "%abil_fx_idx%")) "0"            // param1: 0 (empty strref)
          WRITE_LONG            ("%fx_off%" + 0x08 + (0x30 * "%abil_fx_idx%")) "0"            // param2: 0
          WRITE_ASCII           ("%fx_off%" + 0x14 + (0x30 * "%abil_fx_idx%")) ~RR#WI112~ #8  // resref (RR/aTweaks cloned Magic Missile)
        SET "fx_delta" = "%fx_delta%" + 1
        SET "abil_fx_num" = "%abil_fx_num%" + 1
        WRITE_SHORT  ("%abil_off%" + 0x1e + ("%abil_length%" * "%index%")) "%abil_fx_num%"
        SET "index2" = "%abil_fx_num%" // kills loop
      END
    END
  END
  BUT_ONLY_IF_IT_CHANGES

ACTION_IF MOD_IS_INSTALLED ITEM_PACK.TP2 2 THEN BEGIN                              // Checks for the Tweaked Items component of Daulmakan's Item Pack
  COPY_EXISTING ~amul15.itm~   ~override~                                          // Shield Amulet
    LPF ADD_ITEM_EQEFFECT
      INT_VAR opcode = 206 target = 1 timing = 2
      STR_VAR resource = RR#WI112
    END
END
END // ends initial ACTION_IF check
END // ends function definition




// Area effect spell immunities (prevents friendly fire and such)
// Fire spell immunities
DEFINE_PATCH_FUNCTION fire_spell_immunities BEGIN
    PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells
                ~SPIN561~                                                              // Fire Giant Lava Pit (FIRE_GIANT_LAVA)
                ~SPIN819~                                                              // Lava Burst (LAVA_BURST)
                ~SPWI022~                                                              // Lava Pit (TRAP_MUCK)
                ~SPWI103~                                                              // Burning Hands
                ~SPWI217~                                                              // Agannazar's Scorcher
                ~SPWI304~                                                              // Fireball
               ~RR#WI304~                                                              // Pit Fiend Fireball
                ~SPWI523~                                                              // Sunfire
               ~RR#WI523~                                                              // RR's Sunfire (Blazing Glory buckler)
                ~SPWI712~                                                              // Delayed Blast Fireball
                ~SPWI810~                                                              // Incendiary Cloud
                ~SPWI911~                                                              // Meteor Swarm
                ~SPPR705~                                                              // Fire Storm
                ~RR#MFIFF~                                                             // Flame Fan (Fire Mephit)
                ~RR#MFIFJ~                                                             // Flame Jet (Fire Mephit)
                ~RR#MFIHA~                                                             // Heat Aura (Fire Mephit)
                ~RR#MMAHE~                                                             // Heat Emission (Magma Mephit)
                ~rr#eimhe~                                                             // Heat Emission (Imix)
                ~rr#eimfb~                                                             // Fireball, 20d6 (Imix)
                ~rr#ezafb~                                                             // Fireball, 12d6 (Zaaman Rul)
                ~rr#eburn~                                                             // Burn (Fire Elemental on-hit effect)
                ~rr#englf~                                                             // Engulf, part 1 (Greater Fire Elemental on-hit effect)
BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Cold spell immunities
DEFINE_PATCH_FUNCTION cold_spell_immunities BEGIN
    PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells
                ~SPWI404~                                                              // Ice Storm
               ~RR#WI404~                                                              // aTweaks/RR Ice Storm
                ~SPWI503~                                                              // Cone of Cold
                ~rr#icew~                                                              // aTweaks' Wall of Ice
               ~rr#efrzn~                                                              // aTweaks' Freeze (Cryonax)
               ~rr#ehyis~                                                              // aTweaks' Ice Storn (Olhydra's version)
BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Electrical spell immunities
DEFINE_PATCH_FUNCTION electrical_spell_immunities BEGIN
    PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells
               ~RR#WI308~                                                              // RR/aTweaks Lightning Bolt
BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
END                                                                                    // ends DEFINE_PATCH_FUNCTION



// Acid spell immunities
DEFINE_PATCH_FUNCTION acid_spell_immunities BEGIN
    PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells
                ~SPIN994~                                                              // Acid Pools in Durlag's Tower (ACID_DAMAGE_1)
                ~SPWI614~                                                              // Death Fog

BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Poison spell immunities
DEFINE_PATCH_FUNCTION poison_spell_immunities BEGIN
    PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells
                ~SPWI016~                                                              // Cloudkill (trap)
                ~SPWI502~                                                              // Cloudkill
               ~RR#WI502~                                                              // RR/aTweaks Cloudkill
                ~SPIN979~                                                              // Golem Gas Cloud
                ~SPIN642~                                                              // Poisonous Cloud
BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Cure & cause wound spell immunities
DEFINE_PATCH_FUNCTION cure_spell_immunities BEGIN
    PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells
                ~SPPR103~                                                              // Cure Light Wounds
                ~SPPR215~                                                              // Cure Medium Wounds  (Spell Revisions)
                ~SPPR315~                                                              // Cure Medium Wounds
                ~SPPR401~                                                              // Cure Serious Wounds
                ~SPPR404~                                                              // Neutralize Poison
                ~SPPR502~                                                              // Cure Critical Wounds
                ~SPPR514~                                                              // Mass Cure
                ~SPPR607~                                                              // Heal
                ~SPIN101~                                                              // Cure Light Wounds (Bhaalpower)
                ~SPIN551~                                                              // Cause Serious Wounds (Hive Mother)
                ~SPIN986~                                                              // Cause Serious Wounds (Beholder)
                ~SPCL211~                                                              // Paladin Lay On Hands
                ~BHAAL1A~                                                              // Mass Healing (Bhaalpower restored by Ascension/UB)
                ~RR#DCSW~                                                              // RR/aTweaks Cause Serious Wounds (Marilith)
                ~rr#csw~                                                               // aTweaks Cause Serious Wounds (externalized)
                ~rr#ccw~                                                               // aTweaks Cause Critical Wounds (externalized)
                ~rr#harm~                                                              // aTweaks Harm (externalized)
BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Cloud spell immunities
DEFINE_PATCH_FUNCTION cloud_spell_immunities BEGIN
PATCH_FOR_EACH ~spell~ IN                                                              // for each of the following spells
            ~SPWI004~                                                                  // Stinking Cloud (trap)
            ~SPWI016~                                                                  // Cloudkill (trap)
            ~SPWI213~                                                                  // Stinking Cloud
            ~SPWI502~                                                                  // Cloudkill
            ~SPWI614~                                                                  // Death Fog
            ~SPWI810~                                                                  // Incendiary Cloud
            ~SPIN940~                                                                  // Stinking Cloud (mephit)
            ~SPIN979~                                                                  // Golem Gas Cloud
            ~SPIN642~                                                                  // Poisonous Cloud
           ~RR#WI502~                                                                  // aTweaks' Cloudkill (used by Marilith)
           ~RR#MMSWF~                                                                  // Wall of Fog (aTweaks' Mist Mephit)
           ~RR#FCLD~                                                                   // Fog Cloud (aTweaks' Sirine)
           ~RR#FTVAP~                                                                  // Toxic Vapors (aTweaks' Mustard Jelly)
           ~RR#MOZSC~                                                                  // Stinking Cloud (aTweaks' Ooze Mephit)
           ~RR#ECHSF~                                                                  // Solid Fog (aTweaks)
           ~RR#WI213~                                                                  // Stinking Cloud (aTweaks)
BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    ~SPL~ BEGIN                                                                        // SPL file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_SPELL_EFFECT~                                         // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "2"                                                                 // target: 2 (pre-target)
        "timing" = "0"                                                                 // timing mode: 0 (duration)
        "duration" = "120"                                                             // duration
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "resist_dispel" = "3"                                                          // resist/dispel
        "power" = "0"                                                                  // power
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH SPL block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Poison immunity
DEFINE_PATCH_FUNCTION poison_immunity BEGIN
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "25"                                                            // param2: poison opcode
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "173"                                                               // effect: #173 (Poison Resistance Modifier)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "100"                                                           // param1: poison resistance amount
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "6"                                                             // param2: poison icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "142"                                                               // effect: #142 (Display Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "30"                                                            // param2: Protection from Poison icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      PATCH_FOR_EACH ~string~ IN                                                       // for each of the following strings
                 ~14017~                                                               // Poison
                 ~14662~                                                               // Poisoned
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      END                                                                              // ends FUNCTION
      END                                                                              // ends PATCH_FOR_EACH block
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "25"                                                            // param2: poison opcode
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "173"                                                               // effect: #173 (Poison Resistance Modifier)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "100"                                                           // param1: poison resistance amount
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "6"                                                             // param2: poison icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "142"                                                               // effect: #142 (Display Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "30"                                                            // param2: Protection from Poison icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      PATCH_FOR_EACH ~string~ IN                                                       // for each of the following strings
                 ~14017~                                                               // Poison
                 ~14662~                                                               // Poisoned
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // add new equipping effect
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      END                                                                              // ends FUNCTION
      END                                                                              // ends PATCH_FOR_EACH block
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Disease immunity
DEFINE_PATCH_FUNCTION disease_immunity BEGIN
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "78"                                                            // param2: disease opcode
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "7"                                                             // param2: disease icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      PATCH_FOR_EACH ~string~ IN                                                       // for each of the following strings
                 ~39752~                                                               // Stricken by a foul disease
                 ~54337~                                                               // Diseased
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      END                                                                              // ends FUNCTION
      END                                                                              // ends PATCH_FOR_EACH block
      PATCH_FOR_EACH ~spell~ IN                                                        // grant immunity to each of the following spells
                ~SPWI409~                                                              // Contagion
                ~FL#CSDIS~                                                             // aTweaks' Cause Disease
                ~RR#DPDIS~                                                             // aTweaks' Pit Fiend disease
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "0"                                                             // param1: string (none)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "78"                                                            // param2: disease opcode
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "7"                                                             // param2: disease icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      PATCH_FOR_EACH ~string~ IN                                                       // for each of the following strings
                 ~39752~                                                               // Stricken by a foul disease
                 ~54337~                                                               // Diseased
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // add new equipping effect
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      END                                                                              // ends FUNCTION
      END                                                                              // ends PATCH_FOR_EACH block
      PATCH_FOR_EACH ~spell~ IN                                                        // grant immunity to each of the following spells
                ~SPWI409~                                                              // Contagion
                ~FL#CSDIS~                                                             // aTweaks' Cause Disease
                ~RR#DPDIS~                                                             // aTweaks' Pit Fiend disease
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // add new equipping effect
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "0"                                                             // param1: string (none)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Bleeding immunity (note: disease/poison opcode immunity is not included)
DEFINE_PATCH_FUNCTION bleeding_immunity BEGIN
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "137"                                                           // param2: bleeding icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      PATCH_FOR_EACH ~string~ IN                                                       // for each of the following strings
                 ~54335~                                                               // Bleeding
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      END                                                                              // ends FUNCTION
      END                                                                              // ends PATCH_FOR_EACH block
      PATCH_FOR_EACH ~spell~ IN                                                        // grant immunity to each of the following spells
                  ~RR#BLEED~                                                           // aTweaks' Bleeding Wound (Cornugon)
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "0"                                                             // param1: string (none)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "137"                                                           // param2: bleeding icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      PATCH_FOR_EACH ~string~ IN                                                       // for each of the following strings
                 ~54335~                                                               // Bleeding
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // add new equipping effect
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      END                                                                              // ends FUNCTION
      END                                                                              // ends PATCH_FOR_EACH block
      PATCH_FOR_EACH ~spell~ IN                                                        // grant immunity to each of the following spells
                  ~RR#BLEED~                                                           // aTweaks' Bleeding Wound (Cornugon)
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "0"                                                             // param1: string (none)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Web immunity
DEFINE_PATCH_FUNCTION web_immunity BEGIN
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "157"                                                           // param2: web opcode
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "129"                                                           // param2: web icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      PATCH_FOR_EACH ~spell~ IN                                                        // grant immunity to each of the following spells
                   ~SPDR201~                                                           // Web (druid version)
                   ~SPIN566~                                                           // Mimic Web
                   ~SPIN575~                                                           // Vortex web
                   ~SPIN683~                                                           // Web Tangle
                   ~SPWI215~                                                           // Web (wizard version)
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "157"                                                           // param2: web opcode
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "129"                                                           // param2: web icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      PATCH_FOR_EACH ~spell~ IN                                                        // grant immunity to each of the following spells
                   ~SPDR201~                                                           // Web (druid version)
                   ~SPIN566~                                                           // Mimic Web
                   ~SPIN683~                                                           // Web Tangle
                   ~SPWI215~                                                           // Web (wizard version)
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends DEFINE_PATCH_FUNCTION



// Entangle spell and ability immunities
DEFINE_PATCH_FUNCTION entangle_immunities BEGIN
    PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells
                ~SPPR105~                                                              // Entangle (Priest)
                ~SPWM111~                                                              // Entangle (Wild Mage)
                ~SPIN688~                                                              // Plant Growth (Black Dragon)
                ~RR#SMENT~                                                             // Shambler Entangle (RR)
                ~RR#FENTG~                                                             // Hamadryad Entangle (aTweaks)
BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
END                                                                                    // ends DEFINE_PATCH_FUNCTION



// Insect spell immunities
DEFINE_PATCH_FUNCTION insect_spell_immunities BEGIN
    PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells
                 ~SPPR319~                                                             // Summon Insects
                 ~SPPR517~                                                             // Insect Plague
                 ~SPPR717~                                                             // Creeping Doom
                 ~SPIN689~                                                             // Summon Insects (Black Dragon)
                 ~DW#VBAT1~                                                            // Bat Cloud (SCSII)
                 ~DW#VBAT2~                                                            // Bat Cloud (SCSII)
BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    ~SPL~ BEGIN                                                                        // SPL file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_SPELL_EFFECT~                                         // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "2"                                                                 // target: 2 (pre-target)
        "timing" = "0"                                                                 // timing mode: 0 (duration)
        "duration" = "120"                                                             // duration
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "resist_dispel" = "3"                                                          // resist/dispel
        "power" = "3"                                                                  // power
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH SPL block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Extraplanar traits
DEFINE_PATCH_FUNCTION extraplanar_traits BEGIN
    PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells
                ~SPWI605~                                                              // Death Spell
BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
LAUNCH_PATCH_FUNCTION cure_spell_immunities END                                        // all extraplanar creatures are immune to cure/cause wound spells
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Hover (flight) spell immunities
DEFINE_PATCH_FUNCTION hover_immunities BEGIN
    PATCH_FOR_EACH ~spell~ IN                                                          // grant immunity to each of the following spells
                 ~SPIN561~                                                             // Fire Giant Lava Pit (FIRE_GIANT_LAVA)
                 ~SPIN819~                                                             // Lava Burst (LAVA_BURST)
                 ~SPIN994~                                                             // Acid Pools in Durlag's Tower (ACID_DAMAGE_1)
                 ~SPWI022~                                                             // Lava Pit (TRAP_MUCK)
                 ~SPIN914~                                                             // Mimic Glue
                ~SPOGRE01~                                                             // Earthquake (Ogremoch)
                 ~SPPR720~                                                             // Earthquake (Priest version)
                 ~rr#equa~                                                             // Earthquake (aTweaks)
                 ~SPWI101~                                                             // Grease
BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
LAUNCH_PATCH_FUNCTION entangle_immunities END                                          // all hovering creatures are immune to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                                 // all hovering creatures are immune to web spells and effects
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Fire Slamander immunities (these apply for the noble variety too, but not for Frost Salamanders)
DEFINE_PATCH_FUNCTION fire_salamander_immunities BEGIN
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      PATCH_FOR_EACH ~effect~ IN                                                       // grant immunity to each of the following effects
                          ~5~                                                          // Charm
                         ~39~                                                          // Unconsciousness
                        ~109~                                                          // Hold Creature I
                        ~175~                                                          // Hold Creature II
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%effect%"                                      // param2: effect
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~icon~ IN                                                         // grant protection from each of the following icons
                        ~0~                                                            // Charm
                        ~1~                                                            // Dire Charm
                       ~13~                                                            // Held
                       ~14~                                                            // Sleep
                       ~43~                                                            // Domination
                      ~130~                                                            // Unconsciousness
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%icon%"                                        // param2: icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~string~ IN                                                       // prevent displaying each of the following text strings
                        ~8364~                                                         // Dominated
                        ~14001~                                                        // Sleep
                        ~14102~                                                        // Held
                        ~14672~                                                        // Charmed
                        ~14780~                                                        // Dire Charmed
                        ~20438~                                                        // Unconscious
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~animation~ IN                                                    // prevent displaying each of the following animations
                      ~SPNWCHRM~                                                       // Charmed
                      ~SPFLAYER~                                                       // Held (Mind Flayer)
                      ~SPMINDAT~                                                       // Held
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "296"                                                               // effect: #296 (Protection from Specific Animation)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%animation%"                                    // resref: animation
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~spell~ IN                                                        // grant immunity to each of the following spells
                   ~SPPR208~                                                           // Hold Person (priest version)
                   ~SPWI306~                                                           // Hold Person (wizard version)
                   ~SPWI507~                                                           // Hold Monster
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      PATCH_FOR_EACH ~effect~ IN                                                       // grant immunity to each of the following effects
                          ~5~                                                          // Charm
                         ~39~                                                          // Unconsciousness
                        ~109~                                                          // Hold Creature I
                        ~175~                                                          // Hold Creature II
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%effect%"                                      // param2: effect
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~icon~ IN                                                         // grant protection from each of the following icons
                        ~0~                                                            // Charm
                        ~1~                                                            // Dire Charm
                       ~13~                                                            // Held
                       ~14~                                                            // Sleep
                       ~43~                                                            // Domination
                      ~130~                                                            // Unconsciousness
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%icon%"                                        // param2: icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~string~ IN                                                       // prevent displaying each of the following text strings
                        ~8364~                                                         // Dominated
                        ~14001~                                                        // Sleep
                        ~14102~                                                        // Held
                        ~14672~                                                        // Charmed
                        ~14780~                                                        // Dire Charmed
                        ~20438~                                                        // Unconscious
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~animation~ IN                                                    // prevent displaying each of the following animations
                      ~SPNWCHRM~                                                       // Charmed
                      ~SPFLAYER~                                                       // Held (Mind Flayer)
                      ~SPMINDAT~                                                       // Held
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "296"                                                               // effect: #296 (Protection from Specific Animation)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%animation%"                                    // resref: animation
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~spell~ IN                                                        // grant immunity to each of the following spells
                   ~SPPR208~                                                           // Hold Person (priest version)
                   ~SPWI306~                                                           // Hold Person (wizard version)
                   ~SPWI507~                                                           // Hold Monster
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Air Affinity

DEFINE_PATCH_FUNCTION air_affinity BEGIN
  DEFINE_ASSOCIATIVE_ARRAY flyers BEGIN
    118 => 4  // Wyvern
    123 => 4  // Beholder
    136 => 4  // Mist
    139 => 4  // Mephit
    146 => 4  // Dragon
    147 => 4  // Genie
    156 => 4  // Solar
    157 => 4  // Antisolar
    158 => 4  // Planatar
    159 => 4  // Darkplanatar
    186 => 5  // Elemental_Air
  END
  PATCH_PHP_EACH flyers AS p1 => p2 BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "179"                                                               // effect: #179 (Damage vs. Creature Type Modifier)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "parameter1" = EVALUATE_BUFFER "%p1%"                                          // param1: IDS Entry
        "parameter2" = EVALUATE_BUFFER "%p2%"                                          // param2: IDS File
        "parameter3" = "4"                                                             // param3: damage bonus
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "178"                                                               // effect: #178 (THAC0 vs. Creature Type Modifier)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "parameter1" = EVALUATE_BUFFER "%p1%"                                          // param1: IDS Entry
        "parameter2" = EVALUATE_BUFFER "%p2%"                                          // param2: IDS File
        "parameter3" = "1"                                                             // param3: THAC0 bonus
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
  END                                                                                  // ends PATCH_PHP_EACH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Earth Affinity

DEFINE_PATCH_FUNCTION earth_affinity BEGIN
      PATCH_FOR_EACH ~spell~ IN                                                        // grant immunity to each of the following spells
                  ~SPOGRE01~                                                           // Earthquake (Ogremoch)
                   ~SPPR720~                                                           // Earthquake (Priest version)
                   ~rr#equa~                                                           // Earthquake (aTweaks)
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
  DEFINE_ASSOCIATIVE_ARRAY air_and_water BEGIN
    118 => 4  // Wyvern
    123 => 4  // Beholder
    131 => 4  // Sahuagin
    135 => 4  // Kuo-Toa
    136 => 4  // Mist
    139 => 4  // Mephit
    146 => 4  // Dragon
    147 => 4  // Genie
    156 => 4  // Solar
    157 => 4  // Antisolar
    158 => 4  // Planatar
    159 => 4  // Darkplanatar
    186 => 5  // Elemental_Air
    132 => 5  // Fairy_Nereid
  END
  PATCH_PHP_EACH air_and_water AS p1 => p2 BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "179"                                                               // effect: #179 (Damage vs. Creature Type Modifier)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "parameter1" = EVALUATE_BUFFER "%p1%"                                          // param1: IDS Entry
        "parameter2" = EVALUATE_BUFFER "%p2%"                                          // param2: IDS File
        "parameter3" = "-2"                                                            // param3: damage bonus
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "178"                                                               // effect: #178 (THAC0 vs. Creature Type Modifier)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "parameter1" = EVALUATE_BUFFER "%p1%"                                          // param1: IDS Entry
        "parameter2" = EVALUATE_BUFFER "%p2%"                                          // param2: IDS File
        "parameter3" = "-2"                                                            // param3: THAC0 bonus
        "duration" = "0"                                                               // duration: 0
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
  END                                                                                  // ends PATCH_PHP_EACH
  READ_BYTE 0x234 "level" ELSE 0                                                       // note: this was added to fix the broken param3 values (WeiDU bug?)
  READ_LONG 0x2c4 "fx_off" ELSE 0
  READ_LONG 0x2c8 "fx_num" ELSE 0
  FOR (index = 0 ; index < fx_num ; index = index + 1) BEGIN
    READ_LONG ("%fx_off%" + 0x08 + ("%index%" * 0x108)) "opcode"
    READ_LONG ("%fx_off%" + 0x58 + ("%index%" * 0x108)) "param3"
    PATCH_IF ((("%opcode%" = 178) OR ("%opcode%" = 179)) AND ("%param3%" != "-2")) BEGIN
      WRITE_LONG ("%fx_off%" + 0x58 + ("%index%" * 0x108)) "-2"
    END
  END
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Petrification immunity
DEFINE_PATCH_FUNCTION petrification_immunity BEGIN
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "134"                                                           // param2: petrification opcode
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "14665"                                                         // param1: strref (Petrified)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "134"                                                           // param2: petrification opcode
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = "14665"                                                         // param1: strref (Petrified)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Clear BG1 weapon proficiencies
DEFINE_PATCH_FUNCTION clear_bg1_profs BEGIN
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
   ~CRE~ BEGIN                                                                         // CRE file parsed
     PATCH_FOR_EACH ~bg1_prof~ IN ~0x6e~ ~0x6f~ ~0x70~ ~0x71~ ~0x72~ ~0x73~ ~0x74~ ~0x75~ BEGIN     // for all BG1 proficiency slots
       WRITE_BYTE %bg1_prof% 0                                                         // null proficiency
     END
  END                                                                                  // ends WITH CRE block
  DEFAULT                                                                              // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Missile weapon immunity
DEFINE_PATCH_FUNCTION missile_weapon_immunity BEGIN
    PATCH_FOR_EACH ~missile~ IN                                                        // grant immunity to each of the following missile weapons
                        ~1~                                                            // Arrow of Slaying
                        ~2~                                                            // Exploding Arrow
                        ~3~                                                            // Acid Arrow
                        ~4~                                                            // Arrow/Arrow +1
                        ~6~                                                            // Throwing Axe
                        ~7~                                                            // Throwing Axe
                        ~8~                                                            // Bolt
                        ~9~                                                            // Throwing Axe
                       ~10~                                                            // Throwing Axe
                       ~11~                                                            // Bolt+1, Bolt of Biting/Polymorph
                       ~12~                                                            // Exploding Bolt
                       ~13~                                                            // Bolt (?)
                       ~14~                                                            // Bolt
                       ~15~                                                            // Bolt of Lightning
                       ~16~                                                            // Bullet
                       ~17~                                                            // Bullet +1, Sunstone Bullet
                       ~18~                                                            // Bullet
                       ~19~                                                            // Bullet
                       ~26~                                                            // Throwing Dagger
                       ~27~                                                            // Throwing Dagger (?)
                       ~28~                                                            // Throwing Dagger (?)
                       ~29~                                                            // Fire Tooth +3
                       ~30~                                                            // Throwing Dagger (?)
                       ~31~                                                            // Asp's Nest, Dart of Stunning...
                       ~32~                                                            // Dart
                       ~33~                                                            // Dart (?)
                       ~34~                                                            // Dart (?)
                       ~35~                                                            // Dart (?)
                       ~55~                                                            // Spear
                       ~56~                                                            // Spear
                       ~57~                                                            // Spear
                       ~58~                                                            // Spear
                       ~59~                                                            // Spear
                      ~102~                                                            // Flame Arrow Blue
                      ~232~                                                            // Energy Spear (Gesen's Bow)
BEGIN                                                                                  // execute the following
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "83"                                                                // effect: #83 (Protection From Projectile)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVAL "%missile%"                                                // param2: the current missile
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "83"                                                                // effect: #83 (Protection From Projectile)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVAL "%missile%"                                                // param2: the current missile
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH ITM block
    ~SPL~ BEGIN                                                                        // SPL file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_SPELL_EFFECT~                                         // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "83"                                                                // effect: #83 (Protection From Projectile)
        "target" = "2"                                                                 // target: 2 (pre-target)
        "timing" = "0"                                                                 // timing mode: 0 (duration)
        "duration" = "120"                                                             // duration
        "parameter2" = EVAL "%missile%"                                                // param2: the current missile
        "resist_dispel" = "3"                                                          // resist/dispel
        "power" = "3"                                                                  // power
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
    END                                                                                // ends WITH SPL block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends PATCH_FOR_EACH
END                                                                                    // ends DEFINE_PATCH_FUNCTION


// Sleep immunity
DEFINE_PATCH_FUNCTION sleep_immunity BEGIN
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "39"                                                            // param2: opcode #39 (Unconsciousness)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      PATCH_FOR_EACH ~icon~ IN                                                         // grant protection from each of the following icons
                       ~14~                                                            // Sleep
                      ~130~                                                            // Unconsciousness
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%icon%"                                        // param2: icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~string~ IN                                                       // prevent displaying each of the following text strings
                        ~14001~                                                        // Sleep
                        ~20438~                                                        // Unconscious
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = "39"                                                            // param2: opcode #39 (Unconsciousness)
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      PATCH_FOR_EACH ~icon~ IN                                                         // grant protection from each of the following icons
                       ~14~                                                            // Sleep
                      ~130~                                                            // Unconsciousness
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%icon%"                                        // param2: icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~string~ IN                                                       // prevent displaying each of the following text strings
                        ~14001~                                                        // Sleep
                        ~20438~                                                        // Unconscious
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends DEFINE_PATCH_FUNCTION

// Hold immunity
DEFINE_PATCH_FUNCTION hold_immunity BEGIN
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      PATCH_FOR_EACH ~effect~ IN                                                       // grant immunity to each of the following effects
                        ~109~                                                          // Hold Creature I
                        ~175~                                                          // Hold Creature II
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%effect%"                                      // param2: effect
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~icon~ IN                                                         // grant protection from each of the following icons
                       ~13~                                                            // Held
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%icon%"                                        // param2: icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~string~ IN                                                       // prevent displaying each of the following text strings
                        ~14102~                                                        // Held
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      PATCH_FOR_EACH ~effect~ IN                                                       // grant immunity to each of the following effects
                        ~109~                                                          // Hold Creature I
                        ~175~                                                          // Hold Creature II
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%effect%"                                      // param2: effect
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~icon~ IN                                                         // grant protection from each of the following icons
                       ~13~                                                            // Held
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%icon%"                                        // param2: icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~string~ IN                                                       // prevent displaying each of the following text strings
                        ~14102~                                                        // Held
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends DEFINE_PATCH_FUNCTION

// Stun immunity
DEFINE_PATCH_FUNCTION stun_immunity BEGIN
READ_ASCII 0 sig (3)
  PATCH_MATCH "%sig%" WITH
      ~CRE~ BEGIN                                                                      // CRE file parsed
      PATCH_FOR_EACH ~effect~ IN                                                       // grant immunity to each of the following effects
                         ~45~                                                          // Stun
                        ~210~                                                          // Stun 90 HP
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%effect%"                                      // param2: effect
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~icon~ IN                                                         // grant protection from each of the following icons
                       ~55~                                                            // Stun
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%icon%"                                        // param2: icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~string~ IN                                                       // prevent displaying each of the following text strings
                         ~1280~                                                        // Stunned
                        ~14043~                                                        // Stun
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                           // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "9"                                                                 // timing mode: 9 (permanent after death)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH CRE block
    ~ITM~ BEGIN                                                                        // ITM file parsed
      PATCH_FOR_EACH ~effect~ IN                                                       // grant immunity to each of the following effects
                         ~45~                                                          // Stun
                        ~210~                                                          // Stun 90 HP
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "101"                                                               // effect: #101 (Protection from Opcode)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%effect%"                                      // param2: effect
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~icon~ IN                                                         // grant protection from each of the following icons
                       ~55~                                                            // Stun
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "169"                                                               // effect: #169 (Immunity Special Effect Icon)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter2" = EVALUATE_BUFFER "%icon%"                                        // param2: icon
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
      PATCH_FOR_EACH ~string~ IN                                                       // prevent displaying each of the following text strings
                         ~1280~                                                        // Stunned
                        ~14043~                                                        // Stun
      BEGIN
      LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
      INT_VAR                                                                          // initialize variables
        "opcode" = "267"                                                               // effect: #267 (Protection from Display Specific String)
        "target" = "1"                                                                 // target: 1 (self)
        "timing" = "2"                                                                 // timing mode: 2 (while equipped)
        "duration" = "0"                                                               // duration: 0
        "parameter1" = EVALUATE_BUFFER "%string%"                                      // param1: string reference
        "sectype" = "0"                                                                // secondary type: none
        "probability1" = "100"                                                         // probability1: 100%
      STR_VAR                                                                          // initialize strings
        "resource"  = ""                                                               // resref: none
        "effsource" = ""                                                               // effsource: none
      END                                                                              // ends LAUNCH_PATCH_FUNCTION
      END                                                                              // ends PATCH_FOR_EACH
    END                                                                                // ends WITH ITM block
    DEFAULT                                                                            // do nothing
END                                                                                    // ends PATCH_MATCH
END                                                                                    // ends DEFINE_PATCH_FUNCTION

DEFINE_PATCH_FUNCTION add_skeletal_traits BEGIN
  READ_ASCII 0 sig (3)
  PATCH_IF "%sig%" STRING_EQUAL_CASE CRE AND SOURCE_SIZE > 0x2d3 BEGIN
    WRITE_BYTE 0x5a 100 //Cold
    WRITE_BYTE 0x5f 100 //Magic cold
    WRITE_BYTE 0x60 50  //Slashing
    WRITE_BYTE 0x62 50  //Piercinc
    WRITE_BYTE 0x63 50  //Missile
    LPF cold_spell_immunities END
  END ELSE BEGIN
    PATCH_FAIL ~Incorrect file type or below minimum size~
  END
END

DEFINE_PATCH_FUNCTION unturnable BEGIN
  LPF ADD_CRE_EFFECT
    INT_VAR
       opcode = 297 //Immunity to Turn Undead
       target = 1
       timing = 9
       paramater2 = 1
  END
END

DEFINE_PATCH_FUNCTION illusion_immunity BEGIN
  READ_ASCII 0 sig (3)
  PATCH_FOR_EACH spell IN
                  sppr704 //Nature's beauty
                  spwi106 //Blindness
                  spwi125 //Spook
                  spwi223 //Deafness
                  spwm178 //Blindness (Wild mage)
  BEGIN
    PATCH_MATCH sig
    WITH
      CRE
      BEGIN
        LPF ADD_CRE_EFFECT
          INT_VAR
            opcode = 206
            target = 1
            parameter1 = 4742 //Spell Ineffective
            timing = 9
          STR_VAR
            resource = EVAL "%spell%"
        END
      END
      ITM
      BEGIN
        LPF ADD_ITEM_EQEFFECT
          INT_VAR
            opcode = 206
            target = 1
            parameter1 = 4742 //Spell Ineffective
            timing = 2
          STR_VAR
            resource = EVAL "%spell%"
        END
      END
      DEFAULT
    END
  END
END

//Set enchantment, and account for detectable enchantment from DS
DEFINE_PATCH_FUNCTION set_enchantment INT_VAR enchantment = 1 BEGIN
  READ_ASCII 0 sig (3)
  PATCH_IF "%sig%" STRING_EQUAL ITM BEGIN
    WRITE_LONG 0x60 enchantment
    READ_LONG 0x6a eo
    done = 0
    FOR (i = 0; i < SHORT_AT 0x70; ++i) BEGIN
      READ_SHORT eo + 0x30 * i       type
      READ_LONG  eo + 0x30 * i + 0x8 prof
      PATCH_IF type = 233 AND prof = 109 BEGIN
        WRITE_LONG eo + 0x30 * i + 0x4 enchantment
        done = 1
      END
    END
    PATCH_IF !done BEGIN
      LPF ADD_ITEM_EQEFFECT
        INT_VAR
          opcode = 233
          target = 1
          parameter1 = enchantment
          parameter2 = 109
          timing = 2
      END
    END
  END
END

//Will increase the priority of a single script matching the regexp script to the first empty script slot.
//Script slots with scripts matching the regexp kill will be treated as empty.
DEFINE_PATCH_FUNCTION promote_script STR_VAR script = "^$" kill = "^$" BEGIN
  READ_ASCII 0 sig (3)
  PATCH_IF "%sig%" STRING_EQUAL_CASE CRE AND SOURCE_SIZE > 0x2d3 BEGIN
    FOR (o = 0x248; o < 0x270; o += 0x8) BEGIN
      READ_ASCII o s1
      PATCH_IF "%s1%" STRING_MATCHES_REGEXP "%script%" = 0 BEGIN
        FOR (p = 0x248; p < 0x270 AND p < o; p += 0x8) BEGIN
          READ_ASCII p s2
          PATCH_IF "%s2%" STRING_EQUAL "" OR "%s2%" STRING_EQUAL_CASE none OR "%s2%" STRING_MATCHES_REGEXP "%kill%" = 0 BEGIN
            WRITE_ASCII  o "" #8
            WRITE_ASCIIE p "%s1%" #8
            p = SOURCE_SIZE
            o = SOURCE_SIZE
          END
        END
      END
    END
  END ELSE PATCH_FAIL "promote_script: incorrect signature or below minimum file size (%SOURCE_FILE%)"
END

DEFINE_PATCH_FUNCTION make_summon STR_VAR slot = boots BEGIN
  READ_ASCII 0 sig (3)
  PATCH_IF "%sig%" STRING_EQUAL CRE AND SOURCE_SIZE > 0x2d3 BEGIN
    WRITE_BYTE 0x10 (THIS BOR BIT1) BAND 0xfb                        //Set 'No corpse' (BIT1) and unset 'Permanent Corpse' (BIT2)
    ADD_CRE_ITEM rr#dinv #0 #0 #0 "unstealable&undroppable" "%slot%" //item for keeping summons from being killed before the summoning is done
    ADD_MEMORIZED_SPELL rr#usumn #0 innate (1)                       //'Unsummon' spell
  END ELSE PATCH_FAIL "make_summon: incorrect signature or below minimum file size (%SOURCE_FILE%)"
END

/*
 * Basically, with their vanilla scripts, Davaeorn and Andris can
 * act buggy with the IWD/PnP Dimension Door spell, so we keep them
 * on the old spell.
 */
DEFINE_ACTION_FUNCTION handle_old_dd BEGIN
  ACTION_IF !FILE_EXISTS_IN_GAME fl#ddold.spl AND
            !FILE_EXISTS_IN_GAME dw#mage.mrk AND
            GAME_IS ~tutu tutu_totsc bgt bgee eet~

  BEGIN
    COPY_EXISTING spwi402.spl "override/fl#ddold.spl"

    ACTION_FOR_EACH script IN "%TUTU_VAR%andris"
                              "davaeorn"
                              "_avaeorn"
    BEGIN
      ACTION_IF FILE_EXISTS_IN_GAME "%script%.bcs" BEGIN
        COPY_EXISTING "%script%.bcs" override
          DECOMPILE_AND_PATCH BEGIN
            REPLACE_TEXTUALLY
              ~ForceSpellPoint(\(.+\),WIZARD_DIMENSION_DOOR)~
              ~ForceSpellPointRES("fl#ddold",\1)~
            REPLACE_TEXTUALLY
              ~SpellNoDec(\(.+\),WIZARD_DIMENSION_DOOR)~
              ~SpellNoDecRES("fl#ddold",\1)~
          END
        BUT_ONLY
        UNLESS "fl#ddold"
      END
    END
  END
END

DEFINE_ACTION_FUNCTION make_dimension_door
  STR_VAR
    graphic = ""
    sound = ""
BEGIN
  ACTION_FOR_EACH spell IN spwi402 spwi450 BEGIN
    ACTION_IF FILE_EXISTS_IN_GAME "%spell%.spl" BEGIN
      COPY "atweaks/spl/spwi402.spl" "override/%spell%.spl"
        FOR (off = LONG_AT 0x6a; off < BUFFER_LENGTH; off += 0x30) BEGIN
          READ_SHORT off opcode
          PATCH_IF opcode = 215 BEGIN // play animation
            WRITE_ASCIIE off + 0x14 "%graphic%" #8 // resref
            WRITE_LONG off + 0x8 0 //p2: play over target, unattached
          END
          PATCH_IF opcode = 174 BEGIN // play sound
            WRITE_ASCIIE off + 0x14 "%sound%" #8 // resref
          END
        END
      BUT_ONLY
    END
  END
END

DEFINE_PATCH_FUNCTION dd_animation
  INT_VAR
    off = "-1"
    opcode = 999
    p2 = "-1"
  STR_VAR
    rr = ""
    graphic = ""
BEGIN
  PATCH_IF opcode = 141 AND p2 = 38 BEGIN // lighting effect: dimension door
    WRITE_SHORT  off        215 // play animation
    WRITE_LONG   off + 0x8  0 // p2: play over target, unattached
    WRITE_BYTE   off + 0xc  0 // timing
    WRITE_LONG   off + 0xe  1 // duration
    WRITE_ASCIIE off + 0x14 "%graphic%" #8 // resref
  END
END

DEFINE_PATCH_FUNCTION dd_sound
  INT_VAR
    off = "-1"
    opcode = 999
  STR_VAR
    rr = ""
    sound = ""
BEGIN
  PATCH_IF opcode = 174 AND "%rr%" STRING_EQUAL_CASE EFF_M09 BEGIN // play sound
    WRITE_LONG   off + 0xe  1 // duration
    WRITE_ASCIIE off + 0x14 "%sound%" #8 // resref
  END
END

DEFINE_ACTION_FUNCTION make_shadow_door
  STR_VAR
    graphic = ""
    sound = ""
BEGIN
  COPY_EXISTING spwi505.spl override
    FOR (off = LONG_AT 0x6a; off < BUFFER_LENGTH; off += 0x30) BEGIN
      READ_SHORT off        opcode
      READ_LONG  off + 0x8  p2
      READ_ASCII off + 0x14 rr
      LPF dd_animation INT_VAR off opcode p2 STR_VAR rr graphic END
      LPF dd_sound INT_VAR off opcode STR_VAR rr sound END
    END
  BUT_ONLY
END

DEFINE_ACTION_FUNCTION make_dryad_teleport
  STR_VAR
    graphic = ""
    sound = ""
BEGIN
  COPY_EXISTING spwi995.spl override
    FOR (off = LONG_AT 0x6a; off < BUFFER_LENGTH; off += 0x30) BEGIN
      READ_SHORT off opcode
      READ_LONG  off + 0x8 p2
      LPF dd_animation INT_VAR off opcode p2 STR_VAR rr graphic END
      LPF dd_sound INT_VAR off opcode STR_VAR rr sound END
      PATCH_IF opcode = 68 BEGIN // unsummon
        // Dryad Teleport can't be instant; it breaks cutscenes.
        WRITE_BYTE  off + 0xc  4 // timing
        WRITE_LONG  off + 0xe  1 // duration
      END
    END
  BUT_ONLY
END

DEFINE_PATCH_FUNCTION fiend_summoning_spell
  INT_VAR
    duration = 120
  STR_VAR
    lawful = rr#scorn
    lcneutral = fl#sarca
    chaotic = spcaco
BEGIN
  LPF DELETE_SPELL_EFFECT INT_VAR opcode_to_delete = 177 END
  SET $p1("%lawful%") = 16 // MASK_LAWFUL
  SET $p1("%lcneutral%") = 32 // MASK_LCNEUTRAL
  SET $p1("%chaotic%") = 48 // MASK_CHAOTIC
  PATCH_FOR_EACH resource IN "%lawful%" "%lcneutral%" "%chaotic%" BEGIN
    LPF ADD_SPELL_EFFECT
      INT_VAR
        opcode = 177
        target = 1
        parameter1 = $p1("%resource%")
        parameter2 = 8
        resist_dispel = 2
        duration
      STR_VAR
        resource
    END
  END
END

DEFINE_PATCH_FUNCTION minimum_proficiency
  INT_VAR
    value = 1
    proficiency = 0
BEGIN
  PATCH_IF value >= 0 AND proficiency >= 0 BEGIN
    coveredp = 0
    GET_OFFSET_ARRAY effect_array 0x2c4 4 0x2c8 4 0 0 0x108
    PHP_EACH effect_array AS i => off BEGIN
      READ_LONG off + 0x08 opcode
      READ_LONG off + 0x14 stars
      READ_LONG off + 0x18 prof
      PATCH_IF opcode = 233 AND prof = proficiency AND stars >= value BEGIN
        coveredp = 1
      END
    END
    PATCH_IF !coveredp BEGIN
      SET_BG2_PROFICIENCY proficiency value
    END
  END ELSE BEGIN
    PATCH_WARN "WARNING: minimum_proficiency received illegal arguments: value = %value%, proficiency = %proficiency%"
  END
END

//Load UTF8-encoded tra files if the game is BGEE
DEFINE_ACTION_MACRO bgee_language BEGIN
  ACTION_IF GAME_IS ~bgee bg2ee iwdee eet~ BEGIN
    LOAD_TRA ~atweaks/tra/bgee/english/game.tra~
    LOAD_TRA ~atweaks/tra/bgee/%LANGUAGE%/game.tra~
  END
END
