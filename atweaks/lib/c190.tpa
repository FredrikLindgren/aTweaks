///////////////////
// PnP Elementals
///////////////////


INCLUDE "atweaks/lib/tactical_shared.tpa"

//////////////
// New spells
//////////////

ACTION_IF NOT FILE_EXISTS_IN_GAME ~RR#DDOOR.BAM~ THEN BEGIN                        // Checks for the Icewind Dale's Dimension Door animation component
  COPY    ~aTweaks/BAM/SPDIMNDR.BAM~   ~override/RR#DDOOR.BAM~                     // IWD1's Dimension Door animation (custom file name)
  COPY    ~aTweaks/WAV/EFF_M09.WAV~    ~override/RR#DDOOR.WAV~                     // IWD1's Dimension Door sound effect (custom file name)
  COPY    ~aTweaks/VVC/RR#DDOOR.VVC~   ~override~                                  // Custom Dimension Door VVC
END                                                                                // ends ACTION_IF block
COPY ~atweaks/spl/rr#telwe.spl~ ~override/rr#telwr.spl~                            // Teleport Without Error (renewable)
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#renew" = "1" END     // Execute the "spell to innate ablity" function

COPY ~atweaks/spl/rr#niinv.spl~ ~override~                                         // Natural Invisibility
  SAY NAME1 @2100 SAY NAME2 @2100

COPY ~atweaks/spl/elementals/rr#emcbt.spl~ ~override~                              // New Mental Combat spell (used for arcane spellcasters when summoning elementals)
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN // cycle through abilities
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
        PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 54333)) BEGIN // display string
          SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @2131  // Locked in mental combat
        END
    END
  END

COPY ~atweaks/spl/rr#uchrm.spl~ ~override~                                         // Remove Enchantment Spell School (uncharm)

COPY ~atweaks/spl/elementals/rr#track.spl~ ~override~                              // Tracking
COPY ~atweaks/spl/elementals/rr#ecfir.spl~ ~override~                              // Conjure Fire Elemental

COPY ~atweaks/spl/elementals/rr#endis.spl~ ~override~                              // Displacement (Nereid)
SAY NAME1 @2105 SAY NAME2 @2105

COPY ~atweaks/spl/elementals/rr#ecems.spl~ ~override~                              // Cold Aura (Frost Salamander)
COPY ~atweaks/spl/elementals/rr#eceic.spl~ ~override~                              // Cold Aura (Ice Paraelemental and Cryonax)

COPY ~atweaks/eff/elementals/rr#enlfr.eff~ ~override~                              // Lower Fire Resistance immunity EFF (for Fire Elementals, Fire Salamanders, Efreet etc.)
COPY ~atweaks/spl/elementals/rr#enlfr.spl~ ~override~                              // Lower Fire Resistance
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN // cycle through abilities
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
        PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 14790)) BEGIN // display string
          SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @2102  // Fire Resistance Lowered
        END
    END
  END

COPY ~atweaks/vvc/rr#cnstr.vvc~ ~override~                                         // Constrict/Grab/Flaming Whip ability VVC animation
COPY ~atweaks/bam/rr#cnstr.bam~ ~override~                                         // Constrict/Grab/Flaming Whip ability BAM graphics
COPY ~atweaks/spl/rr#cnstr.spl~ ~override/rr#dgrab.spl~                            // Grab ability (Glabrezu)
SAY NAME1 @684 SAY NAME2 @684                                                    
  LPF DELETE_SPELL_EFFECT INT_VAR opcode_to_delete = 177 END
  LPF DELETE_SPELL_EFFECT INT_VAR opcode_to_delete = 12 END
  LPF DELETE_SPELL_EFFECT INT_VAR opcode_to_delete = 206 END
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 2 duration = 12 STR_VAR resource = rr#dgrab END
  insert_point = 0
  opcode = 177
  target = 2
  duration = 1
  SPRINT resource rr#dgrab
  parameter2 = 4 //race.ids
  PATCH_FOR_EACH parameter1 IN 119 121 122 123 132 133 134 136 142 143 144 146 BEGIN //slime, demonic, lycanthrope, beholder, shadow, spectre, wraith, mist, giant, orc, golem, dragon
    LPF ADD_SPELL_EFFECT INT_VAR insert_point opcode target parameter1 parameter2 duration STR_VAR resource END
  END
  parameter2 = 5 //class.ids
  PATCH_FOR_EACH parameter1 IN 120 121 125 BEGIN //gnoll, hobgoblin, ogre
    LPF ADD_SPELL_EFFECT INT_VAR insert_point opcode target parameter1 parameter1 duration STR_VAR resource END
  END

COPY ~atweaks/eff/rr#cnstr.eff~ ~override/rr#dgrab.eff~                            // Grab ability immunity (for large and incorporeal creatures)
  WRITE_ASCII 0x30 ~RR#DGRAB~ #8                                                   // resref: RR#DGRAB

COPY ~atweaks/eff/rr#cnstr.eff~ ~override/rr#dgra2.eff~
  WRITE_LONG  0x10 146 //cast spell
  WRITE_LONG  0x20 1 //cast instantly
  WRITE_LONG  0x24 1 //instant/permanent
  WRITE_ASCII 0x30 rr#dgrab #8

COPY ~atweaks/bam/rr#icew.bam~ ~override~                                          // Wall of Ice BAM
COPY ~atweaks/spl/rr#icew.spl~ ~override~                                          // Wall of Ice
  SAY NAME1 @1024 SAY NAME2 @1024
  READ_LONG  0x64 ab_off
  READ_SHORT 0x68 ab_num
  FOR(i=0; i<ab_num; i+=1) BEGIN
    WRITE_SHORT (ab_off+i*0x28+0x26) %rr#icew%                                     // use new projectile
  END

COPY ~atweaks/spl/elementals/rr#enbga.spl~ ~override~                              // Beguiling Aura (part 1)
  SAY NAME1 @2104 SAY NAME2 @2104
  READ_LONG  0x64 ab_off
  READ_SHORT 0x68 ab_num
  FOR(i=0; i<ab_num; i+=1) BEGIN
    WRITE_SHORT (ab_off+i*0x28+0x26) %rr#fcsng%                                    // use new projectile
  END


COPY ~atweaks/spl/elementals/rr#enbg2.spl~ ~override~                              // Beguiling Aura (part 2)
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN // cycle through abilities
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
        PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 1476)) BEGIN // display string
          SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @2106  // Fascinated
        END
    END
  END

COPY ~atweaks/eff/elementals/rr#enbga.eff~ ~override~                              // Beguiling Aura EFF 1 (for targeting only male characters)
COPY ~atweaks/eff/elementals/rr#enbg2.eff~ ~override~                              // Beguiling Aura EFF 2 (for elven and half-elven charm immunity)
  SAY 0x1C @1903                                                                   // Resists charm effect

// Add immunity to Beguiling Aura to items and spells which use blindness

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
                ~spdr101.spl~
                ~spin595.spl~
                ~spin878.spl~
                ~spin893.spl~
                ~spin929.spl~
                ~spin931.spl~
                ~sppr704.spl~
                ~sppr707.spl~
                ~spwi106.spl~
                ~spwi118.spl~
                ~spwi224.spl~
                ~spwi714.spl~
                ~spwi815.spl~
                ~spwi958.spl~
                ~spwm178.spl~
                ~chalcy2.itm~
                ~gorwom4.itm~
                 ~halb06.itm~
                   ~sorb.itm~
                 ~sw1h51.itm~
                 ~wand19.itm~
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%~ BEGIN                                       // if the designated file with a SPL extension exists
COPY_EXISTING ~%file%~ ~override~
  PATCH_IF (SOURCE_SIZE > 0x71) THEN BEGIN                                         // protects against invalid files
// =============================================================================== // the actual work starts from here
  LPF add_conditional_immunity INT_VAR f_Condition = 74 STR_VAR f_Spell = rr#enbg2 END
// =============================================================================== // the actual work ends here
END                                                                                // ends file size check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block

COPY ~aTweaks/VVC/RR#SKISS.VVC~ ~override~                                         // Kiss VVC animation
COPY ~aTweaks/BAM/RR#SKISS.BAM~ ~override~                                         // Kiss BAM graphics
COPY ~atweaks/bam/elementals/rr#enkis.bam~ ~override~                              // Drowning Kiss bam
COPY ~atweaks/spl/elementals/rr#enkis.spl~ ~override~                              // Drowning Kiss (Nereid)
  SAY NAME1 @2107 SAY NAME2 @2107

COPY ~atweaks/spl/elementals/rr#envsp.spl~ ~override~                              // Venom Spit (Nereid)
  SAY NAME1 @2108 SAY NAME2 @2108

COPY ~atweaks/spl/elementals/rr#ensww.spl~ ~override~                              // Summon Water Weird (Nereid)
  SAY NAME1 @2109 SAY NAME2 @2109
COPY ~atweaks/eff/elementals/rr#ensww.eff~ ~override~                              // Summon Water Weird EFF


COPY ~atweaks/spl/elementals/rr#envlp.spl~ ~override~                              // Envelop
  SAY NAME1 @2111 SAY NAME2 @2111
COPY ~atweaks/eff/elementals/rr#envlp.eff~ ~override~                              // Envelop immunity EFF (for large and incorporeal creatures)
COPY ~atweaks/bam/elementals/rr#envlp.bam~ ~override~                              // Envelop BAM animation
COPY ~atweaks/vvc/rr#envlp.vvc~ ~override~                                         // Envelop VVC animation

COPY ~atweaks/spl/elementals/rr#drown.spl~ ~override~                              // Drown
SAY NAME1 @2112 SAY NAME2 @2112

COPY ~atweaks/spl/elementals/rr#ewwde.spl~ ~override~                              // Dominate Elemental
SAY NAME1 @2113 SAY NAME2 @2113

COPY ~atweaks/spl/elementals/rr#ewwsl.spl~ ~override~                              // 1 round Slow (Water Weirds are slowed by cold damage)

COPY ~atweaks/bam/elementals/rr#eairw.bam~ ~override~                              // Whirlwind BAM icon
COPY ~atweaks/spl/elementals/rr#eairw.spl~ ~override~                              // Whirlwind (Air Elemental)

COPY ~atweaks/spl/elementals/rr#ecncl.spl~ ~override~                              // Elemental Concealment
SAY NAME1 @2123 SAY NAME2 @2123

COPY ~atweaks/spl/elementals/rr#equa.spl~ ~override~                               // Earthquake (note: this filename must be 7 characters or less)
  READ_LONG  0x64 ab_off
  READ_SHORT 0x68 ab_num
  FOR(i=0; i<ab_num; i+=1) BEGIN
    WRITE_SHORT (ab_off+i*0x28+0x26) %fl#sight%                                    // use new projectile
  END

COPY ~atweaks/eff/elementals/rr#eburn.eff~ ~override~                              // Burn immunity EFF (for noncombustible creatures)
COPY ~atweaks/spl/elementals/rr#eburn.spl~ ~override~                              // Burn (Fire Elemental on-hit effect)
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN // cycle through abilities
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
        PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 12074)) BEGIN // display string: "Burning Hands"
          SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @2124 // Burning
        END
    END
  END

COPY ~atweaks/eff/elementals/rr#efrzn.eff~ ~override~                              // Freeze immunity EFF
COPY ~atweaks/spl/elementals/rr#efrzn.spl~ ~override~                              // Freeze (Cryonax on-hit effect)


COPY ~atweaks/eff/elementals/rr#englf.eff~ ~override~                              // Engulf immunity EFF (for large, incorporeal and noncombustible creatures)
COPY ~atweaks/spl/elementals/rr#englf.spl~ ~override~                              // Engulf, part 1 (Greater Fire Elemental on-hit effect)
SAY NAME1 @2121 SAY NAME2 @2121
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN // cycle through abilities
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
        PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 334)) BEGIN // display string: "Entangled"
          SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @2125 // Engulfed in searing flames
        END
    END
  END
COPY ~atweaks/spl/elementals/rr#engl2.spl~ ~override~                              // Engulf, part 2 (fire damage)

COPY ~atweaks/eff/elementals/rr#ecry1.eff~ ~override~                              // Cryonax Summon Allies EFF 1 (Ice Paraelemental)
COPY ~atweaks/spl/elementals/rr#ecryo.spl~ ~override~                              // Summon Allies (Cryonax)
SAY NAME1 @2127 SAY NAME2 @2127

COPY ~atweaks/spl/elementals/rr#eimix.spl~ ~override~                              // Summon Allies (Imix)
SAY NAME1 @2127 SAY NAME2 @2127

COPY ~atweaks/spl/elementals/rr#eogre.spl~ ~override~                              // Summon Allies (Ogremoch)
SAY NAME1 @2127 SAY NAME2 @2127

COPY ~atweaks/eff/elementals/rr#ehyd1.eff~ ~override~                              // Olhydra Summon Allies EFF 1 (Water Elemental)
COPY ~atweaks/spl/elementals/rr#ehydr.spl~ ~override~                              // Summon Allies (Olhydra)
SAY NAME1 @2127 SAY NAME2 @2127

COPY ~atweaks/eff/elementals/rr#eyan1.eff~ ~override~                              // Yan-C-Bin and Chan Summon Allies EFF 1 (Air Elemental, non-arcane version)
COPY ~atweaks/spl/elementals/rr#eyanc.spl~ ~override~                              // Summon Allies (Yan-C-Bin)
SAY NAME1 @2127 SAY NAME2 @2127

COPY ~atweaks/spl/elementals/rr#echan.spl~ ~override~                              // Summon Allies (Chan)
SAY NAME1 @2127 SAY NAME2 @2127

COPY ~atweaks/spl/elementals/rr#esunn.spl~ ~override~                              // Summon Allies (Sunnis)
SAY NAME1 @2127 SAY NAME2 @2127

COPY ~atweaks/spl/elementals/rr#ezaam.spl~ ~override~                              // Summon Allies (Zaaman Rul)
SAY NAME1 @2127 SAY NAME2 @2127



COPY ~atweaks/spl/elementals/rr#eimfb.spl~ ~override~                              // Fireball, 20d6 (Imix)
COPY ~atweaks/spl/elementals/rr#eimhe.spl~ ~override~                              // Heat Emission, 1d20 (Imix)
COPY ~atweaks/spl/elementals/rr#eimfs.spl~ ~override~                              // Fire Shield: Red, triple strength, Part1 (Imix)
COPY ~atweaks/spl/elementals/rr#eimfd.spl~ ~override~                              // Fire Shield: Red, triple strength, Part2 (Imix)

COPY ~atweaks/spl/elementals/rr#ezafb.spl~ ~override~                              // Fireball, 12d6 (Zaaman Rul)
COPY ~atweaks/spl/elementals/rr#ezafa.spl~ ~override~                              // Flame Arrow, double damage (Zaaman Rul)
COPY ~atweaks/spl/elementals/rr#ezafs.spl~ ~override~                              // Fire Shield: Red, double strength, Part1 (Zaaman Rul)
COPY ~atweaks/spl/elementals/rr#ezafd.spl~ ~override~                              // Fire Shield: Red, double strength, Part2 (Zaaman Rul)

// Pyrotechnics

COPY ~atweaks/bam/rr#pyrot.bam~ ~override~                                         // Pyrotechnics BAM icon
COPY ~atweaks/spl/rr#pyrot.spl~ ~override~                                         // Pyrotechnics
  SAY NAME1 @747 SAY NAME2 @747
  READ_LONG  0x64 ab_off
  READ_SHORT 0x68 ab_num
  FOR(i=0; i<ab_num; i+=1) BEGIN
    WRITE_SHORT (ab_off+i*0x28+0x26) %rr#pyrot%                                    // use new projectile (party friendly)
  END 


// Wall of Fog

COPY ~atweaks/vvc/rr#mmswf.vvc~ ~override~                                         // Wall of Fog animation
COPY ~atweaks/spl/mephits/rr#mmswf.spl~ ~override~                                 // Wall of Fog
  SAY NAME1 @1855 SAY NAME2 @1855


// Solid Fog

COPY ~atweaks/vvc/rr#mmswf.vvc~ ~override~                                         // Fog VVC animation
COPY ~atweaks/spl/elementals/rr#echsf.spl~ ~override~                              // Solid Fog
  SAY NAME1 @2128 SAY NAME2 @2128


// Stun for 3 rounds (Yan-C-Bin on hit effect)

COPY ~atweaks/eff/elementals/rr#estun.eff~ ~override~                              // Stun immunity EFF (for undead, constructs etc.)
COPY ~atweaks/spl/elementals/rr#estun.spl~ ~override~                              // Stun (Yan-C-Bin on hit effect)


// Wind Wall

COPY ~atweaks/spl/elementals/rr#echww.spl~ ~override~                              // Wind Wall (Chan)
  SAY NAME1 @2209 SAY NAME2 @2209 SAY DESC @2210 SAY UNIDENTIFIED_DESC @2210
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN // cycle through abilities
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
        PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 2978)) BEGIN // display string: "Gas Cloud"
          SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @2130 // Protected from gas-based spells and attacks
        END
    END
  END
  FOR(i=0; i<abil_num; i+=1) BEGIN
    WRITE_SHORT (abil_off+i*0x28+0x26) %rr#vrpo%                                     // use new projectile
  END
LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 2 duration = 12 STR_VAR resource = rr#dgrab END
LPF cloud_spell_immunities END
LPF insect_spell_immunities END


// Gust of Wind

COPY ~atweaks/spl/mephits/rr#maigw.spl~ ~override~                                 // Gust of Wind
  SAY NAME1 @1850 SAY NAME2 @1850


// Know Alignment (custom version, to avoid compatibility issues with Spell Revisions)

COPY ~atweaks/spl/elementals/rr#ekal.spl~ ~override~                               // Know Alignment

// Iron Skins (Sunnis' version)

COPY ~atweaks/spl/elementals/rr#esuis.spl~ ~override~                              // Iron Skins


// Clone spells into innate abilities

COPY_EXISTING ~spwi103.spl~  ~override/rr#wi103.spl~                               // Clone Burning Hands into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" END     // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi213.spl~  ~override/rr#wi213.spl~                               // Clone Stinking Cloud into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" END     // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi302.spl~  ~override/rr#wr302.spl~                               // Clone Remove Magic into a renewable innate ability
LPF ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" "rr#renew" = "1" END      // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi303.spl~  ~override/rr#wi303.spl~                               // Clone Flame Arrow into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" END     // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi304.spl~  ~override/rr#wi304.spl~                               // Clone Fireball into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" END     // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi306.spl~  ~override/rr#wi306.spl~                               // Clone Hold Person into an innate ability (used by Pit Fiend)
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" END     // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi403.spl~  ~override/rr#wi403.spl~                               // Clone Fire Shield:Blue into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" END                      // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi404.spl~  ~override/rr#wi404.spl~                               // Clone Ice Storm into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" END     // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi404.spl~  ~override/rr#ehyis.spl~                               // Clone Ice Storm into an innate ability (Olhydra's version)
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" END     // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi408.spl~  ~override/rr#wi408.spl~                               // Clone Stoneskin into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" END                      // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi418.spl~  ~override/rr#wi418.spl~                               // Clone Fire Shield:Red into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" END                      // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi502.spl~  ~override/rr#wi502.spl~                               // Clone Cloudkill into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" END     // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi503.spl~  ~override/rr#wi503.spl~                               // Clone Cone of Cold into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" END     // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi604.spl~  ~override/rr#wi604.spl~                               // Clone Flesh to Stone into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" END     // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi625.spl~  ~override/rr#wi625.spl~                               // Clone Stone to Flesh into an innate ability
LAUNCH_PATCH_FUNCTION ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" END     // Execute the "spell to innate ablity" function

COPY_EXISTING ~spwi104.spl~  ~override/rr#ersug.spl~                               // Change Charm Person into renewable Suggestion
  SAY NAME1 @708 SAY NAME2 @708                                                    // Suggestion
LPF ~RR#SP2IN~ INT_VAR "rr#ctime" = "1" "rr#rinvs" = "1" "rr#renew" = "1" END      // Execute the "spell to innate ablity" function






//////////////
// New items
//////////////

COPY ~atweaks/itm/elementals/rr#etrai.itm~ ~override~                              // elemental traits "helmet" (shared by all Elementals, needs to be a helmet in order to grant critical hit protection)
LAUNCH_PATCH_FUNCTION ~extraplanar_traits~ END                                     // add extraplanar traits
LAUNCH_PATCH_FUNCTION ~bleeding_immunity~ END                                      // add bleeding immunity
LAUNCH_PATCH_FUNCTION ~disease_immunity~ END                                       // add disease immunity
LAUNCH_PATCH_FUNCTION ~poison_immunity~ END                                        // add poison immunity
LAUNCH_PATCH_FUNCTION ~poison_spell_immunities~ END                                // add immunity to poison-based spells
LAUNCH_PATCH_FUNCTION ~insect_spell_immunities~ END                                // add immunity to insect spells
LAUNCH_PATCH_FUNCTION ~hold_immunity~ END                                          // add hold immunity
LAUNCH_PATCH_FUNCTION ~stun_immunity~ END                                          // add stun immunity
LAUNCH_PATCH_FUNCTION ~sleep_immunity~ END                                         // add sleep immunity
PATCH_FOR_EACH ~spell~ IN                                                          // creatures without flesh shouldn't be affected by the Flesh to Stone spell
             ~SPWI604~                                                             // Flesh to Stone (wizard version)
             ~SPIN984~                                                             // Flesh to Stone (Beholder ray)
            ~RR#WI604~                                                             // Flesh to Stone (aTweaks)
BEGIN                                                                              // execute the following
  LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
  INT_VAR                                                                          // initialize variables
    "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
    "target" = "1"                                                                 // target: 1 (self)
    "timing" = "2"                                                                 // timing mode: 2 (while equipped)
    "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
    "duration" = "0"                                                               // duration: 0
    "sectype" = "0"                                                                // secondary type: none
    "probability1" = "100"                                                         // probability1: 100%
  STR_VAR                                                                          // initialize strings
    "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
    "effsource" = ""                                                               // effsource: none
  END                                                                              // ends LAUNCH_PATCH_FUNCTION
END                                                                                // ends PATCH_FOR_EACH
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING rr#etrai.itm ~override/fl#etrsu.itm~                                 // As RR#ETRAI, but lacking immunity to Death Spell (for use by summoned elementals)
  GET_OFFSET_ARRAY ea ITM_V10_GEN_EFFECTS
  PHP_EACH ea AS _ => off BEGIN
    READ_SHORT off opcode
    READ_ASCII off + 0x14 resref
    PATCH_IF opcode = 206 AND "%resref%" STRING_EQUAL_CASE "SPWI605" BEGIN
      WRITE_BYTE off + 0x12 0                                                       // null the probability
    END
  END
BUT_ONLY

COPY ~atweaks/itm/rr#dinv.itm~  ~override~                                         // item which makes creatures untargetable until the gating animation finishes
COPY ~atweaks/itm/elementals/rr#easer.itm~ ~override~                              // Aerial Servant attack
COPY ~atweaks/itm/elementals/rr#efsal.itm~ ~override~                              // Fire Salamander spear attack
COPY ~atweaks/itm/elementals/rr#efsa2.itm~ ~override~                              // Fire Salamander tail attack
COPY ~atweaks/itm/elementals/rr#efrsa.itm~ ~override~                              // Frost Salamander claw attack
COPY ~atweaks/itm/elementals/rr#efrs2.itm~ ~override~                              // Frost Salamander bite attack
COPY ~atweaks/itm/elementals/rr#eista.itm~ ~override~                              // Invisible Stalker attack
COPY ~atweaks/itm/elementals/rr#ensal.itm~ ~override~                              // Salamander Noble spear attack
COPY ~atweaks/itm/elementals/rr#ensa2.itm~ ~override~                              // Salamander Noble tail attack
COPY ~atweaks/itm/elementals/rr#ewwei.itm~ ~override~                              // Water Weird attack
COPY ~atweaks/itm/elementals/rr#eairl.itm~ ~override~                              // Lesser Air Elemental attack
COPY ~atweaks/itm/elementals/rr#eairr.itm~ ~override~                              // Air Elemental attack
COPY ~atweaks/itm/elementals/rr#eairg.itm~ ~override~                              // Greater Air Elemental attack
COPY ~atweaks/itm/elementals/rr#eaire.itm~ ~override~                              // Elder Air Elemental attack
COPY ~atweaks/itm/elementals/rr#eearl.itm~ ~override~                              // Lesser Earth Elemental attack
COPY ~atweaks/itm/elementals/rr#eearr.itm~ ~override~                              // Earth Elemental attack
COPY ~atweaks/itm/elementals/rr#eearg.itm~ ~override~                              // Greater Earth Elemental attack
COPY ~atweaks/itm/elementals/rr#eeare.itm~ ~override~                              // Elder Earth Elemental attack
COPY ~atweaks/itm/elementals/rr#efirl.itm~ ~override~                              // Lesser Fire Elemental attack
COPY ~atweaks/itm/elementals/rr#efirr.itm~ ~override~                              // Fire Elemental attack
COPY ~atweaks/itm/elementals/rr#efirg.itm~ ~override~                              // Greater Fire Elemental attack
COPY ~atweaks/itm/elementals/rr#efire.itm~ ~override~                              // Elder Fire Elemental attack
COPY ~atweaks/itm/elementals/rr#ewatl.itm~ ~override~                              // Lesser Water Elemental attack
COPY ~atweaks/itm/elementals/rr#ewatr.itm~ ~override~                              // Water Elemental attack
COPY ~atweaks/itm/elementals/rr#ewatg.itm~ ~override~                              // Greater Water Elemental attack
COPY ~atweaks/itm/elementals/rr#ewate.itm~ ~override~                              // Elder Water Elemental attack
COPY ~atweaks/itm/elementals/rr#eicer.itm~ ~override~                              // Ice Paraelemental attack
COPY ~atweaks/itm/elementals/rr#ecryo.itm~ ~override~                              // Cryonax attack
COPY ~atweaks/itm/elementals/rr#eimix.itm~ ~override~                              // Imix attack
COPY ~atweaks/itm/elementals/rr#eogre.itm~ ~override~                              // Ogremoch attack
COPY ~atweaks/itm/elementals/rr#ehydr.itm~ ~override~                              // Olhydra attack
COPY ~atweaks/itm/elementals/rr#eyanc.itm~ ~override~                              // Yan-C-Bin attack
COPY ~atweaks/itm/elementals/rr#echan.itm~ ~override~                              // Chan attack
COPY ~atweaks/itm/elementals/rr#esunn.itm~ ~override~                              // Sunnis attack
COPY ~atweaks/itm/elementals/rr#ezaam.itm~ ~override~                              // Zaaman Rul attack


// Special Spell Revisions compatibility block. Needs to go way up here so that the spell is backed up before aTweaks alters it

ACTION_IF MOD_IS_INSTALLED spell_rev.tp2 0 BEGIN
COPY_EXISTING ~sppr702.spl~  ~override/rr#srbk1.spl~                               // Backup SR's Summon Shambling Mound
END                                                                                // ends Spell Revisions compatibility block


// Ensure that the mental combat script is assigned to all elementals summoned by arcane spellcasters. Also, these elementals need to start out as NEUTRAL

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~elairsu1~                                                             // Air Elemental (mage summon)
            ~elairsu2~                                                             // Air Elemental (mage summon)
            ~elairsu3~                                                             // Air Elemental (mage summon)
            ~elairsuw~                                                             // Lesser Air Elemental (mage summon)
            ~elearsu1~                                                             // Earth Elemental (mage summon)
            ~elearsu2~                                                             // Earth Elemental (mage summon)
            ~elearsu3~                                                             // Earth Elemental (mage summon)
            ~elearsu4~                                                             // Earth Elemental (mage summon)
            ~elearsuw~                                                             // Lesser Earth Elemental (mage summon)
            ~elfirsu1~                                                             // Fire Elemental (mage summon)
            ~elfirsu2~                                                             // Fire Elemental (mage summon)
            ~elfirsu3~                                                             // Fire Elemental (mage summon)
            ~elfirsu4~                                                             // Fire Elemental (mage summon)
            ~elfirsuw~                                                             // Lesser Fire Elemental (mage summon)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
WRITE_ASCII 0x248 ~rr#ewizs~ #8                                                    // assign override AI script
WRITE_BYTE  0x270 128                                                              // set initial allegiance to NEUTRAL
ADD_CRE_ITEM ~RIDRING~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~RRING~                  // selection circle removal ring
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block




//////////////////////////
// Creature modifications
//////////////////////////


// Aerial Servant

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~servsu~                                                             // Aerial Servant
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~ INT_VAR opcode_to_delete = "101" END     // mark opcode #101 (Protection from Opcode) for deletion (remove spurious Maze immunity)
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EASER~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REMOVE_CRE_ITEM ~MAGE01~                                                           // initial invisibility is handled via weapon
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "18"                                                                  // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "9000"                                                                // new XP value
"newhp"    = "128"                                                                 // new hit point value
"newac"    = "7"                                                                   // new Armor Class value
"newth"    = "10"                                                                  // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "4"                                                                   // new Save vs. Death
"newsvw"   = "6"                                                                   // new Save vs. Wand
"newsvp"   = "5"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "7"                                                                   // new Save vs. Spell
"newlvl1"  = "16"                                                                  // new level (first class)
"newstr"   = "23"                                                                  // new Strength value
"newdex"   = "20"                                                                  // new Dexterity value
"newcon"   = "16"                                                                  // new Constitution value
"newint"   = "4"                                                                   // new Intelligence value
"newwis"   = "6"                                                                   // new Wisdom value
"newchr"   = "5"                                                                   // new Charisma value
"newmor"   = "14"                                                                  // new morale value
"newmorb"  = "3"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "186"                                                                 // new class (ELEMENTAL_AIR)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EASER"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "servsu"                                                            // Aerial Servant AI script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "dw#melee"                                                          // SCSII melee AI script
"script06"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script07"   = "DVMELEE"                                                           // Spell Revisions melee AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION hover_immunities END                                         // grant immunities to ground-based spells
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Fire Salamander

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
             ~hgsal01~                                                             // Fire Salamander
            ~icsalfir~                                                             // Fire Salamander (Planar Sphere)
             ~plysala~                                                             // Fire Salamander (Avenger kit shapechange)
            ~wrmons01~                                                             // Fire Salamander (Hell Wrath, possibly unused?)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY NAME1 #73254 SAY NAME2 #73255                                                  // Fire Salamander
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
REPLACE_CRE_ITEM ~RR#EFSAL~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REPLACE_CRE_ITEM ~RR#EFSA2~ #0 #0 #0 ~UNDROPPABLE~ ~SHIELD~ EQUIP                  // tail attack
REMOVE_CRE_ITEM ~RING95~                                                           // Salamanders are not undead, they have their own specific set of immunities
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "7"                                                                   // new movement rate
"newxpv"   = "2000"                                                                // new XP value
"newhp"    = "63"                                                                  // new hit point value
"newac"    = "3"                                                                   // new Armor Class value
"newth"    = "13"                                                                  // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"rr#ptwf"  = "1"                                                                   // perfect two weapon fighting (1 = enable)
"newsvd"   = "10"                                                                  // new Save vs. Death
"newsvw"   = "12"                                                                  // new Save vs. Wand
"newsvp"   = "11"                                                                  // new Save vs. Polymorph
"newsvb"   = "12"                                                                  // new Save vs. Breath
"newsvs"   = "13"                                                                  // new Save vs. Spell
"newfr"    = "100"                                                                 // new Resist Fire value
"newcr"    = "-50"                                                                 // new Resist Cold value
"newlvl1"  = "7"                                                                   // new level (first class)
"newstr"   = "16"                                                                  // new Strength value
"newdex"   = "12"                                                                  // new Dexterity value
"newcon"   = "14"                                                                  // new Constitution value
"newint"   = "14"                                                                  // new Intelligence value
"newwis"   = "13"                                                                  // new Wisdom value
"newchr"   = "13"                                                                  // new Charisma value
"newmor"   = "13"                                                                  // new morale value
"newmorb"  = "4"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "255"                                                                 // new general (MONSTER)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "187"                                                                 // new class (ELEMENTAL_FIRE)
"newalign" = "51"                                                                  // new alignment (Chaotic Evil)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EFSAL"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "GRPSHT01"                                                          // generic shout AI script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "GENSHT01"                                                          // generic shout AI script
"script06"   = "WDASIGHT"                                                          // generic AI script
"script07"   = "dw#melee"                                                          // SCSII melee AI script
"script08"   = "CRESHOUT"                                                          // Big Picture shout script
"script09"   = "BPWDASGT"                                                          // Big Picture generic AI script
"script10"   = "BERSERK"                                                           // Hell Salamander script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~extraplanar_traits~ END                                     // add extraplanar traits
LAUNCH_PATCH_FUNCTION fire_salamander_immunities END                               // grant fire salamander immunities
LAUNCH_PATCH_FUNCTION fire_spell_immunities END                                    // grant immunities to fire-based area effect spells
WRITE_ASCII 0x280 ~icsalfir~ #32                                                   // assign new death variable
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~plysala~) BEGIN                        // special case, the Avenger kit Fire Salamander form needs 2 APR since it can't dual-wield
  WRITE_BYTE 0x53 2                                                                // base number of attacks
END
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Frost Salamander

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~salgrice~                                                             // Frost Salamander
            ~icsalcol~                                                             // Ice Salamander (Planar Sphere)
            ~telicesa~                                                             // Ice Salamander (unused?)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY NAME1 #72145 SAY NAME2 #72146                                                  // Frost Salamander
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
REPLACE_CRE_ITEM ~RR#EFRSA~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REPLACE_CRE_ITEM ~RR#EFRS2~ #0 #0 #0 ~UNDROPPABLE~ ~SHIELD~ EQUIP                  // bite attack
REMOVE_CRE_ITEM ~RING95~                                                           // Salamanders are not undead, they have their own specific set of immunities
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "9"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "9000"                                                                // new XP value
"newhp"    = "96"                                                                  // new hit point value
"newac"    = "3"                                                                   // new Armor Class value
"newth"    = "9"                                                                   // new THAC0 value
"newapr"   = "4"                                                                   // new number of attacks per round
"rr#ptwf"  = "1"                                                                   // perfect two weapon fighting (1 = enable)
"newsvd"   = "7"                                                                   // new Save vs. Death
"newsvw"   = "9"                                                                   // new Save vs. Wand
"newsvp"   = "8"                                                                   // new Save vs. Polymorph
"newsvb"   = "8"                                                                   // new Save vs. Breath
"newsvs"   = "10"                                                                  // new Save vs. Spell
"newfr"    = "-50"                                                                 // new Resist Fire value
"newcr"    = "100"                                                                 // new Resist Cold value
"newlvl1"  = "12"                                                                  // new level (first class)
"newstr"   = "17"                                                                  // new Strength value
"newdex"   = "14"                                                                  // new Dexterity value
"newcon"   = "12"                                                                  // new Constitution value
"newint"   = "7"                                                                   // new Intelligence value
"newwis"   = "6"                                                                   // new Wisdom value
"newchr"   = "7"                                                                   // new Charisma value
"newmor"   = "12"                                                                  // new morale value
"newmorb"  = "2"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "255"                                                                 // new general (MONSTER)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "187"                                                                 // new class (ELEMENTAL_FIRE, note: leaving this as is in order for The Wave to function properly)
"newalign" = "51"                                                                  // new alignment (Chaotic Evil)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EFRSA"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "GRPSHT01"                                                          // generic shout AI script
"script04"   = "GENSHT01"                                                          // generic shout AI script
"script05"   = "WDASIGHT"                                                          // generic AI script
"script06"   = "dw#melee"                                                          // SCSII melee AI script
"script07"   = "CRESHOUT"                                                          // Big Picture shout script
"script08"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~extraplanar_traits~ END                                     // add extraplanar traits
LAUNCH_PATCH_FUNCTION cold_spell_immunities END                                    // grant immunities to cold-based area effect spells
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~salgrice~) BEGIN                       // special case, the Frost Salamanders in Abazigal's lair need a diferent script setup
  WRITE_ASCII 0x248 ~DEADABAZ~ #8                                                  // override script (already set in ARE file so we can't use that slot)
  WRITE_ASCII 0x250 ~RR#EFRSA~ #8                                                  // class script
END
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~icsalcol~) BEGIN                       // special case, add a death variable to SoA Frost Salamanders
  WRITE_ASCII 0x280 ~icsalcol~ #32                                                 // assign new death variable
END
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Invisible Stalker

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~stalke~                                                             // Invisible Stalker
            ~senstalk~                                                             // Invisible Stalker (Sendai's lair)
            ~gorstalk~                                                             // Guardian of Air (Watcher's Keep, treated as an unique Invisible Stalker)
             ~dvstalk~                                                             // Invisible Stalker (Spell Revisions)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#track~ #0 ~innate~ ( 1 )                                   // adds 1x Tracking
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EISTA~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REMOVE_CRE_ITEM ~MAGE01~                                                           // initial invisibility is handled via weapon
REMOVE_CRE_ITEM ~STALKESU~                                                         // original CRE had two copies of this attack
REMOVE_CRE_ITEM ~STALKER~                                                          // immunities are handled differently
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "9"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "3000"                                                                // new XP value
"newhp"    = "64"                                                                  // new hit point value
"newac"    = "3"                                                                   // new Armor Class value
"newth"    = "13"                                                                  // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "10"                                                                  // new Save vs. Death
"newsvw"   = "12"                                                                  // new Save vs. Wand
"newsvp"   = "11"                                                                  // new Save vs. Polymorph
"newsvb"   = "12"                                                                  // new Save vs. Breath
"newsvs"   = "13"                                                                  // new Save vs. Spell
"newlvl1"  = "8"                                                                   // new level (first class)
"newstr"   = "16"                                                                  // new Strength value
"newdex"   = "17"                                                                  // new Dexterity value
"newcon"   = "14"                                                                  // new Constitution value
"newint"   = "14"                                                                  // new Intelligence value
"newwis"   = "14"                                                                  // new Wisdom value
"newchr"   = "11"                                                                  // new Charisma value
"newmor"   = "14"                                                                  // new morale value
"newmorb"  = "3"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "255"                                                                 // new general (MONSTER)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "186"                                                                 // new class (ELEMENTAL_AIR)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
STR_VAR                                                                            // initialize strings
"notenf01"   = "gorstalk"                                                          // non-enforced creature 1 (uses best stat values)
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EISTA"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // generic AI script
"script04"   = "dw#melee"                                                          // SCSII melee AI script
"script05"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script06"   = "WBASIGHT"                                                          // Big Picture generic AI script
"script07"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script08"   = "senstalk"                                                          // Invisible Stalker in Sendai's lair (covered via aTweaks base script)
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION hover_immunities END                                         // grant immunities to ground-based spells
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Nereid

COPY ~atweaks/cre/elementals/rr#enere.cre~ ~override~                              // Nereid (hostile)
  SAY NAME1 @2103 SAY NAME2 @2103
ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
               ~shoal~                                                             // Shoal the Nereid (BGT)
              ~_shoal~                                                             // Shoal the Nereid (Tutu)
            ~rr#enere~                                                             // aTweaks' Nereid
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#enkis~ #0 ~innate~ ( 1 )                                   // adds 1x Drowning Kiss
ADD_MEMORIZED_SPELL ~rr#envsp~ #0 ~innate~ ( 1 )                                   // adds 1x Venom Spit
ADD_MEMORIZED_SPELL ~rr#ensww~ #0 ~innate~ ( 1 )                                   // adds 1x Summon Water Weird
PATCH_IF (("%SOURCE_RES%" STRING_EQUAL_CASE ~SHOAL~) OR ("%SOURCE_RES%" STRING_EQUAL_CASE ~_SHOAL~)) BEGIN // special case, Shoal the Nereid
  READ_ASCII  0x248 ~ovrscr~                                                       // old override script
  PATCH_IF ("%ovrscr%" STRING_EQUAL_CASE "None") OR ("%ovrscr%" STRING_EQUAL_CASE "") BEGIN            
    WRITE_EVALUATED_ASCII 0x248 "%TUTU_VAR%SHOAL" #8                               // new override script
    WRITE_EVALUATED_ASCII 0x250 "None" #8                                          // new class script
   END
END
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "9"                                                                   // new movement rate
"newxpv"   = "975"                                                                 // new XP value
"newhp"    = "32"                                                                  // new hit point value
"newac"    = "10"                                                                  // new Armor Class value
"newth"    = "17"                                                                  // new THAC0 value
"newapr"   = "0"                                                                   // new number of attacks per round
"newsvd"   = "13"                                                                  // new Save vs. Death
"newsvw"   = "15"                                                                  // new Save vs. Wand
"newsvp"   = "14"                                                                  // new Save vs. Polymorph
"newsvb"   = "16"                                                                  // new Save vs. Breath
"newsvs"   = "16"                                                                  // new Save vs. Spell
"newmr"    = "50"                                                                  // new Magic Resistance value
"newlvl1"  = "4"                                                                   // new level (first class)
"newstr"   = "9"                                                                   // new Strength value
"newdex"   = "17"                                                                  // new Dexterity value
"newcon"   = "12"                                                                  // new Constitution value
"newint"   = "12"                                                                  // new Intelligence value
"newwis"   = "12"                                                                  // new Wisdom value
"newchr"   = "18"                                                                  // new Charisma value
"newmor"   = "11"                                                                  // new morale value
"newmorb"  = "4"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "1"                                                                   // new general (HUMANOID)
"newrace"  = "120"                                                                 // new race (FAIRY)
"newclass" = "132"                                                                 // new class (FAIRY_NEREID)
"newalign" = "50"                                                                  // new alignment (Chaotic Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
STR_VAR                                                                            // initialize strings
"notenf01"   = "shoal"                                                             // non-enforced creature 1 (uses best stat values)
"notenf02"   = "_shoal"                                                            // non-enforced creature 2 (uses best stat values)
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
INT_VAR
"ovrempty" = "3"                                                                   // special case, do not use the override script slot for Nereids because of Shoal
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#ENERE"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // generic AI script(BGT)
"script04"   = "_TASIGHT"                                                          // generic AI script(Tutu)
"script05"   = "dw#melee"                                                          // SCSII melee AI script
"script06"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~ADD_CRE_EFFECT~                                             // Starts FUNCTION call (add new creature effect built-in function)
  INT_VAR
    opcode = "232"                                                                 // effect: #232 (Cast Spell on Condition)
    target = "1"                                                                   // target: 1 (self)
    timing = "9"                                                                   // timing mode: 9 (permanent after death)
    "duration" = "0"                                                               // duration: 0
    "parameter1" = "0"                                                             // param1: (target)
    "parameter2" = "7"                                                             // param2: (condition)
    "sectype" = "0"                                                                // secondary type: none
    probability1 = "100"                                                           // probability1: 100%
    STR_VAR
    "resource"  = "RR#ENDIS"                                                       // resref: (Nereid's Displacement ability)
    "effsource" = ""                                                               // effsource: none
    END
LAUNCH_PATCH_FUNCTION ~extraplanar_traits~ END                                     // add extraplanar traits
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Salamander Noble

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~salgrfir~                                                             // Salamander Noble
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#wi103~ #0 ~innate~ ( 3 )                                   // adds 3x Burning Hands
ADD_MEMORIZED_SPELL ~rr#wi303~ #0 ~innate~ ( 3 )                                   // adds 3x Flame Arrow
ADD_MEMORIZED_SPELL ~rr#wi304~ #0 ~innate~ ( 3 )                                   // adds 3x Fireball
ADD_MEMORIZED_SPELL ~rr#wi418~ #0 ~innate~ ( 3 )                                   // adds 3x Fire Shield:Red
ADD_MEMORIZED_SPELL ~rr#ecfir~ #0 ~innate~ ( 1 )                                   // adds 1x Conjure Fire Elemental
ADD_MEMORIZED_SPELL ~rr#enlfr~ #0 ~innate~ ( 1 )                                   // adds 1x Lower Fire Resistance
REPLACE_CRE_ITEM ~RR#ENSAL~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REPLACE_CRE_ITEM ~RR#ENSA2~ #0 #0 #0 ~UNDROPPABLE~ ~SHIELD~ EQUIP                  // tail attack
REMOVE_CRE_ITEM ~RING95~                                                           // Salamanders are not undead, they have their own specific set of immunities
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "14"                                                                  // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "10000"                                                               // new XP value
"newhp"    = "96"                                                                  // new hit point value
"newac"    = "0"                                                                   // new Armor Class value
"newth"    = "9"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"rr#ptwf"  = "1"                                                                   // perfect two weapon fighting (1 = enable)
"newsvd"   = "7"                                                                   // new Save vs. Death
"newsvw"   = "9"                                                                   // new Save vs. Wand
"newsvp"   = "8"                                                                   // new Save vs. Polymorph
"newsvb"   = "8"                                                                   // new Save vs. Breath
"newsvs"   = "10"                                                                  // new Save vs. Spell
"newmr"    = "25"                                                                  // new Magic Resistance value
"newfr"    = "100"                                                                 // new Resist Fire value
"newcr"    = "0"                                                                   // new Resist Cold value
"newlvl1"  = "7"                                                                   // new level (first class)
"newstr"   = "18"                                                                  // new Strength value
"newstrx"  = "100"                                                                 // new Exceptional Strength value
"newdex"   = "16"                                                                  // new Dexterity value
"newcon"   = "16"                                                                  // new Constitution value
"newint"   = "18"                                                                  // new Intelligence value
"newwis"   = "15"                                                                  // new Wisdom value
"newchr"   = "17"                                                                  // new Charisma value
"newmor"   = "18"                                                                  // new morale value
"newmorb"  = "2"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "255"                                                                 // new general (MONSTER)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "187"                                                                 // new class (ELEMENTAL_FIRE)
"newalign" = "19"                                                                  // new alignment (Lawful Evil)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#ENSAL"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "salgrfir"                                                          // generic shout AI script
"script04"   = "WDASIGHT"                                                          // generic AI script
"script05"   = "dw#melee"                                                          // SCSII melee AI script
"script06"   = "BPLEADER"                                                          // Big Picture AI script
"script07"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~extraplanar_traits~ END                                     // add extraplanar traits
LAUNCH_PATCH_FUNCTION fire_salamander_immunities END                               // grant fire salamander immunities
LAUNCH_PATCH_FUNCTION fire_spell_immunities END                                    // grant immunities to fire-based area effect spells
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Water Weird

// Give Water Weird a soundset (in case Distinctive Creature Soundsets isn't installed)

COPY    ~atweaks/wav/rr#ewa01.wav~ ~override~                                      // IWD Water Elemental Select Common 1 and Battle Cry 1
COPY    ~atweaks/wav/rr#ewa02.wav~ ~override~                                      // IWD Water Elemental Battle Cry 2
COPY    ~atweaks/wav/rr#ewa03.wav~ ~override~                                      // IWD Water Elemental Attack 1
COPY    ~atweaks/wav/rr#ewa04.wav~ ~override~                                      // IWD Water Elemental Attack 2
COPY    ~atweaks/wav/rr#ewa05.wav~ ~override~                                      // IWD Water Elemental Damage
COPY    ~atweaks/wav/rr#ewa06.wav~ ~override~                                      // IWD Water Elemental Dying
COPY    ~atweaks/wav/rr#ewa07.wav~ ~override~                                      // IWD Water Elemental Action Acknowledgement 1
COPY    ~atweaks/cre/elementals/rr#ewwei.cre~ ~override~                           // Water Weird (hostile)
  SAY NAME1 @2110 SAY NAME2 @2110 SAY SELECT_COMMON1 @471 SAY BATTLE_CRY1 @471 SAY BATTLE_CRY2 @472 SAY ATTACK1 @473 SAY ATTACK2 @474 SAY DAMAGE @475 SAY DYING @476 SAY SELECT_ACTION1 @477


ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
              ~rr#ewwei~                                                           // Water Weird
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EWWEI~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
ADD_CRE_ITEM ~RR#DINV~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~AMULET~                 // item which makes creatures invisible and untargetable while they gate in
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "9"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "420"                                                                 // new XP value
"newhp"    = "27"                                                                  // new hit point value
"newac"    = "4"                                                                   // new Armor Class value
"newth"    = "15"                                                                  // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "13"                                                                  // new Save vs. Death
"newsvw"   = "15"                                                                  // new Save vs. Wand
"newsvp"   = "14"                                                                  // new Save vs. Polymorph
"newsvb"   = "16"                                                                  // new Save vs. Breath
"newsvs"   = "16"                                                                  // new Save vs. Spell
"newfr"    = "50"                                                                  // new Resist Fire value
"newrs"    = "99"                                                                  // new Resist Slashing
"newrp"    = "99"                                                                  // new Resist Piercing
"newrm"    = "99"                                                                  // new Resist Missiles
"newlvl1"  = "3"                                                                   // new level (first class)
"newstr"   = "13"                                                                  // new Strength value
"newdex"   = "15"                                                                  // new Dexterity value
"newcon"   = "16"                                                                  // new Constitution value
"newint"   = "12"                                                                  // new Intelligence value
"newwis"   = "10"                                                                  // new Wisdom value
"newchr"   = "12"                                                                  // new Charisma value
"newmor"   = "13"                                                                  // new morale value
"newmorb"  = "4"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "255"                                                                 // new general (MONSTER)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "255"                                                                 // new class (NO_CLASS)
"newalign" = "51"                                                                  // new alignment (Chaotic Evil)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EWWEI"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
END                                                                                // ends FUNCTION call
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Lesser Air Elemental (8 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~ELAIRL01~                                                             // Lesser Air Elemental (8 HD)
            ~ELAIRSUW~                                                             // Lesser Air Elemental (8 HD, summoned, wizard version)
            ~ELARIL01~                                                             // Lesser Air Elemental (8 HD, Bioware's typo?)
            ~GORAIR01~                                                             // Lesser Air Elemental (8 HD, Watcher's Keep)
            ~SUMELAIR~                                                             // Lesser Air Elemental (8 HD, summoned, Staff of Air)
            ~DW#PRELA~                                                             // SCS - Prat's Lesser Air Elementals
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY NAME1 #2845 SAY NAME2 #2847                                                    // Lesser Air Elemental
WRITE_SHORT 0x28 "29473"                                                           // use the proper avatar (ELEMENTAL_AIR_SMALL)
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#eairw~ #0 ~innate~ ( 1 )                                   // adds 1x Air Elemental Whirlwind
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EAIRL~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REPLACE_CRE_ITEM ~IMMUNE1~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                          // revise weapon immunities
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "14"                                                                  // new movement rate
"newxpv"   = "3000"                                                                // new XP value
"newhp"    = "64"                                                                  // new hit point value
"newac"    = "4"                                                                   // new Armor Class value
"newth"    = "13"                                                                  // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "10"                                                                  // new Save vs. Death
"newsvw"   = "12"                                                                  // new Save vs. Wand
"newsvp"   = "11"                                                                  // new Save vs. Polymorph
"newsvb"   = "12"                                                                  // new Save vs. Breath
"newsvs"   = "13"                                                                  // new Save vs. Spell
"newlvl1"  = "8"                                                                   // new level (first class)
"newstr"   = "10"                                                                  // new Strength value
"newdex"   = "19"                                                                  // new Dexterity value
"newcon"   = "10"                                                                  // new Constitution value
"newint"   = "7"                                                                   // new Intelligence value
"newwis"   = "7"                                                                   // new Wisdom value
"newchr"   = "7"                                                                   // new Charisma value
"newmor"   = "14"                                                                  // new morale value
"newmorb"  = "4"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "255"                                                                 // new general (MONSTER)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "186"                                                                 // new class (ELEMENTAL_AIR)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EAIR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "AIRELE01"                                                          // Air Elemental script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "WDASIGHT"                                                          // generic AI script
"script06"   = "GENSHT01"                                                          // generic shout script
"script07"   = "dw#melee"                                                          // SCSII melee AI script
"script08"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script09"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script10"   = "CRESHOUT"                                                          // Big Picture shout script
"script11"   = "HUMANSHT"                                                          // Big Picture shout script
"script12"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION hover_immunities END                                         // grant immunities to ground-based spells
LAUNCH_PATCH_FUNCTION air_affinity END                                             // grant air affinity bonuses
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Air Elemental (12 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~_IRASPEC~                                                             // Air Aspect (Tutu)
            ~AIRASPEC~                                                             // Air Aspect (BGT)
             ~ELAIR01~                                                             // Air Elemental (12 HD)
            ~ELAIRSU1~                                                             // Air Elemental (12 HD, summoned, wizard version)
               ~MDAIR~                                                             // Air Elemental (12 HD, unused?)
              ~MDAIR2~                                                             // Air Elemental (12 HD, unused?)
            ~PAIREL01~                                                             // Air Elemental (12 HD, unused?)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
WRITE_SHORT 0x28 "29472"                                                           // use the proper avatar (ELEMENTAL_AIR)
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~ELAIRSU1~) BEGIN                       // special case, this particular Air Elemental needs to be renamed
  SAY NAME1 #2831 SAY NAME2 #2832                                                  // Air Elemental
END                                                                                // ends ELAIRSU1 specific block
PATCH_IF (("%SOURCE_RES%" STRING_EQUAL_CASE ~AIRASPEC~) OR ("%SOURCE_RES%" STRING_EQUAL_CASE ~_IRASPEC~)) BEGIN // special case, Air Aspect
  REMOVE_CRE_ITEM ~%TUTU_VAR%MISC52~                                               // Wyvern Head
  REMOVE_CRE_ITEM ~%TUTU_VAR%WYVERN1~                                              // Wyvern Attack 1
  REMOVE_CRE_ITEM ~%TUTU_VAR%WYVERN2~                                              // Wyvern Attack 2
  REMOVE_CRE_ITEM ~%TUTU_VAR%RING97~                                               // Flight immunities are handled differently in aTweaks
  REMOVE_CRE_ITEM ~%TUTU_VAR%MAGE06~                                               // Remove the haste ring
  ADD_CRE_ITEM ~IMMUNE2~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                            // revise weapon immunities
  WRITE_BYTE 0x2E 6                                                                // major color (Dark Silver)
  WRITE_SHORT 0x28 "29473"                                                         // use the proper avatar (ELEMENTAL_AIR_SMALL)
  WRITE_BYTE 0x53 "1"                                                              // set attacks per round to 1
  FOR (s1 = 0xa4; s1 < 0x234; s1 += 0x4) BEGIN                                     // Null soundset (code borrowed from Nythrun with thanks)
      WRITE_LONG s1 ~-1~
  END
END                                                                                // ends Air Aspect specific block
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#eairw~ #0 ~innate~ ( 1 )                                   // adds 1x Air Elemental Whirlwind
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EAIRR~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "36"                                                                  // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "7000"                                                                // new XP value
"newhp"    = "96"                                                                  // new hit point value
"newac"    = "2"                                                                   // new Armor Class value
"newth"    = "9"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "7"                                                                   // new Save vs. Death
"newsvw"   = "9"                                                                   // new Save vs. Wand
"newsvp"   = "8"                                                                   // new Save vs. Polymorph
"newsvb"   = "8"                                                                   // new Save vs. Breath
"newsvs"   = "10"                                                                  // new Save vs. Spell
"newlvl1"  = "12"                                                                  // new level (first class)
"newstr"   = "12"                                                                  // new Strength value
"newdex"   = "21"                                                                  // new Dexterity value
"newcon"   = "12"                                                                  // new Constitution value
"newint"   = "7"                                                                   // new Intelligence value
"newwis"   = "7"                                                                   // new Wisdom value
"newchr"   = "7"                                                                   // new Charisma value
"newmor"   = "16"                                                                  // new morale value
"newmorb"  = "3"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "186"                                                                 // new class (ELEMENTAL_AIR)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
STR_VAR                                                                            // initialize strings
"notenf01"   = "_IRASPEC"                                                          // non-enforced creature 1 (uses best stat values)
"notenf02"   = "AIRASPEC"                                                          // non-enforced creature 2 (uses best stat values)
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EAIR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "AIRELE01"                                                          // Air Elemental script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "WDASIGHT"                                                          // generic AI script
"script06"   = "GENSHT01"                                                          // generic shout script
"script07"   = "dw#melee"                                                          // SCSII melee AI script
"script08"   = "BPWTASGT"                                                          // Big Picture generic AI script
"script09"   = "WYVERN"                                                            // Wyvern AI script (BGT)
"script10"   = "_WYVERN"                                                           // Wyvern AI script (Tutu)
"script11"   = "_TASIGHT"                                                          // generic AI script (Tutu)
"script09"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script08"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script09"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script10"   = "CRESHOUT"                                                          // Big Picture shout script
"script11"   = "HUMANSHT"                                                          // Big Picture shout script
"script12"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION hover_immunities END                                         // grant immunities to ground-based spells
LAUNCH_PATCH_FUNCTION air_affinity END                                             // grant air affinity bonuses
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Greater Air Elemental (16 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~ELAIRG01~                                                             // Greater Air Elemental (16 HD)
            ~ELAIRSU2~                                                             // Air Elemental (16 HD, wizard version)
            ~GORAIR02~                                                             // Greater Air Elemental (16 HD, Watcher's Keep)
              ~MDAIRG~                                                             // Greater Air Elemental (16 HD, unused?)
             ~MDAIRG2~                                                             // Greater Air Elemental (16 HD, unused?)
              ~MDHSSS~                                                             // Greater Air Elemental (16 HD, unused?)
              ~MDHSSS~                                                             // Greater Air Elemental (16 HD, unused?)
            ~SWAAIR01~                                                             // Air Elemental (16 HD, Elemental Summoning HLA)
               ~UDAIR~                                                             // Air Elemental (Underdark portal respawn)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY NAME1 #2848 SAY NAME2 #2849                                                    // Greater Air Elemental
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~UDAIR~) BEGIN                          // special case, Underdark portal spawn
  WRITE_ASCII 0x248 ~dwair~ #8                                                     // override script
  WRITE_ASCII 0x250 ~~ #8                                                          // class script
END                                                                                // ends PATCH_IF
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#eairw~ #0 ~innate~ ( 1 )                                   // adds 1x Air Elemental Whirlwind
ADD_MEMORIZED_SPELL ~rr#ecncl~ #0 ~innate~ ( 1 )                                   // adds 1x Elemental Concealment
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EAIRG~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "36"                                                                  // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "11000"                                                               // new XP value
"newhp"    = "128"                                                                 // new hit point value
"newac"    = "1"                                                                   // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "4"                                                                   // new Save vs. Death
"newsvw"   = "6"                                                                   // new Save vs. Wand
"newsvp"   = "5"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "7"                                                                   // new Save vs. Spell
"newmr"    = "25"                                                                  // new Magic Resistance value
"newlvl1"  = "16"                                                                  // new level (first class)
"newstr"   = "14"                                                                  // new Strength value
"newdex"   = "22"                                                                  // new Dexterity value
"newcon"   = "14"                                                                  // new Constitution value
"newint"   = "10"                                                                  // new Intelligence value
"newwis"   = "10"                                                                  // new Wisdom value
"newchr"   = "10"                                                                  // new Charisma value
"newmor"   = "18"                                                                  // new morale value
"newmorb"  = "2"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "186"                                                                 // new class (ELEMENTAL_AIR)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EAIR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "AIRELE01"                                                          // Air Elemental script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "WDASIGHT"                                                          // generic AI script
"script06"   = "GENSHT01"                                                          // generic shout script
"script07"   = "dw#melee"                                                          // SCSII melee AI script
"script08"   = "BPWTASGT"                                                          // Big Picture generic AI script
"script09"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script10"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script11"   = "CRESHOUT"                                                          // Big Picture shout script
"script12"   = "HUMANSHT"                                                          // Big Picture shout script
"script13"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION hover_immunities END                                         // grant immunities to ground-based spells
LAUNCH_PATCH_FUNCTION air_affinity END                                             // grant air affinity bonuses
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Elder Air Elemental (20 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~ELAIRSU3~                                                             // Air Elemental (20+ HD, summoned, wizard version)
               ~SUAIR~                                                             // Air Elemental (Suldanesselar, Tree of Life guardian)
            ~SWAAIR02~                                                             // Air Elemental (20+ HD, summoned, Elemental Summoning HLA)
              ~UDELDA~                                                             // Air Elemental (Underdark portal guardian)
              li#druai                                                             // Elemental transformation air (Refinements)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY NAME1 @2115 SAY NAME2 @2115                                                    // Elder Air Elemental
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#eairw~ #0 ~innate~ ( 1 )                                   // adds 1x Air Elemental Whirlwind
ADD_MEMORIZED_SPELL ~rr#ecncl~ #0 ~innate~ ( 1 )                                   // adds 1x Elemental Concealment
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EAIRE~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REPLACE_CRE_ITEM ~IMMUNE3~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                          // revise weapon immunities
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "36"                                                                  // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "15000"                                                               // new XP value
"newhp"    = "160"                                                                 // new hit point value
"newac"    = "0"                                                                   // new Armor Class value
"newth"    = "1"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "5"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "6"                                                                   // new Save vs. Spell
"newmr"    = "50"                                                                  // new Magic Resistance value
"newlvl1"  = "20"                                                                  // new level (first class)
"newstr"   = "15"                                                                  // new Strength value
"newdex"   = "23"                                                                  // new Dexterity value
"newcon"   = "16"                                                                  // new Constitution value
"newint"   = "12"                                                                  // new Intelligence value
"newwis"   = "12"                                                                  // new Wisdom value
"newchr"   = "12"                                                                  // new Charisma value
"newmor"   = "19"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "186"                                                                 // new class (ELEMENTAL_AIR)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
STR_VAR
  notenf01 = li#druai
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EAIR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "AIRELE01"                                                          // Air Elemental script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "WDASIGHT"                                                          // generic AI script
"script06"   = "GENSHT01"                                                          // generic shout script
"script07"   = "dw#melee"                                                          // SCSII melee AI script
"script08"   = "BPWTASGT"                                                          // Big Picture generic AI script
"script09"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script10"   = "dw#udela"                                                          // SCSII custom AI
"script11"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script12"   = "CRESHOUT"                                                          // Big Picture shout script
"script13"   = "HUMANSHT"                                                          // Big Picture shout script
"script14"   = "BPWDASGT"                                                          // Big Picture generic AI script
skipfile01   = li#druai
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION hover_immunities END                                         // grant immunities to ground-based spells
LAUNCH_PATCH_FUNCTION air_affinity END                                             // grant air affinity bonuses
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Lesser Earth Elemental (8 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~ELEARL01~                                                             // Lesser Earth Elemental (8 HD)
            ~ELEARSU1~                                                             // Earth Elemental (8 HD, summoned, wizard version)
            ~ELEARSUW~                                                             // Lesser Earth Elemental (8 HD, summoned, wizard version)
            ~ELEEEL01~                                                             // Lesser Earth Elemental (8 HD)
            ~MEKEAR01~                                                             // Lesser Earth Elemental (8 HD, Mekrath's quest)
            ~SUMELEAR~                                                             // Lesser Earth Elemental (8 HD, summoned, Staff of Earth)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY NAME1 #2850 SAY NAME2 #2851                                                    // Lesser Earth Elemental
WRITE_SHORT 0x28 "29441"                                                           // use the proper avatar (ELEMENTAL_EARTH_SMALL)
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EEARL~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REPLACE_CRE_ITEM ~IMMUNE1~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                          // revise weapon immunities
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "5"                                                                   // new movement rate
"newxpv"   = "2000"                                                                // new XP value
"newhp"    = "64"                                                                  // new hit point value
"newac"    = "4"                                                                   // new Armor Class value
"newth"    = "13"                                                                  // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "10"                                                                  // new Save vs. Death
"newsvw"   = "12"                                                                  // new Save vs. Wand
"newsvp"   = "11"                                                                  // new Save vs. Polymorph
"newsvb"   = "12"                                                                  // new Save vs. Breath
"newsvs"   = "13"                                                                  // new Save vs. Spell
"newlvl1"  = "8"                                                                   // new level (first class)
"newstr"   = "19"                                                                  // new Strength value
"newdex"   = "10"                                                                  // new Dexterity value
"newcon"   = "16"                                                                  // new Constitution value
"newint"   = "7"                                                                   // new Intelligence value
"newwis"   = "7"                                                                   // new Wisdom value
"newchr"   = "7"                                                                   // new Charisma value
"newmor"   = "14"                                                                  // new morale value
"newmorb"  = "4"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "255"                                                                 // new general (MONSTER)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "188"                                                                 // new class (ELEMENTAL_EARTH)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EEAR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // generic AI script
"script04"   = "WDASIGHT"                                                          // generic AI script
"script05"   = "GENSHT01"                                                          // generic shout script
"script06"   = "dw#melee"                                                          // SCSII melee AI script
"script07"   = "BPWTASGT"                                                          // Big Picture generic AI script
"script08"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script09"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script10"   = "CRESHOUT"                                                          // Big Picture shout script
"script11"   = "HUMANSHT"                                                          // Big Picture shout script
"script12"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION earth_affinity END                                           // apply earth affinity traits
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block



// Earth Elemental (12 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
             ~ELEAR01~                                                             // Earth Elemental (12 HD)
             ~ELEARPR~                                                             // Earth Elemental (12 HD, summoned, priest version)
            ~ELEARSU2~                                                             // Earth Elemental (12 HD, summoned, wizard version)
              ~KEARTH~                                                             // Earth Elemental (12 HD, unused?)
             ~SHEARTH~                                                             // Earth Elemental (12 HD, Shapechange Spell)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EEARR~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "5"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "6000"                                                                // new XP value
"newhp"    = "96"                                                                  // new hit point value
"newac"    = "2"                                                                   // new Armor Class value
"newth"    = "9"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "7"                                                                   // new Save vs. Death
"newsvw"   = "9"                                                                   // new Save vs. Wand
"newsvp"   = "8"                                                                   // new Save vs. Polymorph
"newsvb"   = "8"                                                                   // new Save vs. Breath
"newsvs"   = "10"                                                                  // new Save vs. Spell
"newlvl1"  = "12"                                                                  // new level (first class)
"newstr"   = "20"                                                                  // new Strength value
"newdex"   = "10"                                                                  // new Dexterity value
"newcon"   = "18"                                                                  // new Constitution value
"newint"   = "7"                                                                   // new Intelligence value
"newwis"   = "7"                                                                   // new Wisdom value
"newchr"   = "7"                                                                   // new Charisma value
"newmor"   = "16"                                                                  // new morale value
"newmorb"  = "3"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "188"                                                                 // new class (ELEMENTAL_EARTH)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EEAR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // generic AI script
"script04"   = "WDASIGHT"                                                          // generic AI script
"script05"   = "GENSHT01"                                                          // generic shout script
"script06"   = "dw#melee"                                                          // SCSII melee AI script
"script07"   = "BPWTASGT"                                                          // Big Picture generic AI script
"script08"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script09"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script10"   = "CRESHOUT"                                                          // Big Picture shout script
"script11"   = "HUMANSHT"                                                          // Big Picture shout script
"script12"   = "BPWDASGT"                                                          // Big Picture generic AI script
"skipfile01" = "SHEARTH"                                                           // skip script patching for a designated file
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION earth_affinity END                                           // apply earth affinity traits
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Greater Earth Elemental (16 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~ELEARG01~                                                             // Greater Earth Elemental (16 HD)
            ~ELEARPR2~                                                             // Earth Elemental (16 HD, summoned, priest version)
             ~ELEARSU~                                                             // Earth Elemental (16 HD, summoned, unused?)
            ~ELEARSU3~                                                             // Earth Elemental (16 HD, summoned, wizard version)
            ~SWAEAR01~                                                             // Earth Elemental (16 HD, summoned, Elemental Summoning HLA)
             ~UDEARTH~                                                             // Earth Elemental (Underdark portal spawn)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY NAME1 #2853 SAY NAME2 #2856                                                    // Greater Earth Elemental
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~UDEARTH~) BEGIN                        // special case, Underdark portal spawn
  WRITE_ASCII 0x248 ~DWEARTH~ #8                                                   // override script
  WRITE_ASCII 0x250 ~~ #8                                                          // class script
END                                                                                // ends PATCH_IF
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#equa~ #0 ~innate~ ( 1 )                                    // adds 1x Earthquake
ADD_MEMORIZED_SPELL ~rr#ecncl~ #0 ~innate~ ( 1 )                                   // adds 1x Elemental Concealment
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EEARG~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "7"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "11000"                                                               // new XP value
"newhp"    = "128"                                                                 // new hit point value
"newac"    = "1"                                                                   // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "4"                                                                   // new Save vs. Death
"newsvw"   = "6"                                                                   // new Save vs. Wand
"newsvp"   = "5"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "7"                                                                   // new Save vs. Spell
"newmr"    = "25"                                                                  // new Magic Resistance value
"newlvl1"  = "16"                                                                  // new level (first class)
"newstr"   = "22"                                                                  // new Strength value
"newdex"   = "12"                                                                  // new Dexterity value
"newcon"   = "20"                                                                  // new Constitution value
"newint"   = "10"                                                                  // new Intelligence value
"newwis"   = "10"                                                                  // new Wisdom value
"newchr"   = "10"                                                                  // new Charisma value
"newmor"   = "18"                                                                  // new morale value
"newmorb"  = "2"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "188"                                                                 // new class (ELEMENTAL_EARTH)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EEAR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // generic AI script
"script04"   = "WDASIGHT"                                                          // generic AI script
"script05"   = "GENSHT01"                                                          // generic shout script
"script06"   = "dw#melee"                                                          // SCSII melee AI script
"script07"   = "BPWTASGT"                                                          // Big Picture generic AI script
"script08"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script09"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script10"   = "CRESHOUT"                                                          // Big Picture shout script
"script11"   = "HUMANSHT"                                                          // Big Picture shout script
"script12"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION earth_affinity END                                           // apply earth affinity traits
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Elder Earth Elemental (20 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~DRUEAR01~                                                             // Earth Elemental (Druid Earth Elemental Transformation HLA)
            ~ELEARPR3~                                                             // Earth Elemental (20+ HD, priest version)
            ~ELEARSU4~                                                             // Earth Elemental (20+ HD, wizard version)
             ~MDEARTH~                                                             // Earth Elemental (20+ HD, unused?)
            ~MDEARTH2~                                                             // Earth Elemental (20+ HD, unused?)
             ~SUEARTH~                                                             // Earth Elemental (Suldanesselar, Tree of Life guardian)
            ~SWAEAR02~                                                             // Earth Elemental (20+ HD, Elemental Summoning HLA)
              ~UDELDE~                                                             // Earth Elemental (Underdark portal guardian)
              dw#eldee                                                             // SCSII "Improved Minor Encounters" greater earth elemental
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY NAME1 @2116 SAY NAME2 @2116                                                    // Elder Earth Elemental
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#equa~ #0 ~innate~ ( 1 )                                    // adds 1x Earthquake
ADD_MEMORIZED_SPELL ~rr#ecncl~ #0 ~innate~ ( 1 )                                   // adds 1x Elemental Concealment
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EEARE~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REPLACE_CRE_ITEM ~IMMUNE3~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                          // revise weapon immunities
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
SPRINT notenf_regexp "^$"
PATCH_IF FILE_EXISTS_IN_GAME li#druea.itm BEGIN                                    //Do not enforce if Refinements is installed
  SPRINT notenf_regexp DRUEAR01
END
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "7"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "14000"                                                               // new XP value
"newhp"    = "160"                                                                 // new hit point value
"newac"    = "0"                                                                   // new Armor Class value
"newth"    = "1"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "5"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "6"                                                                   // new Save vs. Spell
"newmr"    = "50"                                                                  // new Magic Resistance value
"newlvl1"  = "20"                                                                  // new level (first class)
"newstr"   = "23"                                                                  // new Strength value
"newdex"   = "12"                                                                  // new Dexterity value
"newcon"   = "20"                                                                  // new Constitution value
"newint"   = "12"                                                                  // new Intelligence value
"newwis"   = "12"                                                                  // new Wisdom value
"newchr"   = "12"                                                                  // new Charisma value
"newmor"   = "19"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "188"                                                                 // new class (ELEMENTAL_EARTH)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
STR_VAR
  notenf_regexp
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EEAR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // generic AI script
"script04"   = "WDASIGHT"                                                          // generic AI script
"script05"   = "GENSHT01"                                                          // generic shout script
"script06"   = "dw#melee"                                                          // SCSII melee AI script
"script07"   = "BPWTASGT"                                                          // Big Picture generic AI script
"script08"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script09"   = "dw#udele"                                                          // SCSII custom AI script
"script10"   = "CRESHOUT"                                                          // Big Picture shout script
"script11"   = "HUMANSHT"                                                          // Big Picture shout script
"script12"   = "BPWDASGT"                                                          // Big Picture generic AI script
"script13"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"skipfile01" = "DRUEAR01"                                                          // skip script patching for a designated file
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION earth_affinity END                                           // apply earth affinity traits
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Lesser Fire Elemental (8 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~ELEFEL01~                                                             // Lesser Fire Elemental (8 HD)
            ~ELFIRL01~                                                             // Lesser Fire Elemental (8 HD)
            ~ELFIRSU1~                                                             // Fire Elemental (8 HD, summoned, wizard version)
            ~ELFIRSUW~                                                             // Lesser Fire Elemental (8 HD, summoned, wizard version)
            ~SUMELFIR~                                                             // Lesser Fire Elemental (8 HD, summoned, Staff of Fire)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY NAME1 #2878 SAY NAME2 #2879                                                    // Lesser Fire Elemental
WRITE_SHORT 0x28 "29457"                                                           // use the proper avatar (ELEMENTAL_FIRE_SMALL)
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EFIRL~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REPLACE_CRE_ITEM ~IMMUNE1~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                          // revise weapon immunities
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newxpv"   = "2000"                                                                // new XP value
"newhp"    = "64"                                                                  // new hit point value
"newac"    = "4"                                                                   // new Armor Class value
"newth"    = "13"                                                                  // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "10"                                                                  // new Save vs. Death
"newsvw"   = "12"                                                                  // new Save vs. Wand
"newsvp"   = "11"                                                                  // new Save vs. Polymorph
"newsvb"   = "12"                                                                  // new Save vs. Breath
"newsvs"   = "13"                                                                  // new Save vs. Spell
"newfr"    = "100"                                                                 // new Resist Fire value
"newlvl1"  = "8"                                                                   // new level (first class)
"newstr"   = "10"                                                                  // new Strength value
"newdex"   = "14"                                                                  // new Dexterity value
"newcon"   = "10"                                                                  // new Constitution value
"newint"   = "7"                                                                   // new Intelligence value
"newwis"   = "7"                                                                   // new Wisdom value
"newchr"   = "7"                                                                   // new Charisma value
"newmor"   = "14"                                                                  // new morale value
"newmorb"  = "4"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "255"                                                                 // new general (MONSTER)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "187"                                                                 // new class (ELEMENTAL_FIRE)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EFIR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // generic AI script
"script04"   = "WDASIGHT"                                                          // generic AI script
"script05"   = "GENSHT01"                                                          // generic shout script
"script06"   = "dw#melee"                                                          // SCSII melee AI script
"script07"   = "BPWTASGT"                                                          // Big Picture generic AI script
"script08"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script09"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script10"   = "CRESHOUT"                                                          // Big Picture shout script
"script11"   = "HUMANSHT"                                                          // Big Picture shout script
"script12"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION fire_spell_immunities END                                    // grant immunities to fire-based area effect spells
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Fire Elemental (12 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~C6DROWGO~                                                             // Fire Elemental (12 HD, Underdark Exit)
            ~DDGUARD7~                                                             // Guardian (Tomb of King Strohm III)
               ~ELFIR~                                                             // Fire Elemental (12 HD)
             ~ELFIR01~                                                             // Fire Elemental (12 HD)
             ~ELFIRPR~                                                             // Fire Elemental (12 HD, summoned, priest version)
            ~ELFIRSU2~                                                             // Fire Elemental (12 HD, summoned, wizard version)
              ~SHFIRE~                                                             // Fire Elemental (12 HD, Shapechange Spell)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
WRITE_SHORT 0x28 "29456"                                                           // use the proper avatar (ELEMENTAL_FIRE)
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EFIRR~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "6000"                                                                // new XP value
"newhp"    = "96"                                                                  // new hit point value
"newac"    = "2"                                                                   // new Armor Class value
"newth"    = "9"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "7"                                                                   // new Save vs. Death
"newsvw"   = "9"                                                                   // new Save vs. Wand
"newsvp"   = "8"                                                                   // new Save vs. Polymorph
"newsvb"   = "8"                                                                   // new Save vs. Breath
"newsvs"   = "10"                                                                  // new Save vs. Spell
"newfr"    = "100"                                                                 // new Resist Fire value
"newlvl1"  = "12"                                                                  // new level (first class)
"newstr"   = "12"                                                                  // new Strength value
"newdex"   = "15"                                                                  // new Dexterity value
"newcon"   = "12"                                                                  // new Constitution value
"newint"   = "7"                                                                   // new Intelligence value
"newwis"   = "7"                                                                   // new Wisdom value
"newchr"   = "7"                                                                   // new Charisma value
"newmor"   = "16"                                                                  // new morale value
"newmorb"  = "3"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "187"                                                                 // new class (ELEMENTAL_FIRE)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EFIR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // generic AI script
"script04"   = "WDASIGHT"                                                          // generic AI script
"script05"   = "GENSHT01"                                                          // generic shout script
"script06"   = "dw#melee"                                                          // SCSII melee AI script
"script07"   = "BPWTASGT"                                                          // Big Picture generic AI script
"script08"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script09"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script10"   = "CRESHOUT"                                                          // Big Picture shout script
"script11"   = "HUMANSHT"                                                          // Big Picture shout script
"script12"   = "BPWDASGT"                                                          // Big Picture generic AI script
"skipfile01" = "SHFIRE"                                                            // skip script patching for a designated file
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION fire_spell_immunities END                                    // grant immunities to fire-based area effect spells
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Greater Fire Elemental (16 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~DECKFELE~                                                             // Fire Elemental (Deck of Many Things)
            ~ELFIRG01~                                                             // Fire Elemental (16 HD)
            ~ELFIRPR2~                                                             // Fire Elemental (16 HD, summoned, priest version)
            ~ELFIRSU~                                                              // Fire Elemental (16 HD, summoned, unused?)
            ~ELFIRSU3~                                                             // Fire Elemental (16 HD, summoned, wizard version)
            ~GORFIR01~                                                             // Greater Fire Elemental (16 HD, Watcher's Keep)
            ~GORFIR02~                                                             // Greater Fire Elemental (16 HD, Watcher's Keep)
            ~GORFIR03~                                                             // Greater Fire Elemental (16 HD, Watcher's Keep)
            ~GORFIR04~                                                             // Greater Fire Elemental (16 HD, Watcher's Keep)
            ~OBSFIR06~                                                             // Greater Fire Elemental (16 HD, Planar Sphere)
            ~SUELEW1~                                                              // Greater Fire Elemental (16 HD, summoned, unused?)
            ~SUELEW2~                                                              // Greater Fire Elemental (16 HD, summoned, unused?)
            ~SWAFIR01~                                                             // Fire Elemental (16 HD, summoned, Elemental Summoning HLA)
            ~TELELFIR~                                                             // Greater Fire Elemental (16 HD, Watcher's Keep)
            ~YSCARA04~                                                             // Greater Fire Elemental (16 HD, unused?)
              ~UDFIRE~                                                             // Fire Elemental (Underdark portal spawn)
              tg#did5                                                              // Greater Fire Elemental (Refinements; special)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY NAME1 #2876 SAY NAME2 #2877                                                    // Greater Fire Elemental
PATCH_IF ("%SOURCE_RES%" STRING_EQUAL_CASE ~UDFIRE~) BEGIN                         // special case, Underdark portal spawn
  WRITE_ASCII 0x248 ~DWFIRE~ #8                                                    // override script
  WRITE_ASCII 0x250 ~~ #8                                                          // class script
END                                                                                // ends PATCH_IF
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#ecncl~ #0 ~innate~ ( 1 )                                   // adds 1x Elemental Concealment
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EFIRG~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "10000"                                                               // new XP value
"newhp"    = "128"                                                                 // new hit point value
"newac"    = "1"                                                                   // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "4"                                                                   // new Save vs. Death
"newsvw"   = "6"                                                                   // new Save vs. Wand
"newsvp"   = "5"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "7"                                                                   // new Save vs. Spell
"newmr"    = "25"                                                                  // new Magic Resistance value
"newfr"    = "100"                                                                 // new Resist Fire value
"newlvl1"  = "16"                                                                  // new level (first class)
"newstr"   = "14"                                                                  // new Strength value
"newdex"   = "16"                                                                  // new Dexterity value
"newcon"   = "14"                                                                  // new Constitution value
"newint"   = "10"                                                                  // new Intelligence value
"newwis"   = "10"                                                                  // new Wisdom value
"newchr"   = "10"                                                                  // new Charisma value
"newmor"   = "18"                                                                  // new morale value
"newmorb"  = "2"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "187"                                                                 // new class (ELEMENTAL_FIRE)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EFIR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // generic AI script
"script04"   = "WDASIGHT"                                                          // generic AI script
"script05"   = "GENSHT01"                                                          // generic shout script
"script06"   = "GORFIR"                                                            // Watcher's Keep Fire Elemental script (non-functional?)
"script07"   = "dw#melee"                                                          // SCSII melee AI script
"script08"   = "BPWTASGT"                                                          // Big Picture generic AI script
"script09"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script10"   = "CRESHOUT"                                                          // Big Picture shout script
"script11"   = "HUMANSHT"                                                          // Big Picture shout script
"script12"   = "BPWDASGT"                                                          // Big Picture generic AI script
"script13"   = "BPWTSIGT"                                                          // Big Picture generic AI script

skipfile01 = tg#did5
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION fire_spell_immunities END                                    // grant immunities to fire-based area effect spells
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Elder Fire Elemental (20 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~DRUFIR01~                                                             // Fire Elemental (Druid Fire Elemental Transformation HLA)
            ~ELFIRPR3~                                                             // Fire Elemental (20+ HD, summoned, priest version)
            ~ELFIRSU4~                                                             // Fire Elemental (20+ HD, summoned, wizard version)
             ~SUFIRE~                                                              // Fire Elemental (Suldanesselar, Tree of Life guardian)
            ~SWAFIR02~                                                             // Fire Elemental (20+ HD, summoned, Elemental Summoning HLA)
              ~UDELDF~                                                             // Fire Elemental (Underdark, portal guardian)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY NAME1 @2117 SAY NAME2 @2117                                                    // Elder Fire Elemental
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#ecncl~ #0 ~innate~ ( 1 )                                   // adds 1x Elemental Concealment
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EFIRE~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
REPLACE_CRE_ITEM ~IMMUNE3~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                          // revise weapon immunities
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
SPRINT notenf_regexp "^$"
PATCH_IF FILE_EXISTS_IN_GAME li#drufi.itm BEGIN                                    //Do not enforce DRUFIR01 if Refinements is installed
  SPRINT nonenf_regexp DRUFIR01
END
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "14000"                                                               // new XP value
"newhp"    = "160"                                                                 // new hit point value
"newac"    = "0"                                                                   // new Armor Class value
"newth"    = "1"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "5"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "6"                                                                   // new Save vs. Spell
"newmr"    = "50"                                                                  // new Magic Resistance value
"newfr"    = "100"                                                                 // new Resist Fire value
"newlvl1"  = "20"                                                                  // new level (first class)
"newstr"   = "16"                                                                  // new Strength value
"newdex"   = "17"                                                                  // new Dexterity value
"newcon"   = "16"                                                                  // new Constitution value
"newint"   = "12"                                                                  // new Intelligence value
"newwis"   = "12"                                                                  // new Wisdom value
"newchr"   = "12"                                                                  // new Charisma value
"newmor"   = "19"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "187"                                                                 // new class (ELEMENTAL_FIRE)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
STR_VAR
  notenf_regexp
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EFIR"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // generic AI script
"script04"   = "WDASIGHT"                                                          // generic AI script
"script05"   = "GENSHT01"                                                          // generic shout script
"script06"   = "dw#melee"                                                          // SCSII melee AI script
"script07"   = "BPWTASGT"                                                          // Big Picture generic AI script
"script08"   = "DVMELEE"                                                           // Spell Revisions melee AI script
"script09"   = "dw#udelf"                                                          // SCSII custom AI script
"script10"   = "CRESHOUT"                                                          // Big Picture shout script
"script11"   = "HUMANSHT"                                                          // Big Picture shout script
"script12"   = "BPWDASGT"                                                          // Big Picture generic AI script
"script13"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"skipfile01" = "DRUFIR01"                                                          // skip script patching for a designated file
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION fire_spell_immunities END                                    // grant immunities to fire-based area effect spells
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block



DEFINE_PATCH_FUNCTION add_water_elemental_effects BEGIN
  LAUNCH_PATCH_FUNCTION entangle_immunities END
  LAUNCH_PATCH_FUNCTION web_immunity END
  LPF ADD_CRE_EFFECT
    INT_VAR
      opcode = 52 //Character tint
      target = 1
      parameter1 = 0x02000000
      parameter2 = 0x2
      timing = 9
  END
  LPF ADD_CRE_EFFECT
    INT_VAR
      opcode = 66 //Translucency
      target = 1
      parameter1 = 100
      timing = 9
  END
END

// Lesser Water Elemental (8 HD)

COPY    ~atweaks/cre/elementals/rr#ewatl.cre~ ~override~                           // Lesser Water Elemental (hostile)
SAY NAME1 @2126 SAY NAME2 @2126 SAY SELECT_COMMON1 @471 SAY BATTLE_CRY1 @471 SAY BATTLE_CRY2 @472 SAY ATTACK1 @473 SAY ATTACK2 @474 SAY DAMAGE @475 SAY DYING @476 SAY SELECT_ACTION1 @477

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~rr#ewatl~                                                             // Lesser Water Elemental (aTweaks)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
REMOVE_CRE_EFFECTS
ADD_CRE_ITEM ~RR#DINV~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~AMULET~                 // item which makes creatures invisible and untargetable while they gate in
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "5"                                                                   // new movement rate
"newxpv"   = "2000"                                                                // new XP value
"newhp"    = "64"                                                                  // new hit point value
"newac"    = "4"                                                                   // new Armor Class value
"newth"    = "13"                                                                  // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "10"                                                                  // new Save vs. Death
"newsvw"   = "12"                                                                  // new Save vs. Wand
"newsvp"   = "11"                                                                  // new Save vs. Polymorph
"newsvb"   = "12"                                                                  // new Save vs. Breath
"newsvs"   = "13"                                                                  // new Save vs. Spell
"newlvl1"  = "8"                                                                   // new level (first class)
"newstr"   = "13"                                                                  // new Strength value
"newdex"   = "11"                                                                  // new Dexterity value
"newcon"   = "18"                                                                  // new Constitution value
"newint"   = "7"                                                                   // new Intelligence value
"newwis"   = "7"                                                                   // new Wisdom value
"newchr"   = "7"                                                                   // new Charisma value
"newmor"   = "14"                                                                  // new morale value
"newmorb"  = "4"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "255"                                                                 // new general (MONSTER)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "255"                                                                 // new class (NO_CLASS)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EWAT"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
END                                                                                // ends FUNCTION call
LPF add_water_elemental_effects END
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Water Elemental (12 HD)

COPY    ~atweaks/cre/elementals/rr#ewatr.cre~ ~override~                           // Water Elemental (hostile)
SAY NAME1 @2119 SAY NAME2 @2119 SAY SELECT_COMMON1 @471 SAY BATTLE_CRY1 @471 SAY BATTLE_CRY2 @472 SAY ATTACK1 @473 SAY ATTACK2 @474 SAY DAMAGE @475 SAY DYING @476 SAY SELECT_ACTION1 @477

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~rr#ewatr~                                                             // Water Elemental (aTweaks)
            tg#wel2                                                                // Water Elemental (Refinements)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
REMOVE_CRE_ITEM tg#wel2
REMOVE_CRE_EFFECTS
ADD_CRE_ITEM ~RR#DINV~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~AMULET~                 // item which makes creatures invisible and untargetable while they gate in
REPLACE_CRE_ITEM rr#etrai #0 #0 #0 none helmet
REPLACE_CRE_ITEM rr#ewatr #0 #0 #0 none weapon1
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "5"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "6000"                                                                // new XP value
"newhp"    = "96"                                                                  // new hit point value
"newac"    = "2"                                                                   // new Armor Class value
"newth"    = "9"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "7"                                                                   // new Save vs. Death
"newsvw"   = "9"                                                                   // new Save vs. Wand
"newsvp"   = "8"                                                                   // new Save vs. Polymorph
"newsvb"   = "8"                                                                   // new Save vs. Breath
"newsvs"   = "10"                                                                  // new Save vs. Spell
"newlvl1"  = "12"                                                                  // new level (first class)
"newstr"   = "15"                                                                  // new Strength value
"newdex"   = "12"                                                                  // new Dexterity value
"newcon"   = "20"                                                                  // new Constitution value
"newint"   = "7"                                                                   // new Intelligence value
"newwis"   = "7"                                                                   // new Wisdom value
"newchr"   = "7"                                                                   // new Charisma value
"newmor"   = "16"                                                                  // new morale value
"newmorb"  = "3"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "255"                                                                 // new class (NO_CLASS)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EWAT"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
END                                                                                // ends FUNCTION call
LPF add_water_elemental_effects END
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Greater Water Elemental (16 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~ELWATG01~                                                             // Greater Water Elemental
            tg#wel3                                                                // Greater Water Elemental (Refinements)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
SAY SELECT_COMMON1 @471 SAY BATTLE_CRY1 @471 SAY BATTLE_CRY2 @472 SAY ATTACK1 @473 SAY ATTACK2 @474 SAY DAMAGE @475 SAY DYING @476 SAY SELECT_ACTION1 @477
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
REMOVE_CRE_EFFECTS
ADD_MEMORIZED_SPELL ~rr#ecncl~ #0 ~innate~ ( 1 )                                   // adds 1x Elemental Concealment
REMOVE_CRE_ITEM ~WALLPASS~ tg#wel3
ADD_CRE_ITEM ~RR#DINV~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~AMULET~                 // item which makes creatures invisible and untargetable while they gate in
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EWATG~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "5"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "10000"                                                               // new XP value
"newhp"    = "128"                                                                 // new hit point value
"newac"    = "1"                                                                   // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "4"                                                                   // new Save vs. Death
"newsvw"   = "6"                                                                   // new Save vs. Wand
"newsvp"   = "5"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "7"                                                                   // new Save vs. Spell
"newmr"    = "25"                                                                  // new Magic Resistance value
"newlvl1"  = "16"                                                                  // new level (first class)
"newstr"   = "17"                                                                  // new Strength value
"newdex"   = "14"                                                                  // new Dexterity value
"newcon"   = "22"                                                                  // new Constitution value
"newint"   = "10"                                                                  // new Intelligence value
"newwis"   = "10"                                                                  // new Wisdom value
"newchr"   = "10"                                                                  // new Charisma value
"newmor"   = "18"                                                                  // new morale value
"newmorb"  = "2"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "255"                                                                 // new class (NO_CLASS)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EWAT"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "WTASIGHT"                                                          // generic AI script
"script04"   = "WDASIGHT"                                                          // generic AI script
"script05"   = "GENSHT01"                                                          // generic shout script
"script06"   = "dw#melee"                                                          // SCSII melee AI script
"script07"   = "BPWTASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LPF add_water_elemental_effects END
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Elder Water Elemental (20 HD)

COPY    ~atweaks/cre/elementals/rr#ewate.cre~ ~override~                           // Elder Water Elemental (hostile)
SAY NAME1 @2118 SAY NAME2 @2118 SAY SELECT_COMMON1 @471 SAY BATTLE_CRY1 @471 SAY BATTLE_CRY2 @472 SAY ATTACK1 @473 SAY ATTACK2 @474 SAY DAMAGE @475 SAY DYING @476 SAY SELECT_ACTION1 @477

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~rr#ewate~                                                             // Elder Water Elemental (aTweaks)
            li#druwa                                                               // Elemental transformation water (Refinements)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
REMOVE_CRE_EFFECTS
ADD_MEMORIZED_SPELL ~rr#ecncl~ #0 ~innate~ ( 1 )                                   // adds 1x Elemental Concealment
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
ADD_CRE_ITEM ~RR#DINV~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~AMULET~                 // item which makes creatures invisible and untargetable while they gate in
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "14000"                                                               // new XP value
"newhp"    = "160"                                                                 // new hit point value
"newac"    = "0"                                                                   // new Armor Class value
"newth"    = "1"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "5"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "6"                                                                   // new Save vs. Spell
"newmr"    = "50"                                                                  // new Magic Resistance value
"newlvl1"  = "20"                                                                  // new level (first class)
"newstr"   = "18"                                                                  // new Strength value
"newdex"   = "16"                                                                  // new Dexterity value
"newcon"   = "23"                                                                  // new Constitution value
"newint"   = "12"                                                                  // new Intelligence value
"newwis"   = "12"                                                                  // new Wisdom value
"newchr"   = "12"                                                                  // new Charisma value
"newmor"   = "19"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "255"                                                                 // new class (NO_CLASS)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
STR_VAR
  notenf01 = li#druwa
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EWAT"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
skipfile01   = li#druwa
END                                                                                // ends FUNCTION call
LPF add_water_elemental_effects END
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Ice Paraelemental (12 HD)

COPY    ~atweaks/cre/elementals/rr#eicer.cre~ ~override~                           // Ice Paraelemental (hostile)
SAY NAME1 @2120 SAY NAME2 @2120 SAY SELECT_COMMON1 @481 SAY BATTLE_CRY1 @481 SAY BATTLE_CRY2 @482 SAY ATTACK1 @483 SAY ATTACK2 @484 SAY DAMAGE @487 SAY HURT @488 SAY DYING @489 SAY SELECT_ACTION1 @482

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~rr#eicer~                                                             // Ice Paraelemental (aTweaks)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_CRE_ITEM ~RR#DINV~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~AMULET~                 // item which makes creatures invisible and untargetable while they gate in
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "5"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"newxpv"   = "11000"                                                               // new XP value
"newhp"    = "96"                                                                  // new hit point value
"newac"    = "3"                                                                   // new Armor Class value
"newth"    = "9"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "7"                                                                   // new Save vs. Death
"newsvw"   = "9"                                                                   // new Save vs. Wand
"newsvp"   = "8"                                                                   // new Save vs. Polymorph
"newsvb"   = "8"                                                                   // new Save vs. Breath
"newsvs"   = "10"                                                                  // new Save vs. Spell
"newfr"    = "-100"                                                                // new Resist Fire value
"newcr"    = "127"                                                                 // new Resist Cold value
"newlvl1"  = "12"                                                                  // new level (first class)
"newstr"   = "18"                                                                  // new Strength value
"newdex"   = "12"                                                                  // new Dexterity value
"newcon"   = "16"                                                                  // new Constitution value
"newint"   = "14"                                                                  // new Intelligence value
"newwis"   = "13"                                                                  // new Wisdom value
"newchr"   = "12"                                                                  // new Charisma value
"newmor"   = "16"                                                                  // new morale value
"newmorb"  = "2"                                                                   // new morale break value
"newmorr"  = "15"                                                                  // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "255"                                                                 // new class (NO_CLASS)
"newalign" = "34"                                                                  // new alignment (True Neutral)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EICE"                                                           // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION cold_spell_immunities END                                    // grant immunities to cold-based area effect spells
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Cryonax (24 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~elemcryo~                                                             // Cryonax
            ~finsol03~                                                             // Cryonax in ToB
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#ekal~  #0 ~innate~ ( 1 )                                   // adds 1x Know Alignment (renewable)
ADD_MEMORIZED_SPELL ~rr#wr302~ #0 ~innate~ ( 1 )                                   // adds 1x Remove Magic (renewable)
ADD_MEMORIZED_SPELL ~rr#ersug~ #0 ~innate~ ( 1 )                                   // adds 1x Suggestion (renewable)
ADD_MEMORIZED_SPELL ~rr#telwr~ #0 ~innate~ ( 1 )                                   // adds 1x Teleport Without Error (renewable)
ADD_MEMORIZED_SPELL ~rr#wi306~ #0 ~innate~ ( 3 )                                   // adds 3x Hold Person
ADD_MEMORIZED_SPELL ~rr#wi404~ #0 ~innate~ ( 3 )                                   // adds 3x Ice Storm
ADD_MEMORIZED_SPELL ~rr#wi503~ #0 ~innate~ ( 1 )                                   // adds 1x Cone of Cold
ADD_MEMORIZED_SPELL ~rr#icew~  #0 ~innate~ ( 3 )                                   // adds 3x Wall of Ice
ADD_MEMORIZED_SPELL ~rr#ecryo~ #0 ~innate~ ( 1 )                                   // adds 1x Summon Allies
REMOVE_CRE_ITEM ~ELEMPRIN~                                                         // Elemental Prince traits are handled differently
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#ECRYO~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
ADD_CRE_ITEM ~IMMUNE2~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                              // revise weapon immunities
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "7"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"rr#sinv"  = "1"                                                                   // See invisible creatures (1 = enable)
"newxpv"   = "28000"                                                               // new XP value
"newhp"    = "90"                                                                  // new hit point value
"newac"    = "-6"                                                                  // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "2"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "3"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "4"                                                                   // new Save vs. Spell
"newmr"    = "75"                                                                  // new Magic Resistance value
"newfr"    = "-50"                                                                 // new Resist Fire value
"newcr"    = "127"                                                                 // new Resist Cold value
"newlvl1"  = "24"                                                                  // new level (first class)
"newstr"   = "21"                                                                  // new Strength value
"newdex"   = "12"                                                                  // new Dexterity value
"newcon"   = "18"                                                                  // new Constitution value
"newint"   = "17"                                                                  // new Intelligence value
"newwis"   = "16"                                                                  // new Wisdom value
"newchr"   = "17"                                                                  // new Charisma value
"newmor"   = "20"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "1"                                                                   // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "255"                                                                 // new class (NO_CLASS)
"newgendr" = "1"                                                                   // new gender (MALE)
"newsex"   = "1"                                                                   // new sex (Male)
"newalign" = "35"                                                                  // new alignment (Neutral Evil)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#ECRYO"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "elemcryo"                                                          // original Cryonax script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "dw#melee"                                                          // SCSII melee AI script
"script06"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION petrification_immunity  END                                  // petrification immunity
LAUNCH_PATCH_FUNCTION cold_spell_immunities END                                    // grant immunities to cold-based area effect spells
LAUNCH_PATCH_FUNCTION clear_bg1_profs  END                                         // Clear BG1 proficiencies
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Imix (24 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~elemimix~                                                             // Imix
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#ekal~  #0 ~innate~ ( 1 )                                   // adds 1x Know Alignment (renewable)
ADD_MEMORIZED_SPELL ~rr#wr302~ #0 ~innate~ ( 1 )                                   // adds 1x Remove Magic (renewable)
ADD_MEMORIZED_SPELL ~rr#ersug~ #0 ~innate~ ( 1 )                                   // adds 1x Suggestion (renewable)
ADD_MEMORIZED_SPELL ~rr#telwr~ #0 ~innate~ ( 1 )                                   // adds 1x Teleport Without Error (renewable)
ADD_MEMORIZED_SPELL ~rr#pyrot~ #0 ~innate~ ( 3 )                                   // adds 3x Pyrotechnics
ADD_MEMORIZED_SPELL ~rr#eimfb~ #0 ~innate~ ( 1 )                                   // adds 1x Fireball (20d6)
ADD_MEMORIZED_SPELL ~rr#eimfs~ #0 ~innate~ ( 3 )                                   // adds 3x Fire Shield:Red, triple strength
ADD_MEMORIZED_SPELL ~rr#eimix~ #0 ~innate~ ( 1 )                                   // adds 1x Summon Allies
REMOVE_CRE_ITEM ~ELEMPRIN~                                                         // Elemental Prince traits are handled differently
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EIMIX~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
ADD_CRE_ITEM ~IMMUNE2~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                              // revise weapon immunities
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "14"                                                                  // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"rr#sinv"  = "1"                                                                   // See invisible creatures (1 = enable)
"newxpv"   = "25000"                                                               // new XP value
"newhp"    = "90"                                                                  // new hit point value
"newac"    = "-4"                                                                  // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "3"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "4"                                                                   // new Save vs. Spell
"newmr"    = "85"                                                                  // new Magic Resistance value
"newfr"    = "100"                                                                 // new Resist Fire value
"newcr"    = "-50"                                                                 // new Resist Cold value
"newlvl1"  = "24"                                                                  // new level (first class)
"newstr"   = "17"                                                                  // new Strength value
"newdex"   = "19"                                                                  // new Dexterity value
"newcon"   = "17"                                                                  // new Constitution value
"newint"   = "18"                                                                  // new Intelligence value
"newwis"   = "16"                                                                  // new Wisdom value
"newchr"   = "17"                                                                  // new Charisma value
"newmor"   = "20"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "1"                                                                   // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "187"                                                                 // new class (ELEMENTAL_FIRE)
"newgendr" = "1"                                                                   // new gender (MALE)
"newsex"   = "1"                                                                   // new sex (Male)
"newalign" = "35"                                                                  // new alignment (Neutral Evil)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EIMIX"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "elemimix"                                                          // original Imix script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "dw#melee"                                                          // SCSII melee AI script
"script06"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~ INT_VAR opcode_to_delete = "101" END     // remove spurious opcode protections
LAUNCH_PATCH_FUNCTION petrification_immunity END                                   // petrification immunity
LAUNCH_PATCH_FUNCTION fire_spell_immunities END                                    // grant immunities to fire-based area effect spells
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
LAUNCH_PATCH_FUNCTION clear_bg1_profs END                                          // Clear BG1 proficiencies
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Ogremoch (24 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~elemogre~                                                             // Ogremoch
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#ekal~  #0 ~innate~ ( 1 )                                   // adds 1x Know Alignment (renewable)
ADD_MEMORIZED_SPELL ~rr#wr302~ #0 ~innate~ ( 1 )                                   // adds 1x Remove Magic (renewable)
ADD_MEMORIZED_SPELL ~rr#ersug~ #0 ~innate~ ( 1 )                                   // adds 1x Suggestion (renewable)
ADD_MEMORIZED_SPELL ~rr#telwr~ #0 ~innate~ ( 1 )                                   // adds 1x Teleport Without Error (renewable)
ADD_MEMORIZED_SPELL ~rr#equa~  #0 ~innate~ ( 1 )                                   // adds 1x Earthquake
ADD_MEMORIZED_SPELL ~rr#wi408~ #0 ~innate~ ( 3 )                                   // adds 3x Stoneskin
ADD_MEMORIZED_SPELL ~rr#wi604~ #0 ~innate~ ( 3 )                                   // adds 3x Flesh to Stone
ADD_MEMORIZED_SPELL ~rr#eogre~ #0 ~innate~ ( 1 )                                   // adds 1x Summon Allies
REMOVE_CRE_ITEM ~ELEMPRIN~                                                         // Elemental Prince traits are handled differently
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EOGRE~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
ADD_CRE_ITEM ~IMMUNE3~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                              // revise weapon immunities
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "7"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"rr#sinv"  = "1"                                                                   // See invisible creatures (1 = enable)
"newxpv"   = "28000"                                                               // new XP value
"newhp"    = "110"                                                                 // new hit point value
"newac"    = "-7"                                                                  // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "2"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "3"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "4"                                                                   // new Save vs. Spell
"newmr"    = "85"                                                                  // new Magic Resistance value
"newfr"    = "100"                                                                 // new Resist Fire value
"newcr"    = "50"                                                                  // new Resist Cold value
"newer"    = "50"                                                                  // new Resist Electricity value
"newlvl1"  = "24"                                                                  // new level (first class)
"newstr"   = "25"                                                                  // new Strength value
"newdex"   = "12"                                                                  // new Dexterity value
"newcon"   = "20"                                                                  // new Constitution value
"newint"   = "16"                                                                  // new Intelligence value
"newwis"   = "16"                                                                  // new Wisdom value
"newchr"   = "16"                                                                  // new Charisma value
"newmor"   = "20"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "1"                                                                   // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "188"                                                                 // new class (ELEMENTAL_EARTH)
"newgendr" = "1"                                                                   // new gender (MALE)
"newsex"   = "1"                                                                   // new sex (Male)
"newalign" = "35"                                                                  // new alignment (Neutral Evil)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EOGRE"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "elemogre"                                                          // original Ogremoch script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "dw#melee"                                                          // SCSII melee AI script
"script06"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~ INT_VAR opcode_to_delete = "101" END     // remove spurious opcode protections
LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~ INT_VAR opcode_to_delete = "16" END      // remove spurious haste opcode
LAUNCH_PATCH_FUNCTION earth_affinity END                                           // apply earth affinity traits
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
LAUNCH_PATCH_FUNCTION fire_spell_immunities END                                    // grant immunities to fire-based area effect spells
LAUNCH_PATCH_FUNCTION clear_bg1_profs END                                          // Clear BG1 proficiencies
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Olhydra (24 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~elemhydr~                                                             // Olhydra
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#ekal~  #0 ~innate~ ( 1 )                                   // adds 1x Know Alignment (renewable)
ADD_MEMORIZED_SPELL ~rr#wr302~ #0 ~innate~ ( 1 )                                   // adds 1x Remove Magic (renewable)
ADD_MEMORIZED_SPELL ~rr#ersug~ #0 ~innate~ ( 1 )                                   // adds 1x Suggestion (renewable)
ADD_MEMORIZED_SPELL ~rr#telwr~ #0 ~innate~ ( 1 )                                   // adds 1x Teleport Without Error (renewable)
ADD_MEMORIZED_SPELL ~rr#ehyis~ #0 ~innate~ ( 3 )                                   // adds 3x Ice Storm (Olhydra's version)
ADD_MEMORIZED_SPELL ~rr#mmswf~ #0 ~innate~ ( 3 )                                   // adds 3x Wall of Fog
ADD_MEMORIZED_SPELL ~rr#ehydr~ #0 ~innate~ ( 1 )                                   // adds 1x Summon Allies
REMOVE_CRE_ITEM ~WALLPASS~                                                         // remove wallpass item
REMOVE_CRE_ITEM ~ELEMPRIN~                                                         // Elemental Prince traits are handled differently
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EHYDR~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
ADD_CRE_ITEM ~IMMUNE1~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                              // revise weapon immunities
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "5"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"rr#sinv"  = "1"                                                                   // See invisible creatures (1 = enable)
"newxpv"   = "28000"                                                               // new XP value
"newhp"    = "90"                                                                  // new hit point value
"newac"    = "-6"                                                                  // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "1"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "3"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "4"                                                                   // new Save vs. Spell
"newmr"    = "70"                                                                  // new Magic Resistance value
"newfr"    = "-50"                                                                 // new Resist Fire value
"newcr"    = "100"                                                                 // new Resist Cold value
"newrs"    = "50"                                                                  // new Resist Slashing
"newlvl1"  = "24"                                                                  // new level (first class)
"newstr"   = "20"                                                                  // new Strength value
"newdex"   = "18"                                                                  // new Dexterity value
"newcon"   = "24"                                                                  // new Constitution value
"newint"   = "18"                                                                  // new Intelligence value
"newwis"   = "16"                                                                  // new Wisdom value
"newchr"   = "17"                                                                  // new Charisma value
"newmor"   = "20"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "1"                                                                   // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "255"                                                                 // new class (NO_CLASS)
"newgendr" = "2"                                                                   // new gender (FEMALE)
"newsex"   = "2"                                                                   // new sex (Female)
"newalign" = "35"                                                                  // new alignment (Neutral Evil)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EHYDR"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "elemhydr"                                                          // original Olhydra script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "dw#melee"                                                          // SCSII melee AI script
"script06"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~ INT_VAR opcode_to_delete = "101" END     // remove spurious opcode protections
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
LAUNCH_PATCH_FUNCTION clear_bg1_profs END                                          // Clear BG1 proficiencies
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Yan-C-Bin (24 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~elemyanc~                                                             // Yan-C-Bin
            ~finsol02~                                                             // Yan-C-Bin in ToB
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#ekal~  #0 ~innate~ ( 1 )                                   // adds 1x Know Alignment (renewable)
ADD_MEMORIZED_SPELL ~rr#wr302~ #0 ~innate~ ( 1 )                                   // adds 1x Remove Magic (renewable)
ADD_MEMORIZED_SPELL ~rr#ersug~ #0 ~innate~ ( 1 )                                   // adds 1x Suggestion (renewable)
ADD_MEMORIZED_SPELL ~rr#telwr~ #0 ~innate~ ( 1 )                                   // adds 1x Teleport Without Error (renewable)
ADD_MEMORIZED_SPELL ~rr#eairw~ #0 ~innate~ ( 1 )                                   // adds 1x Air Elemental Whirlwind
ADD_MEMORIZED_SPELL ~rr#eyanc~ #0 ~innate~ ( 1 )                                   // adds 1x Summon Allies
REMOVE_CRE_ITEM ~ELEMPRIN~                                                         // Elemental Prince traits are handled differently
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EYANC~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
ADD_CRE_ITEM ~IMMUNE2~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                              // revise weapon immunities
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "48"                                                                  // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"rr#sinv"  = "1"                                                                   // See invisible creatures (1 = enable)
"newxpv"   = "28000"                                                               // new XP value
"newhp"    = "85"                                                                  // new hit point value
"newac"    = "-6"                                                                  // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "2"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "3"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "4"                                                                   // new Save vs. Spell
"newmr"    = "90"                                                                  // new Magic Resistance value
"newfr"    = "-25"                                                                 // new Resist Fire value
"newer"    = "100"                                                                 // new Resist Electricity value
"newrm"    = "100"                                                                 // new Resist Missiles
"newlvl1"  = "24"                                                                  // new level (first class)
"newstr"   = "16"                                                                  // new Strength value
"newdex"   = "24"                                                                  // new Dexterity value
"newcon"   = "18"                                                                  // new Constitution value
"newint"   = "17"                                                                  // new Intelligence value
"newwis"   = "17"                                                                  // new Wisdom value
"newchr"   = "17"                                                                  // new Charisma value
"newmor"   = "20"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "1"                                                                   // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "186"                                                                 // new class (ELEMENTAL_AIR)
"newgendr" = "1"                                                                   // new gender (MALE)
"newsex"   = "1"                                                                   // new sex (Male)
"newalign" = "35"                                                                  // new alignment (Neutral Evil)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EYANC"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "elemyanc"                                                          // original Yan-C-Bin script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "dw#melee"                                                          // SCSII melee AI script
"script06"   = "BPWDASGT"                                                          // Big Picture generic AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~ INT_VAR opcode_to_delete = "101" END     // remove spurious opcode protections
LAUNCH_PATCH_FUNCTION clear_bg1_profs END                                          // Clear BG1 proficiencies
LAUNCH_PATCH_FUNCTION hover_immunities END                                         // grant immunities to ground-based spells
LAUNCH_PATCH_FUNCTION air_affinity END                                             // grant air affinity bonuses
LAUNCH_PATCH_FUNCTION petrification_immunity END                                   // petrification immunity
LAUNCH_PATCH_FUNCTION missile_weapon_immunity END                                  // missile weapon immunity
LAUNCH_PATCH_FUNCTION cloud_spell_immunities END                                   // grant immunities to gas-based area effect spells
WRITE_SHORT 0x4c "-99"                                                             // special case, AC vs. missile weapons modifier
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Chan (24 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~elemchan~                                                             // Chan
            dw#echan                                                               // SCSII Chan-alternative from "Smarter Priests"
                                                                                   // The seeming conflict between the aTweaks script and the dw#echan
                                                                                   // script should be avoided due to both scripts using the same local
                                                                                   // variable
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#ekal~  #0 ~innate~ ( 1 )                                   // adds 1x Know Alignment (renewable)
ADD_MEMORIZED_SPELL ~rr#wr302~ #0 ~innate~ ( 1 )                                   // adds 1x Remove Magic (renewable)
ADD_MEMORIZED_SPELL ~rr#ersug~ #0 ~innate~ ( 1 )                                   // adds 1x Suggestion (renewable)
ADD_MEMORIZED_SPELL ~rr#telwr~ #0 ~innate~ ( 1 )                                   // adds 1x Teleport Without Error (renewable)
ADD_MEMORIZED_SPELL ~rr#eairw~ #0 ~innate~ ( 1 )                                   // adds 1x Air Elemental Whirlwind
ADD_MEMORIZED_SPELL ~rr#echww~ #0 ~innate~ ( 3 )                                   // adds 3x Wind Wall
ADD_MEMORIZED_SPELL ~rr#echsf~ #0 ~innate~ ( 3 )                                   // adds 3x Solid Fog
ADD_MEMORIZED_SPELL ~rr#maigw~ #0 ~innate~ ( 3 )                                   // adds 3x Gust of Wind
ADD_MEMORIZED_SPELL ~rr#wi213~ #0 ~innate~ ( 3 )                                   // adds 3x Stinking Cloud
ADD_MEMORIZED_SPELL ~rr#wi502~ #0 ~innate~ ( 3 )                                   // adds 3x Cloudkill
ADD_MEMORIZED_SPELL ~rr#echan~ #0 ~innate~ ( 1 )                                   // adds 1x Summon Allies (Chan)
REMOVE_CRE_ITEM ~ELEMPRIN~                                                         // Elemental Prince traits are handled differently
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#ECHAN~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
ADD_CRE_ITEM ~IMMUNE2~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                              // revise weapon immunities
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "48"                                                                  // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"rr#sinv"  = "1"                                                                   // See invisible creatures (1 = enable)
"newxpv"   = "28000"                                                               // new XP value
"newhp"    = "90"                                                                  // new hit point value
"newac"    = "-6"                                                                  // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "2"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "3"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "4"                                                                   // new Save vs. Spell
"newmr"    = "85"                                                                  // new Magic Resistance value
"newer"    = "100"                                                                 // new Resist Electricity value
"newlvl1"  = "24"                                                                  // new level (first class)
"newstr"   = "16"                                                                  // new Strength value
"newdex"   = "24"                                                                  // new Dexterity value
"newcon"   = "18"                                                                  // new Constitution value
"newint"   = "17"                                                                  // new Intelligence value
"newwis"   = "17"                                                                  // new Wisdom value
"newchr"   = "18"                                                                  // new Charisma value
"newmor"   = "20"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "1"                                                                   // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "186"                                                                 // new class (ELEMENTAL_AIR)
"newgendr" = "2"                                                                   // new gender (FEMALE)
"newsex"   = "2"                                                                   // new sex (Female)
"newalign" = "33"                                                                  // new alignment (Neutral Good)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#ECHAN"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "elemchan"                                                          // original Chan script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "dw#melee"                                                          // SCSII melee AI script
"script06"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script07"   = "DVMELEE"                                                           // Spell Revisions melee AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~ INT_VAR opcode_to_delete = "101" END     // remove spurious opcode protections
LAUNCH_PATCH_FUNCTION clear_bg1_profs END                                          // Clear BG1 proficiencies
LAUNCH_PATCH_FUNCTION hover_immunities END                                         // grant immunities to ground-based spells
LAUNCH_PATCH_FUNCTION air_affinity END                                             // grant air affinity bonuses
LAUNCH_PATCH_FUNCTION petrification_immunity END                                   // petrification immunity
LAUNCH_PATCH_FUNCTION cloud_spell_immunities END                                   // grant immunities to gas-based area effect spells
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Sunnis (24 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~elemsunn~                                                             // Sunnis
            dw#esunn                                                               // SCSII Sunnis-alternative from "Smarter Priests"
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#ekal~  #0 ~innate~ ( 1 )                                   // adds 1x Know Alignment (renewable)
ADD_MEMORIZED_SPELL ~rr#wr302~ #0 ~innate~ ( 1 )                                   // adds 1x Remove Magic (renewable)
ADD_MEMORIZED_SPELL ~rr#ersug~ #0 ~innate~ ( 1 )                                   // adds 1x Suggestion (renewable)
ADD_MEMORIZED_SPELL ~rr#telwr~ #0 ~innate~ ( 1 )                                   // adds 1x Teleport Without Error (renewable)
ADD_MEMORIZED_SPELL ~rr#esuis~ #0 ~innate~ ( 4 )                                   // adds 4x Iron Skins
ADD_MEMORIZED_SPELL ~rr#wi625~ #0 ~innate~ ( 3 )                                   // adds 3x Stone to Flesh
ADD_MEMORIZED_SPELL ~rr#esunn~ #0 ~innate~ ( 1 )                                   // adds 1x Summon Allies (Sunnis)
REMOVE_CRE_ITEM ~ELEMPRIN~                                                         // Elemental Prince traits are handled differently
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#ESUNN~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
ADD_CRE_ITEM ~IMMUNE2~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                              // revise weapon immunities
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"newmove"  = "7"                                                                   // new movement rate
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"rr#sinv"  = "1"                                                                   // See invisible creatures (1 = enable)
"newxpv"   = "29000"                                                               // new XP value
"newhp"    = "115"                                                                 // new hit point value
"newac"    = "-7"                                                                  // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "2"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "3"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "4"                                                                   // new Save vs. Spell
"newmr"    = "70"                                                                  // new Magic Resistance value
"newfr"    = "100"                                                                 // new Resist Fire value
"newcr"    = "50"                                                                  // new Resist Cold value
"newer"    = "50"                                                                  // new Resist Electricity value
"newlvl1"  = "24"                                                                  // new level (first class)
"newstr"   = "24"                                                                  // new Strength value
"newdex"   = "13"                                                                  // new Dexterity value
"newcon"   = "21"                                                                  // new Constitution value
"newint"   = "16"                                                                  // new Intelligence value
"newwis"   = "16"                                                                  // new Wisdom value
"newchr"   = "17"                                                                  // new Charisma value
"newmor"   = "20"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "1"                                                                   // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "188"                                                                 // new class (ELEMENTAL_EARTH)
"newgendr" = "2"                                                                   // new gender (FEMALE)
"newsex"   = "2"                                                                   // new sex (Female)
"newalign" = "33"                                                                  // new alignment (Neutral Good)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#ESUNN"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "elemsunn"                                                          // original Sunnis script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "dw#melee"                                                          // SCSII melee AI script
"script06"   = "BPWTSIGT"                                                          // Big Picture generic AI script
"script07"   = "DVMELEE"                                                           // Spell Revisions melee AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~ INT_VAR opcode_to_delete = "101" END     // remove spurious opcode protections
LAUNCH_PATCH_FUNCTION clear_bg1_profs END                                          // Clear BG1 proficiencies
LAUNCH_PATCH_FUNCTION earth_affinity END                                           // apply earth affinity traits
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
LAUNCH_PATCH_FUNCTION petrification_immunity END                                   // petrification immunity
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Zaaman Rul (24 HD)

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~elemzaam~                                                             // Zaaman Rul
            dw#ezaam                                                               // SCSII alternative from "Smarter Priests"
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the file exists
COPY_EXISTING ~%file%.cre~ ~override~
LAUNCH_PATCH_FUNCTION FJ_CRE_VALIDITY INT_VAR do_message = 1 END                   // Nythrun's CRE validity macro (detects corrupt and invalid CREs)
// =============================================================================== // the actual work starts from here
REMOVE_KNOWN_SPELLS                                                                // Remove all known spells from the current creature
REMOVE_MEMORIZED_SPELLS                                                            // Remove all memorized spells from the current creature
ADD_MEMORIZED_SPELL ~rr#ekal~  #0 ~innate~ ( 1 )                                   // adds 1x Know Alignment (renewable)
ADD_MEMORIZED_SPELL ~rr#wr302~ #0 ~innate~ ( 1 )                                   // adds 1x Remove Magic (renewable)
ADD_MEMORIZED_SPELL ~rr#ersug~ #0 ~innate~ ( 1 )                                   // adds 1x Suggestion (renewable)
ADD_MEMORIZED_SPELL ~rr#telwr~ #0 ~innate~ ( 1 )                                   // adds 1x Teleport Without Error (renewable)
ADD_MEMORIZED_SPELL ~rr#ezafb~ #0 ~innate~ ( 3 )                                   // adds 3x Fireball (12d6)
ADD_MEMORIZED_SPELL ~rr#ezafa~ #0 ~innate~ ( 3 )                                   // adds 3x Flame Arrow, double damage
ADD_MEMORIZED_SPELL ~rr#ezafs~ #0 ~innate~ ( 3 )                                   // adds 3x Fire Shield:Red, double strength
ADD_MEMORIZED_SPELL ~rr#ezaam~ #0 ~innate~ ( 1 )                                   // adds 1x Summon Allies (Zaaman Rul)
REMOVE_CRE_ITEM ~ELEMPRIN~                                                         // Elemental Prince traits are handled differently
ADD_CRE_ITEM ~RR#ETRAI~ #0 #0 #0 ~UNDROPPABLE~ ~HELMET~                            // add elemental traits
REPLACE_CRE_ITEM ~RR#EZAAM~ #0 #0 #0 ~UNDROPPABLE~ ~WEAPON1~ EQUIP                 // replace default weapon with a more PnP accurate weapon
ADD_CRE_ITEM ~IMMUNE2~ #0 #0 #0 ~UNDROPPABLE~ ~LRING~                              // revise weapon immunities
REMOVE_CRE_ITEM ~ELEMTYPE~                                                         // remove Spell Revisions' elemental traits
LAUNCH_PATCH_FUNCTION ~RR#MDCRE~                                                   // Starts FUNCTION call (aTweaks' Creature Modification function)
INT_VAR                                                                            // Initialize variables
"rr#bump"  = "1"                                                                   // NPC bump (1 = enable)
"rr#sinv"  = "1"                                                                   // See invisible creatures (1 = enable)
"newxpv"   = "29000"                                                               // new XP value
"newhp"    = "115"                                                                 // new hit point value
"newac"    = "-3"                                                                  // new Armor Class value
"newth"    = "5"                                                                   // new THAC0 value
"newapr"   = "2"                                                                   // new number of attacks per round
"newsvd"   = "3"                                                                   // new Save vs. Death
"newsvw"   = "3"                                                                   // new Save vs. Wand
"newsvp"   = "4"                                                                   // new Save vs. Polymorph
"newsvb"   = "4"                                                                   // new Save vs. Breath
"newsvs"   = "4"                                                                   // new Save vs. Spell
"newmr"    = "60"                                                                  // new Magic Resistance value
"newfr"    = "100"                                                                 // new Resist Fire value
"newcr"    = "-50"                                                                 // new Resist Cold value
"newlvl1"  = "24"                                                                  // new level (first class)
"newstr"   = "16"                                                                  // new Strength value
"newdex"   = "17"                                                                  // new Dexterity value
"newcon"   = "16"                                                                  // new Constitution value
"newint"   = "18"                                                                  // new Intelligence value
"newwis"   = "16"                                                                  // new Wisdom value
"newchr"   = "17"                                                                  // new Charisma value
"newmor"   = "20"                                                                  // new morale value
"newmorb"  = "1"                                                                   // new morale break value
"newmorr"  = "1"                                                                   // new morale recovery value
"newgen"   = "5"                                                                   // new general (GIANT HUMANOID)
"newrace"  = "145"                                                                 // new race (ELEMENTAL)
"newclass" = "187"                                                                 // new class (ELEMENTAL_FIRE)
"newgendr" = "1"                                                                   // new gender (MALE)
"newsex"   = "1"                                                                   // new sex (Male)
"newalign" = "33"                                                                  // new alignment (Neutral Good)
"enforce"  = "1"                                                                   // values are enforced for all creatures
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~RR#MDCSC~                                                   // Starts FUNCTION call (aTweaks' Creature Script Modification function)
STR_VAR                                                                            // Initialize strings
"newscript"  = "RR#EZAAM"                                                          // new AI script
"script01"   = ""                                                                  // first AI script name
"script02"   = "None"                                                              // second AI script name
"script03"   = "elemzaam"                                                          // original Zaaman Rul script
"script04"   = "WTASIGHT"                                                          // generic AI script
"script05"   = "dw#melee"                                                          // SCSII melee AI script
"script06"   = "WGARSGT"                                                           // Big Picture generic AI script
"script07"   = "DVMELEE"                                                           // Spell Revisions melee AI script
END                                                                                // ends FUNCTION call
LAUNCH_PATCH_FUNCTION ~DELETE_CRE_EFFECT~ INT_VAR opcode_to_delete = "101" END     // remove spurious opcode protections
LAUNCH_PATCH_FUNCTION fire_spell_immunities END                                    // grant immunities to fire-based area effect spells
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects
LAUNCH_PATCH_FUNCTION clear_bg1_profs END                                          // Clear BG1 proficiencies
// =============================================================================== // the actual work ends here
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block



ACTION_IF FILE_EXISTS_IN_GAME li#eltr.spl BEGIN
  //Patch up Refinements' druid elemental shapes to be roughly on par with atweaks'
  COPY_EXISTING li#druwa.itm override
    LPF DELETE_ITEM_EQEFFECT INT_VAR opcode_to_delete = 126 END //Remove movement rate penalty
    PATCH_FOR_EACH resource IN RR#MMSWF RR#EHYIS BEGIN //Add spell immunities
      LPF ADD_SPELL_EFFECT
        INT_VAR
          opcode = 206
          target = 1
          timing = 2
        STR_VAR
          resource
      END
    END
  BUT_ONLY
END


//////////////////
// New AI Scripts
//////////////////


COMPILE ~atweaks/baf/elementals/rr#easer.baf~                                      // Aerial Servant AI script
COMPILE ~atweaks/baf/elementals/rr#efsal.baf~                                      // Fire Salamander AI script
COMPILE ~atweaks/baf/elementals/rr#efrsa.baf~                                      // Frost Salamander AI script
COMPILE ~atweaks/baf/elementals/rr#eista.baf~                                      // Invisible Stalker AI script
COMPILE ~atweaks/baf/elementals/rr#enere.baf~                                      // Nereid AI script
COMPILE ~atweaks/baf/elementals/rr#ensal.baf~                                      // Salamander Noble AI script
COMPILE ~atweaks/baf/elementals/rr#ewwei.baf~                                      // Water Weird AI script
COMPILE ~atweaks/baf/elementals/rr#eair.baf~                                       // Air Elemental AI script
COMPILE ~atweaks/baf/elementals/rr#eear.baf~                                       // Earth Elemental AI script
COMPILE ~atweaks/baf/elementals/rr#efir.baf~                                       // Fire Elemental AI script
COMPILE ~atweaks/baf/elementals/rr#ewat.baf~                                       // Water Elemental AI script
COMPILE ~atweaks/baf/elementals/rr#eice.baf~                                       // Ice Paraelemental AI script
COMPILE ~atweaks/baf/elementals/rr#ecryo.baf~                                      // Cryonax AI script
COMPILE ~atweaks/baf/elementals/rr#eimix.baf~                                      // Imix AI script
COMPILE ~atweaks/baf/elementals/rr#eogre.baf~                                      // Ogremoch AI script
COMPILE ~atweaks/baf/elementals/rr#ehydr.baf~                                      // Olhydra AI script
COMPILE ~atweaks/baf/elementals/rr#eyanc.baf~                                      // Yan-C-Bin AI script
COMPILE ~atweaks/baf/elementals/rr#echan.baf~                                      // Chan AI script
COMPILE ~atweaks/baf/elementals/rr#esunn.baf~                                      // Sunnis AI script
COMPILE ~atweaks/baf/elementals/rr#ezaam.baf~                                      // Zaaman Rul AI script
COMPILE ~atweaks/baf/elementals/rr#ewizs.baf~                                      // Mental Combat AI script (for elementals summoned by arcane spellcasters)






////////////////////
// Revised spells //
////////////////////

// Make shapechange spells grant the proper elemental traits

COPY ~atweaks/itm/elementals/rr#eshfe.itm~ ~override~                              // Druid Fire Elemental transformation attack
     ~atweaks/itm/elementals/rr#eshfr.itm~ ~override~                              // Shapechange Fire Elemental attack
     ~atweaks/itm/elementals/rr#eshee.itm~ ~override~                              // Druid Earth Elemental transformation attack
     ~atweaks/itm/elementals/rr#esher.itm~ ~override~                              // Shapechange Earth Elemental attack
LAUNCH_PATCH_FUNCTION ~extraplanar_traits~ END                                     // add extraplanar traits
LAUNCH_PATCH_FUNCTION ~bleeding_immunity~ END                                      // add bleeding immunity
LAUNCH_PATCH_FUNCTION ~disease_immunity~ END                                       // add disease immunity
LAUNCH_PATCH_FUNCTION ~poison_immunity~ END                                        // add poison immunity
LAUNCH_PATCH_FUNCTION ~poison_spell_immunities~ END                                // add immunity to poison-based spells
LAUNCH_PATCH_FUNCTION ~insect_spell_immunities~ END                                // add immunity to insect spells
LAUNCH_PATCH_FUNCTION ~hold_immunity~ END                                          // add hold immunity
LAUNCH_PATCH_FUNCTION ~stun_immunity~ END                                          // add stun immunity
LAUNCH_PATCH_FUNCTION ~sleep_immunity~ END                                         // add sleep immunity
PATCH_FOR_EACH ~spell~ IN                                                          // creatures without flesh shouldn't be affected by the Flesh to Stone spell
             ~SPWI604~                                                             // Flesh to Stone (wizard version)
             ~SPIN984~                                                             // Flesh to Stone (Beholder ray)
            ~RR#WI604~                                                             // Flesh to Stone (aTweaks)
BEGIN                                                                              // execute the following
  LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EQEFFECT~                                        // Starts FUNCTION call
  INT_VAR                                                                          // initialize variables
    "opcode" = "206"                                                               // effect: #206 (Protection from Spell)
    "target" = "1"                                                                 // target: 1 (self)
    "timing" = "2"                                                                 // timing mode: 2 (while equipped)
    "parameter1" = "4742"                                                          // param1: string (Spell Ineffective)
    "duration" = "0"                                                               // duration: 0
    "sectype" = "0"                                                                // secondary type: none
    "probability1" = "100"                                                         // probability1: 100%
  STR_VAR                                                                          // initialize strings
    "resource"  = EVALUATE_BUFFER "%spell%"                                        // resref: the current spell
    "effsource" = ""                                                               // effsource: none
  END                                                                              // ends LAUNCH_PATCH_FUNCTION
END                                                                                // ends PATCH_FOR_EACH

COPY_EXISTING ~rr#eshfe.itm~ ~override~                                            // Druid Fire Elemental transformation attack
              ~rr#eshfr.itm~ ~override~                                            // Shapechange Fire Elemental attack
LAUNCH_PATCH_FUNCTION fire_spell_immunities END                                    // grant immunities to fire-based area effect spells
LAUNCH_PATCH_FUNCTION entangle_immunities END                                      // grant immunity to entangle spells
LAUNCH_PATCH_FUNCTION web_immunity END                                             // grant immunity to web spells and effects


COPY ~atweaks/itm/elementals/rr#eshsa.itm~ ~override~                              // Avenger kit Fire Salamander transformation attack
LAUNCH_PATCH_FUNCTION ~extraplanar_traits~ END                                     // add extraplanar traits
LAUNCH_PATCH_FUNCTION fire_salamander_immunities END                               // grant fire salamander immunities
LAUNCH_PATCH_FUNCTION fire_spell_immunities END                                    // grant immunities to fire-based area effect spells


ACTION_FOR_EACH file IN
                sppr731                                             // Fire Elemental Transformation
                spin156                                             // Shapechange Fire Elemental
                spin157                                             // Shapechange Earth Elemental
                spcl634                                             // Shapeshifts Fire Salamander
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.spl~ BEGIN
    COPY_EXISTING ~%file%.spl~ override
      READ_LONG  0x64 "abil_off"
      READ_SHORT 0x68 "abil_num"
      READ_LONG  0x6a "fx_off"
      FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN // cycle through abilities
        READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
        READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
        FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
          READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
          READ_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "resref"
          PATCH_IF ("%opcode%" = 111 AND "%resref%" STRING_EQUAL_CASE ~DRUFIR~) BEGIN  // effect #111: Create Magical Weapon
            WRITE_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "rr#eshfe" #8 // use aTweaks' item
          END
          PATCH_IF ("%opcode%" = 111 AND "%resref%" STRING_EQUAL_CASE ~FIRERN~) BEGIN  // effect #111: Create Magical Weapon
            WRITE_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "rr#eshfr" #8 // use aTweaks' item
          END
          PATCH_IF ("%opcode%" = 111 AND "%resref%" STRING_EQUAL_CASE ~EARTHRN~) BEGIN  // effect #111: Create Magical Weapon
            WRITE_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "rr#esher" #8 // use aTweaks' item
          END
          PATCH_IF ("%opcode%" = 111 AND ("%resref%" STRING_EQUAL_CASE ~PLYSALA~ OR      // effect #111: Create Magical Weapon
                    "%resref%" STRING_EQUAL_CASE LI#PLSAL))
          BEGIN  //Refinements, shapeshifting fix (we don't bother with replicating the auto-recreating items, because it is a lot of work and the user will very likely have ToBEx or eq.)
            WRITE_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "rr#eshsa" #8 // use aTweaks' item
          END
        END
      END
    BUT_ONLY
  END
END


// Remove Breathe Fireball ability from Fire Salamanders

COPY_EXISTING ~spcl634.spl~ ~override~                                             // Shapeshifts Fire Salamander
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  SET "delta" = 0
  FOR ("index" = 0; "%index%" < "%abil_num%"; "index" = ("%index%" + 1)) BEGIN // loop through abilities
    READ_SHORT  ("%abil_off%" + 0x1e + ("%index%" * 0x28)) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + ("%index%" * 0x28)) "abil_fx_idx"
    SET "abil_fx_idx" = ("%abil_fx_idx%" + "%delta%")
    WRITE_SHORT ("%abil_off%" + 0x20 + ("%index%" * 0x28)) "abil_fx_idx"
    FOR ("index2" = 0; "%index2%" < "%abil_fx_num%"; "index2" = ("%index2%" + 1)) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "opcode"
      READ_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%abil_fx_idx%" + "%index2%"))) "resref"
      PATCH_IF ((("%opcode%" = 171) OR ("%opcode%" = 172)) AND ("%resref%" STRING_EQUAL_CASE ~SPIN160~)) BEGIN  // effect #171 or #171
        DELETE_BYTES ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) 0x30 // delete effect
        SET "abil_fx_num" = ("%abil_fx_num%" - 1)
        SET "index2" = ("%index2%" - 1)
        SET "delta" = ("%delta%" - 1)
      END
    END
    WRITE_SHORT ("%abil_off%" + 0x1e + ("%index%" * 0x28)) "%abil_fx_num%"
  END
  BUT_ONLY_IF_IT_CHANGES


ACTION_IF FILE_EXISTS_IN_GAME ssppr732.spl BEGIN
COPY_EXISTING ~sppr732.spl~ ~override~                                             // Earth Elemental Transformation
READ_LONG  0x64 "abil_off"
READ_SHORT 0x68 "abil_num"
READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN // cycle through abilities
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "resref"
      PATCH_IF ("%opcode%" = 111 AND "%resref%" STRING_EQUAL_CASE ~DRUEAR~) BEGIN  // effect #111: Create Magical Weapon
       WRITE_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "rr#eshee" #8 // use aTweaks' item
      END
    END
  END
LAUNCH_PATCH_FUNCTION ~ADD_SPELL_EFFECT~                                           // Start FUNCTION call (add Spell Effect)
  INT_VAR                                                                          // initialize variables
    "opcode" = "171"                                                               // effect: #171 (Give Innate Ability)
    "target" = "1"                                                                 // target: 1 (self)
    "timing" = "0"                                                                 // timing mode: 0 (duration)
    "probability1" = "100"                                                         // probability1: 100%
    "duration" = "3600000"                                                         // duration
    "sectype" = "0"                                                                // secondary type: none
  STR_VAR
    "resource"  = "rr#equa"                                                        // resref
    "effsource" = ""                                                               // effsource: none
END                                                                                // ends LAUNCH_PATCH_FUNCTION
END



// Make sure the aTweaks' weapons and special abilities are removed when shapeshifing back to natural form
// Note: it appears that opcode #172 won't remove spells that have more than 7 characters in their filename

COPY_EXISTING ~spinhum.spl~ ~override~                                             // Shapeshifts Natural Form
PATCH_FOR_EACH ~weapon~ IN                                                         // grant the following innate abilities
             ~rr#eshee~                                                            // Elder Earth Elemental
             ~rr#eshfe~                                                            // Elder Fire Elemental
BEGIN
LAUNCH_PATCH_FUNCTION ~ADD_SPELL_EFFECT~                                           // Start FUNCTION call (add Spell Effect)
  INT_VAR                                                                          // initialize variables
    "opcode" = "112"                                                               // effect: #112 (Remove Item)
    "target" = "1"                                                                 // target: 1 (self)
    "timing" = "1"                                                                 // timing mode: 1 (permanent)
    "duration" = "0"                                                               // duration: 0
    "sectype" = "0"                                                                // secondary type: none
    "probability1" = "100"                                                         // probability1: 100%
  STR_VAR
    "resource"  = EVALUATE_BUFFER "%weapon%"                                       // resref
    "effsource" = ""                                                               // effsource: none
END                                                                                // ends LAUNCH_PATCH_FUNCTION
END                                                                                // ends PATCH_FOR_EACH
LAUNCH_PATCH_FUNCTION ~ADD_SPELL_EFFECT~                                           // Start FUNCTION call (add Spell Effect)
  INT_VAR                                                                          // initialize variables
    "opcode" = "172"                                                               // effect: #172 (Remove Spell)
    "target" = "1"                                                                 // target: 1 (self)
    "timing" = "1"                                                                 // timing mode: 1 (permanent)
    "duration" = "0"                                                               // duration
    "sectype" = "0"                                                                // secondary type: none
    "probability1" = "100"                                                         // probability1: 100%
  STR_VAR
    "resource"  = "rr#equa"                                                        // resref
    "effsource" = ""                                                               // effsource: none
END                                                                                // ends LAUNCH_PATCH_FUNCTION


COPY_EXISTING ~spin151.spl~ ~override~                                             // Shapeshifts Natural Form
              ~spin152.spl~ ~override~                                             // Shapeshifts Natural Form
PATCH_FOR_EACH ~weapon~ IN                                                         // grant the following innate abilities
             ~rr#esher~                                                            // Earth Elemental
             ~rr#eshfr~                                                            // Fire Elemental
             ~rr#eshsa~                                                            // Fire Salamander
BEGIN
LAUNCH_PATCH_FUNCTION ~ADD_SPELL_EFFECT~                                           // Start FUNCTION call (add Spell Effect)
  INT_VAR                                                                          // initialize variables
    "opcode" = "112"                                                               // effect: #112 (Remove Item)
    "target" = "1"                                                                 // target: 1 (self)
    "timing" = "1"                                                                 // timing mode: 1 (permanent)
    "duration" = "0"                                                               // duration: 0
    "sectype" = "0"                                                                // secondary type: none
    "probability1" = "100"                                                         // probability1: 100%
  STR_VAR
    "resource"  = EVALUATE_BUFFER "%weapon%"                                       // resref
    "effsource" = ""                                                               // effsource: none
END                                                                                // ends LAUNCH_PATCH_FUNCTION
END                                                                                // ends PATCH_FOR_EACH



// Revised Elemental summoning spells

// Fix Bioware's mixup with Conjure (Lesser) Air Elemental EFFs

COPY_EXISTING ~splesair.eff~  ~override~                                           // Conjure Lesser Air Elemental (8 HD)
  WRITE_ASCII 0x30 "ELAIRSUW" #8                                                   // resref (creature to be summoned)
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~spair1.eff~  ~override~                                             // Conjure Air Elemental (12 HD, mage version)
  WRITE_ASCII 0x30 "ELAIRSU1" #8                                                   // resref (creature to be summoned)
BUT_ONLY_IF_IT_CHANGES



// Summoned elementals should not leave corpses behind after they are slain
// Also, they should not be targetable while the summoning animation plays
// Lastly, the player should have the option to dismiss (unsummon) a summoned creature at will

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~elairsu1~                                                             // Air Elemental (mage summon)
            ~elairsu2~                                                             // Air Elemental (mage summon)
            ~elairsu3~                                                             // Air Elemental (mage summon)
            ~swaair01~                                                             // Air Elemental (priest summon)
            ~swaair02~                                                             // Air Elemental (priest summon)
            ~elairsuw~                                                             // Lesser Air Elemental (mage summon)
            ~sumelair~                                                             // Lesser Air Elemental (staff summon)
            ~elearsu1~                                                             // Earth Elemental (mage summon)
            ~elearsu2~                                                             // Earth Elemental (mage summon)
            ~elearsu3~                                                             // Earth Elemental (mage summon)
            ~elearsu4~                                                             // Earth Elemental (mage summon)
             ~elearpr~                                                             // Earth Elemental (priest summon)
            ~elearpr2~                                                             // Earth Elemental (priest summon)
            ~elearpr3~                                                             // Earth Elemental (priest summon)
            ~swaear01~                                                             // Earth Elemental (priest summon)
            ~swaear02~                                                             // Earth Elemental (priest summon)
            ~elearsuw~                                                             // Lesser Earth Elemental (mage summon)
            ~sumelear~                                                             // Lesser Earth Elemental (staff summon)
            ~elfirsu1~                                                             // Fire Elemental (mage summon)
            ~elfirsu2~                                                             // Fire Elemental (mage summon)
            ~elfirsu3~                                                             // Fire Elemental (mage summon)
            ~elfirsu4~                                                             // Fire Elemental (mage summon)
             ~elfirpr~                                                             // Fire Elemental (priest summon)
            ~elfirpr2~                                                             // Fire Elemental (priest summon)
            ~elfirpr3~                                                             // Fire Elemental (priest summon)
            ~swafir01~                                                             // Fire Elemental (priest summon)
            ~swafir02~                                                             // Fire Elemental (priest summon)
            ~elfirsuw~                                                             // Lesser Fire Elemental (mage summon)
            ~sumelfir~                                                             // Lesser Fire Elemental (staff summon)
            ~elemchan~                                                             // Chan
            ~elemsunn~                                                             // Sunnis
            ~elemzaam~                                                             // Zaaman Rul
              ~servsu~                                                             // Aerial Servant
              ~stalke~                                                             // Invisible Stalker
              tg#wel2                                                              // Water Elemental (Refinements)
              tg#wel3                                                              // Greater Water Elemental (Refinements)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.cre~ BEGIN                                   // if the designated file with an ITM extension exists
COPY_EXISTING ~%file%.cre~ ~override~
  PATCH_IF (SOURCE_SIZE > 0x2d3) THEN BEGIN                                        // protects against invalid files
// =============================================================================== // the actual work starts from here
    READ_BYTE 0x275 gender
    PATCH_IF gender = 6 OR gender = 20 BEGIN                                       // If SUMMONED
      REPLACE_CRE_ITEM fl#etrsu #0 #0 #0 undroppable helmet                        // no immunity to Death Spell
    END
    READ_BYTE 0x10 "flags"                                                         // read initial flags
    PATCH_IF (("%flags%" BAND "0b00000010") = "0b00000000") BEGIN                  // if bit 1 isn't set 
      WRITE_BYTE "0x10" ("%flags%" BOR "0b00000010")                               // set bit 1 (enable No Corpse flag)
      READ_BYTE 0x10 "flags"                                                       // read flags again to account for the previous change
      WRITE_BYTE "0x10" ("%flags%" BAND "0b11111011")                              // unset bit 2 (disable Permanent Corpse flag)
    END
ADD_CRE_ITEM ~RR#DINV~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~AMULET~                 // item which makes creatures invisible and untargetable while they gate in
ADD_MEMORIZED_SPELL ~rr#usumn~ #0 ~innate~ ( 1 )                                   // adds 1x Unsummon
// =============================================================================== // the actual work ends here
END                                                                                // ends file size check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends second ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Conjure Lesser X Elemental (arcane version)

ACTION_DEFINE_ASSOCIATIVE_ARRAY l_elmnt BEGIN
//   rr#var0    rr#var1      rr#file
//   resref      desc          file
     SPLESFIR,   24799    =>  spwi516                                              // Conjure Lesser Fire Elemental
     SPLESAIR,   24800    =>  spwi520                                              // Conjure Lesser Air Elemental
     SPLESEAR,   24797    =>  spwi521                                              // Conjure Lesser Earth Elemental
END                                                                                // ends ACTION_DEFINE_ASSOCIATIVE_ARRAY
ACTION_PHP_EACH l_elmnt AS rr#var => rr#file BEGIN
COPY_EXISTING ~%rr#file%.spl~  ~override~
WRITE_LONG 0x50 "%rr#var_1%"                                                         // unidentified description
LPF prep_itm_spl INT_VAR f_Type = 1 END
LPF configure_spell_header INT_VAR f_Target = 4 f_Range = 15 f_CastTime = 9 STR_VAR f_Icon = EVAL ~%SOURCE_RES%B~ END
LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 duration = 114 STR_VAR resource = EVAL ~%rr#var_0%~ END  // Use EFF file
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  SET "new_abil" = 0
    READ_SHORT ("%abil_off%" + 0x10 + (("%abil_num%" - 1) * 0x28)) "min_level" // min level of last ability header
    FOR (index = min_level + 9 ; index < 21 ; index = index + 1) BEGIN
      READ_ASCII ("%abil_off%" +        (("%abil_num%" - 1) * 0x28)) "abil_clone" (0x28) // reads last ability as block
      READ_SHORT ("%abil_off%" + 0x1e + (("%abil_num%" - 1) * 0x28)) "abil_fx_num" // reads number of fx from last ability
      READ_SHORT ("%abil_off%" + 0x20 + (("%abil_num%" - 1) * 0x28)) "abil_fx_idx" // reads index of last effects from last ability
      // create effects for next level based off previous level effects
      FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
        READ_ASCII ("%fx_off%" +        (("%abil_fx_idx%" + "%index2%") * 0x30)) "clone_fx" (0x30) // reads entire effect
        INSERT_BYTES ("%fx_off%" +        (("%abil_fx_idx%" + "%abil_fx_num%" + "%index2%") * 0x30)) 0x30
        READ_SHORT ("%fx_off%" +        (("%abil_fx_idx%" + "%index2%") * 0x30)) "opcode"          // opcode
        READ_LONG  ("%fx_off%" + 0x0e + (("%abil_fx_idx%" + "%index2%") * 0x30)) "duration"        // duration
          WRITE_EVALUATED_ASCII ("%fx_off%" +        (("%abil_fx_idx%" + "%abil_fx_num%" + "%index2%") * 0x30)) "%clone_fx%" // clones effect
          PATCH_IF ("%opcode%" = 177) BEGIN // Use EFF file
            WRITE_LONG  ("%fx_off%" + 0x0e + (("%abil_fx_idx%" + "%abil_fx_num%" + "%index2%") * 0x30)) ("%duration%" + 6) // increase the duration by 1 round
          END
      END
      // effects created, now add new ability
      INSERT_BYTES            ("%abil_off%" +        ("%abil_num%" * 0x28)) 0x28
        WRITE_EVALUATED_ASCII ("%abil_off%" +        ("%abil_num%" * 0x28)) "%abil_clone%" // clones last ability
        WRITE_SHORT           ("%abil_off%" + 0x10 + ("%abil_num%" * 0x28)) "%index%"      // min level
        WRITE_SHORT           ("%abil_off%" + 0x20 + ("%abil_num%" * 0x28)) ("%abil_fx_num%" + "%abil_fx_idx%") // corrects fx index
      SET "fx_off" = ("%fx_off%" + 0x28)
      SET "abil_num" = "%abil_num%" + 1
    END
    WRITE_SHORT 0x68 "%abil_num%"
    WRITE_LONG  0x6a "%fx_off%"
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_PHP_EACH


// Conjure X Elemental (arcane version)

ACTION_DEFINE_ASSOCIATIVE_ARRAY m_elmnt BEGIN
//   rr#var0    rr#var1     rr#var2      rr#file
//   resref1    resref2     resref3        file
     SPFIR1,    SPFIR2,     SPFIR3    =>  spwi620                                  // Conjure Fire Elemental (mage)
     SPAIR1,    SPAIR2,     SPAIR3    =>  spwi621                                  // Conjure Air Elemental (mage)
     SPEART1,   SPEART2,    SPEART3   =>  spwi622                                  // Conjure Earth Elemental (mage)
END                                                                                // ends ACTION_DEFINE_ASSOCIATIVE_ARRAY
ACTION_PHP_EACH m_elmnt AS rr#var => rr#file BEGIN
COPY_EXISTING ~%rr#file%.spl~  ~override~
LPF prep_itm_spl INT_VAR f_Type = 1 END
LPF configure_spell_header INT_VAR f_Target = 4 f_Range = 35 f_CastTime = 9 STR_VAR f_Icon = EVAL ~%SOURCE_RES%B~ END
LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 duration = 660 probability1 = 100  probability2 = 0   STR_VAR resource = EVAL ~%rr#var_0%~ END  // Regular elemental
LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 duration = 660 probability1 = 95  probability2 = 61  STR_VAR resource = EVAL ~%rr#var_1%~ END  // Greater elemental
LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 duration = 660 probability1 = 100 probability2 = 96  STR_VAR resource = EVAL ~%rr#var_2%~ END  // Elder elemental
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  SET "new_abil" = 0
    READ_SHORT ("%abil_off%" + 0x10 + (("%abil_num%" - 1) * 0x28)) "min_level" // min level of last ability header
    FOR (index = min_level + 11 ; index < 21 ; index = index + 1) BEGIN
      READ_ASCII ("%abil_off%" +        (("%abil_num%" - 1) * 0x28)) "abil_clone" (0x28) // reads last ability as block
      READ_SHORT ("%abil_off%" + 0x1e + (("%abil_num%" - 1) * 0x28)) "abil_fx_num" // reads number of fx from last ability
      READ_SHORT ("%abil_off%" + 0x20 + (("%abil_num%" - 1) * 0x28)) "abil_fx_idx" // reads index of last effects from last ability
      // create effects for next level based off previous level effects
      FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
        READ_ASCII ("%fx_off%" +        (("%abil_fx_idx%" + "%index2%") * 0x30)) "clone_fx" (0x30) // reads entire effect
        INSERT_BYTES ("%fx_off%" +        (("%abil_fx_idx%" + "%abil_fx_num%" + "%index2%") * 0x30)) 0x30
        READ_SHORT ("%fx_off%" +        (("%abil_fx_idx%" + "%index2%") * 0x30)) "opcode"          // opcode
        READ_LONG  ("%fx_off%" + 0x0e + (("%abil_fx_idx%" + "%index2%") * 0x30)) "duration"        // duration
          WRITE_EVALUATED_ASCII ("%fx_off%" +        (("%abil_fx_idx%" + "%abil_fx_num%" + "%index2%") * 0x30)) "%clone_fx%" // clones effect
          PATCH_IF ("%opcode%" = 177) BEGIN // Use EFF file
            WRITE_LONG  ("%fx_off%" + 0x0e + (("%abil_fx_idx%" + "%abil_fx_num%" + "%index2%") * 0x30)) ("%duration%" + 60) // increase the duration by 1 turn
          END
      END
      // effects created, now add new ability
      INSERT_BYTES            ("%abil_off%" +        ("%abil_num%" * 0x28)) 0x28
        WRITE_EVALUATED_ASCII ("%abil_off%" +        ("%abil_num%" * 0x28)) "%abil_clone%" // clones last ability
        WRITE_SHORT           ("%abil_off%" + 0x10 + ("%abil_num%" * 0x28)) "%index%"      // min level
        WRITE_SHORT           ("%abil_off%" + 0x20 + ("%abil_num%" * 0x28)) ("%abil_fx_num%" + "%abil_fx_idx%") // corrects fx index
      SET "fx_off" = ("%fx_off%" + 0x28)
      SET "abil_num" = "%abil_num%" + 1
    END
    WRITE_SHORT 0x68 "%abil_num%"
    WRITE_LONG  0x6a "%fx_off%"
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_PHP_EACH


// Conjure X Elemental (divine version)

ACTION_DEFINE_ASSOCIATIVE_ARRAY p_elmnt BEGIN
//   rr#var0    rr#var1     rr#var2      rr#file
//   resref1    resref2     resref3        file
     SPFIR1P,   SPFIR2P,    SPFIR3P   =>  sppr605                                  // Conjure Fire Elemental (priest)
     SPEART1P,  SPEART2P,   SPEART3P  =>  sppr702                                  // Conjure Earth Elemental (priest)
END                                                                                // ends ACTION_DEFINE_ASSOCIATIVE_ARRAY
ACTION_PHP_EACH p_elmnt AS rr#var => rr#file BEGIN
COPY_EXISTING ~%rr#file%.spl~  ~override~
LPF prep_itm_spl INT_VAR f_Type = 1 END
LPF configure_spell_header INT_VAR f_Target = 4 f_Range = 35 f_CastTime = 9 STR_VAR f_Icon = EVAL ~%SOURCE_RES%B~ END
LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 duration = 660 probability1 = 100  probability2 = 0   STR_VAR resource = EVAL ~%rr#var_0%~ END  // Regular elemental
LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 duration = 660 probability1 = 95  probability2 = 61  STR_VAR resource = EVAL ~%rr#var_1%~ END  // Greater elemental
LPF ADD_SPELL_EFFECT INT_VAR opcode = 177 target = 1 parameter2 = 2 duration = 660 probability1 = 100 probability2 = 96  STR_VAR resource = EVAL ~%rr#var_2%~ END  // Elder elemental
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  SET "new_abil" = 0
    READ_SHORT ("%abil_off%" + 0x10 + (("%abil_num%" - 1) * 0x28)) "min_level" // min level of last ability header
    FOR (index = min_level + 11 ; index < 21 ; index = index + 1) BEGIN
      READ_ASCII ("%abil_off%" +        (("%abil_num%" - 1) * 0x28)) "abil_clone" (0x28) // reads last ability as block
      READ_SHORT ("%abil_off%" + 0x1e + (("%abil_num%" - 1) * 0x28)) "abil_fx_num" // reads number of fx from last ability
      READ_SHORT ("%abil_off%" + 0x20 + (("%abil_num%" - 1) * 0x28)) "abil_fx_idx" // reads index of last effects from last ability
      // create effects for next level based off previous level effects
      FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
        READ_ASCII ("%fx_off%" +        (("%abil_fx_idx%" + "%index2%") * 0x30)) "clone_fx" (0x30) // reads entire effect
        INSERT_BYTES ("%fx_off%" +        (("%abil_fx_idx%" + "%abil_fx_num%" + "%index2%") * 0x30)) 0x30
        READ_SHORT ("%fx_off%" +        (("%abil_fx_idx%" + "%index2%") * 0x30)) "opcode"          // opcode
        READ_LONG  ("%fx_off%" + 0x0e + (("%abil_fx_idx%" + "%index2%") * 0x30)) "duration"        // duration
          WRITE_EVALUATED_ASCII ("%fx_off%" +        (("%abil_fx_idx%" + "%abil_fx_num%" + "%index2%") * 0x30)) "%clone_fx%" // clones effect
          PATCH_IF ("%opcode%" = 177) BEGIN // Use EFF file
            WRITE_LONG  ("%fx_off%" + 0x0e + (("%abil_fx_idx%" + "%abil_fx_num%" + "%index2%") * 0x30)) ("%duration%" + 60) // increase the duration by 1 turn
          END
      END
      // effects created, now add new ability
      INSERT_BYTES            ("%abil_off%" +        ("%abil_num%" * 0x28)) 0x28
        WRITE_EVALUATED_ASCII ("%abil_off%" +        ("%abil_num%" * 0x28)) "%abil_clone%" // clones last ability
        WRITE_SHORT           ("%abil_off%" + 0x10 + ("%abil_num%" * 0x28)) "%index%"      // min level
        WRITE_SHORT           ("%abil_off%" + 0x20 + ("%abil_num%" * 0x28)) ("%abil_fx_num%" + "%abil_fx_idx%") // corrects fx index
      SET "fx_off" = ("%fx_off%" + 0x28)
      SET "abil_num" = "%abil_num%" + 1
    END
    WRITE_SHORT 0x68 "%abil_num%"
    WRITE_LONG  0x6a "%fx_off%"
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_PHP_EACH


COPY ~atweaks/spl/elementals/rr#eswg.spl~ ~override~                               // Elemental Summoning secondary spell (Summon Greater Elementals)
COPY ~atweaks/spl/elementals/rr#eswe.spl~ ~override~                               // Elemental Summoning tertiary spell (Summon Elder Elementals)

COPY_EXISTING ~sppr723.spl~  ~override~                                            // Elemental Summoning
SAY NAME1 #63746 SAY NAME2 #63746  SAY DESC @2206 SAY UNIDENTIFIED_DESC @2206      // retain old name but set new description
LPF DELETE_SPELL_EFFECT INT_VAR opcode_to_delete = "-1" END                        // delete old summoning effects
DEFINE_ASSOCIATIVE_ARRAY es_hla BEGIN
//   prob1     prob2       resref
     100,       91    =>   RR#ESWE                                                 // Elder Elementals
      90,        0    =>   RR#ESWG                                                 // Greater Elementals
END                                                                                // ends DEFINE_ASSOCIATIVE_ARRAY
PHP_EACH es_hla AS value  => resref BEGIN
LAUNCH_PATCH_FUNCTION ~ADD_SPELL_EFFECT~                                           // Start FUNCTION call (add Spell Effect)
  INT_VAR                                                                          // initialize variables
    "opcode" = "146"                                                               // effect: #146 (Cast Spell at Target)
    "target" = "1"                                                                 // target
    "timing" = "1"                                                                 // timing mode
    "parameter2" = "1"                                                             // param2
    "duration" = "0"                                                               // duration
    "sectype" = "0"                                                                // secondary type
    "probability1" = EVALUATE_BUFFER "%value_0%"                                   // probability1
    "probability2" = EVALUATE_BUFFER "%value_1%"                                   // probability2
    "insert_point" = "0"                                                           // insert point (0 = add new effect to the top)
  STR_VAR
    "resource"  =  EVALUATE_BUFFER "%resref%"                                      // resref
    "effsource" = ""                                                               // effsource: none
END                                                                                // ends LAUNCH_PATCH_FUNCTION
END                                                                                // ends PHP_EACH


// Greater Elemental Summoning

COPY_EXISTING ~sppr724.spl~  ~override~                                            // Greater Elemental Summoning
SAY NAME1 #63768 SAY NAME2 #63768  SAY DESC @2211 SAY UNIDENTIFIED_DESC @2211      // retain old name but set new description
LPF DELETE_SPELL_EFFECT INT_VAR opcode_to_delete = "-1" END                        // delete old summoning effects
DEFINE_ASSOCIATIVE_ARRAY ges_hla BEGIN
//   prob1     prob2       resref
     100,       67    =>   SUMSUNN                                                 // Sunnis
      66,       34    =>   SUMCHAN                                                 // Chan
      33,        0    =>   SUMZAAM                                                 // Zaaman Rul
END                                                                                // ends DEFINE_ASSOCIATIVE_ARRAY
PHP_EACH ges_hla AS value  => resref BEGIN
LAUNCH_PATCH_FUNCTION ~ADD_SPELL_EFFECT~                                           // Start FUNCTION call (add Spell Effect)
  INT_VAR                                                                          // initialize variables
    "opcode" = "177"                                                               // effect: #177 (Use EFF File)
    "target" = "1"                                                                 // target
    "timing" = "0"                                                                 // timing mode
    "duration" = "120"                                                             // duration
    "parameter2" = "2"                                                             // param2
    "sectype" = "0"                                                                // secondary type
    "probability1" = EVALUATE_BUFFER "%value_0%"                                   // probability1
    "probability2" = EVALUATE_BUFFER "%value_1%"                                   // probability2
    "insert_point" = "0"                                                           // insert point (0 = add new effect to the top)
  STR_VAR
    "resource"  =  EVALUATE_BUFFER "%resref%"                                      // resref
    "effsource" = ""                                                               // effsource: none
END                                                                                // ends LAUNCH_PATCH_FUNCTION
END                                                                                // ends PHP_EACH
LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 3 duration = 120 parameter1 = 74011 "insert_point" = "-1" STR_VAR resource = SPPR724 END


// Updated spell and item descriptions

COPY_EXISTING  ~scrl6x.itm~  ~override~                                            // Conjure Lesser Fire Elemental (scroll)
SAY UNIDENTIFIED_DESC #24799 SAY DESC #24799

COPY_EXISTING  ~scrl7b.itm~  ~override~                                            // Conjure Lesser Air Elemental (scroll)
SAY UNIDENTIFIED_DESC #24800 SAY DESC #24800

COPY_EXISTING  ~scrl7c.itm~  ~override~                                            // Conjure Lesser Earth Elemental (scroll)
SAY UNIDENTIFIED_DESC #24797 SAY DESC #24797

COPY_EXISTING ~spwi620.spl~  ~override~                                            // Conjure Fire Elemental (arcane spell)
               ~scrl7x.itm~  ~override~                                            // Conjure Fire Elemental (scroll)
SAY UNIDENTIFIED_DESC @2200 SAY DESC @2200

COPY_EXISTING ~spwi621.spl~  ~override~                                            // Conjure Air Elemental (arcane spell)
               ~scrl7y.itm~  ~override~                                            // Conjure Air Elemental (scroll)
SAY UNIDENTIFIED_DESC @2201 SAY DESC @2201

COPY_EXISTING ~spwi622.spl~  ~override~                                            // Conjure Earth Elemental (arcane spell)
               ~scrl7z.itm~  ~override~                                            // Conjure Earth Elemental (scroll)
SAY UNIDENTIFIED_DESC @2202 SAY DESC @2202

COPY_EXISTING ~sppr605.spl~  ~override~                                            // Conjure Fire Elemental (divine spell)
SAY UNIDENTIFIED_DESC @2203 SAY DESC @2203

COPY_EXISTING ~sppr702.spl~  ~override~                                            // Conjure Earth Elemental (divine spell)
SAY UNIDENTIFIED_DESC @2204 SAY DESC @2204

COPY_EXISTING ~sppr731.spl~  ~override~                                            // Fire Elemental Transformation (druid HLA)
SAY UNIDENTIFIED_DESC @2207 SAY DESC @2207

COPY_EXISTING ~sppr732.spl~  ~override~                                            // Earth Elemental Transformation (druid HLA)
SAY UNIDENTIFIED_DESC @2208 SAY DESC @2208


// Make conjure elemental spells use IWD graphics for the summoning circles

// Earth Elementals

COPY_EXISTING ~splesear.eff~  ~override~                                           // Conjure Lesser Earth Elemental (8 HD)
               ~speart1.eff~  ~override~                                           // Conjure Earth Elemental (12 HD, mage version)
               ~speart2.eff~  ~override~                                           // Conjure Earth Elemental (16 HD, mage version)
               ~speart3.eff~  ~override~                                           // Conjure Earth Elemental (24 HD, mage version)
              ~speart1p.eff~  ~override~                                           // Conjure Earth Elemental (12 HD, priest version)
              ~speart2p.eff~  ~override~                                           // Conjure Earth Elemental (16 HD, priest version)
              ~speart3p.eff~  ~override~                                           // Conjure Earth Elemental (24 HD, priest version)
                ~staf16.eff~  ~override~                                           // Conjure Lesser Earth Elemental (8 HD, Staff of Earth version)
              ~swaeare1.eff~  ~override~                                           // Elemental Summoning (16 HD, priest HLA version)
              ~swaeare2.eff~  ~override~                                           // Elemental Summoning (24 HD, priest HLA version)
               ~sumsunn.eff~  ~override~                                           // Summon Sunnis (priest HLA version)
  WRITE_ASCII 0x70 ~RR#CEART~ #8                                                   // resref2: RR#CEART (VVC to display)
  WRITE_LONG  0x18 "0"                                                             // power: 0 (in case the spell is cast directly on a Rakshasa or something)


// Fire Elementals
COPY_EXISTING ~splesfir.eff~  ~override~                                           // Conjure Lesser Fire Elemental (8 HD)
                ~spfir1.eff~  ~override~                                           // Conjure Fire Elemental (12 HD, mage version)
                ~spfir2.eff~  ~override~                                           // Conjure Fire Elemental (16 HD, mage version)
                ~spfir3.eff~  ~override~                                           // Conjure Fire Elemental (24 HD, mage version)
               ~spfir1p.eff~  ~override~                                           // Conjure Fire Elemental (12 HD, priest version)
               ~spfir2p.eff~  ~override~                                           // Conjure Fire Elemental (16 HD, priest version)
               ~spfir3p.eff~  ~override~                                           // Conjure Fire Elemental (24 HD, priest version)
                ~staf17.eff~  ~override~                                           // Conjure Lesser Fire Elemental (8 HD, Staff of Fire version)
              ~swafire1.eff~  ~override~                                           // Elemental Summoning (16 HD, priest HLA version)
              ~swafire2.eff~  ~override~                                           // Elemental Summoning (24 HD, priest HLA version)
               ~sumzaam.eff~  ~override~                                           // Summon Zaaman Rul (priest HLA version)
  WRITE_ASCII 0x70 ~RR#CFIRE~ #8                                                   // resref2: RR#CFIRE (VVC to display)
  WRITE_LONG  0x18 "0"                                                             // power: 0 (in case the spell is cast directly on a Rakshasa or something)


// Air Elementals
COPY_EXISTING ~splesair.eff~  ~override~                                           // Conjure Lesser Air Elemental (8 HD)
                ~spair1.eff~  ~override~                                           // Conjure Air Elemental (12 HD, mage version)
                ~spair2.eff~  ~override~                                           // Conjure Air Elemental (16 HD, mage version)
                ~spair3.eff~  ~override~                                           // Conjure Air Elemental (24 HD, mage version)
                ~staf16.eff~  ~override~                                           // Conjure Lesser Air Elemental (8 HD, Staff of Air version)
              ~swaaire1.eff~  ~override~                                           // Elemental Summoning (16 HD, priest HLA version)
              ~swaaire2.eff~  ~override~                                           // Elemental Summoning (24 HD, priest HLA version)
               ~sumchan.eff~  ~override~                                           // Summon Chan (priest HLA version)
                ~spserv.eff~  ~override~                                           // Aerial Servant
               ~spstalk.eff~  ~override~                                           // Invisible Stalker
  WRITE_ASCII 0x70 ~SPPORTAL~ #8                                                   // resref2: SPPORTAL (VVC to display)
  WRITE_LONG  0x18 "0"                                                             // power: 0 (in case the spell is cast directly on a Rakshasa or something)
BUT_ONLY_IF_IT_CHANGES


// Revised summoned elemental scripts (note: summoner targeting is now handled via the main script, so it needs to be removed from here)
// These scripts are no longer used by aTweaks, but patch them just in case

COPY_EXISTING ~wizelsu2.bcs~ ~override~
              ~wizelsum.bcs~ ~override~
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY CASE_SENSITIVE EVALUATE_REGEXP ~^IF[%LNL%].+Global("Elementalcontrol","LOCALS",2)\([%LNL%].+\)+[%LNL%]END$~ ~~
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES


// Add Conjure Lesser Elemental scrolls to BGT/Tutu and some BG2 stores

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
               ~jayes~                                                             // Jayes' store (the halfling who appears during night time at Waukeen's Promenade)
             ~sto0703~                                                             // Sorcerous Sundries (BGT version)
            ~_sto0703~                                                             // Sorcerous Sundries (Tutu version)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN                                   // if the designated file with a STO extension exists
COPY_EXISTING ~%file%.sto~ ~override~
PATCH_IF (%SOURCE_SIZE% > 0x9b) THEN BEGIN                                         // file size sanity check (filters out 0 byte files i.e. ALLOW_MISSING)
// =============================================================================== // the actual work starts from here
PATCH_IF NOT FILE_CONTAINS_EVALUATED (~%SOURCE_FILE%~ ~SCRL7C~) BEGIN              // if the store doesn't already have the specified item
  ADD_STORE_ITEM ~SCRL7C~   AFTER  ~%TUTU_VAR%SCRL5P~ #1 #0 #0 ~IDENTIFIED~ #2     // Adds 2x Conjure Lesser Earth Elemental scroll
END
PATCH_IF NOT FILE_CONTAINS_EVALUATED (~%SOURCE_FILE%~ ~SCRL7B~) BEGIN              // if the store doesn't already have the specified item
  ADD_STORE_ITEM ~SCRL7B~   BEFORE  ~SCRL7C~ #1 #0 #0 ~IDENTIFIED~ #2              // Adds 2x Conjure Lesser Air Elemental scroll
END
PATCH_IF NOT FILE_CONTAINS_EVALUATED (~%SOURCE_FILE%~ ~SCRL6X~) BEGIN              // if the store doesn't already have the specified item
  ADD_STORE_ITEM ~SCRL6X~   BEFORE  ~SCRL7B~ #1 #0 #0 ~IDENTIFIED~ #2              // Adds 2x Conjure Lesser Air Elemental scroll
END
// =============================================================================== // the actual work ends here
END                                                                                // ends file size check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Make a custom Air Elemental to be summoned by Chan and Yan-C-Bin

COPY_EXISTING ~elairsu1.cre~ ~override/rr#eairr.cre~                               // Air Elemental
  REMOVE_CRE_ITEM ~RIDRING~                                                        // selection circle removal ring
  WRITE_ASCII_LIST 0x248 ~rr#eair~ ~~ ~~ ~~ ~~                                     // assign new override script, null other scripts
  WRITE_ASCII 0x280 ~rr#eairr~ #32                                                 // assign new death variable



/////////////////////////////
// More sensible encounters
/////////////////////////////

// Create hostile versions of Elder Elementals and Aerial Servants

OUTER_SPRINT $script(rr#eaire) rr#eair
OUTER_SPRINT $script(rr#eeare) rr#eear
OUTER_SPRINT $script(rr#efire) rr#efir
OUTER_SPRINT $script(rr#easer) rr#easer

COPY_EXISTING ~swaair02.cre~ ~override/rr#eaire.cre~                               // Elder Air Elemental
              ~swaear02.cre~ ~override/rr#eeare.cre~                               // Elder Earth Elemental
              ~swafir02.cre~ ~override/rr#efire.cre~                               // Elder Fire Elemental
                ~servsu.cre~ ~override/rr#easer.cre~                               // Aerial Servant
  WRITE_ASCII_LIST 0x248 $script("%DEST_RES%") ~~ ~~ ~~ ~~                         // assign new override script, null other scripts
  WRITE_BYTE   0x270 255                                                           // allegiance = ENEMY
  WRITE_BYTE   0x275   4                                                           // gender = NEITHER
  WRITE_ASCIIE 0x280 ~%DEST_RES%~ #32                                              // death variable
  WRITE_ASCII  0x2cc ~~ #8                                                         // dialog file


// The Frost Salamanders in Abazigal's lair should only EscapeArea() if they are actually in AR6005

COPY_EXISTING ~deadabaz.bcs~ ~override~
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~Dead("Abazigal")~ ~Dead("Abazigal") AreaCheck("AR6005")~
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES


// Shoal's kiss should not be forced upon the party

<<<<<<<<atweaks/inlined/baf/elementals/shoal.baf
IF
    NumTimesTalkedToGT(0)
    Global("rr#intd","LOCALS",0)
    !Dead("Droth")
    HPPercentLT(Myself,51)
    See([PC])    
THEN
    RESPONSE #100
        SetGlobal("rr#intd","LOCALS",1)
        SetGlobal("ShoalHit","GLOBAL",1)
        FaceObject([PC])
        StartDialogueNoSet([PC])
END
>>>>>>>>

ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
               ~shoal~                                                             // Shoal's script (BGT)
              ~_shoal~                                                             // Shoal's script (Tutu)
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.bcs~ BEGIN                                   // if the designated file with a BCS extension exists
COPY_EXISTING ~%file%.bcs~ ~override~
PATCH_IF (%SOURCE_SIZE% > 0x01) THEN BEGIN                                         // file size sanity check (filters out 0 byte files i.e. ALLOW_MISSING)
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~HitBy([PC],CRUSHING)~ ~AttackedBy([PC],DEFAULT) NumTimesTalkedTo(0)~
  REPLACE_TEXTUALLY EXACT_MATCH ~Dialogue([PC])~ ~FaceObject([PC]) StartDialogueNoSet([PC])~
  REPLACE_TEXTUALLY EXACT_MATCH ~Dialog([PC])~ ~FaceObject([PC]) StartDialogueNoSet([PC])~
COMPILE_BAF_TO_BCS
END                                                                                // ends file size check
BUT_ONLY_IF_IT_CHANGES
EXTEND_BOTTOM ~%file%.bcs~  ~atweaks/inlined/baf/elementals/shoal.baf~             // extend Shoal's script
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block

<<<<<<<<atweaks/inlined/dlg/elementals/shoal.d
ALTER_TRANS ~%TUTU_VAR%SHOAL~ BEGIN 3 END BEGIN 0 END BEGIN
  "REPLY" ~#70151~ // Alright...
END

EXTEND_BOTTOM ~%TUTU_VAR%SHOAL~ 3 
  IF ~~ THEN REPLY #33428 GOTO rr#shl01 // I said no and I mean it.
END

APPEND ~%TUTU_VAR%SHOAL~
  IF ~~ THEN BEGIN rr#shl01
    SAY @2114 // So be it, then! I do not wish to fight you <RACE>, but I have little choice in the matter.
  IF ~~ THEN DO ~SetGlobal("ShoalHit","GLOBAL",1) Enemy()~ EXIT
  END
END
>>>>>>>>

ACTION_IF GAME_INCLUDES ~bg1~ THEN BEGIN
  COMPILE EVALUATE_BUFFER ~atweaks/inlined/dlg/elementals/shoal.d~
  COPY_EXISTING ~%TUTU_VAR%shoal.dlg~ ~override~
  DECOMPILE_DLG_TO_D
    REPLACE_TEXTUALLY EXACT_MATCH ~ForceSpell(Myself,SHOAL_REVIVE)~ ~ForceSpell(Myself,SHOAL_REVIVE) ReallyForceSpellRES("rr#uchrm",Myself)~ // Shoal should uncharm all party members before they face Droth
    REPLACE_TEXTUALLY EXACT_MATCH ~CreateCreature("DROTH",[2500.500],6)~ ~Wait(2) CreateCreatureObjectDoor("DROTH","Shoal",0,0,0)~ // BGT, make Droth appear next to Shoal instead of spawning at a fixed location
    REPLACE_TEXTUALLY EXACT_MATCH ~CreateCreature("_DROTH",[2500.500],0)~ ~Wait(2) CreateCreatureObjectDoor("_DROTH","Shoal",0,0,0)~ // Tutu, make Droth appear next to Shoal instead of spawning at a fixed location
    REPLACE_TEXTUALLY EXACT_MATCH ~ActionOverride("Droth",MoveToPoint([2900.525]))~ ~~ // movement action made unnecessary via different spawning method
  COMPILE_D_TO_DLG
END


// Add more Nereids to the game

<<<<<<<<atweaks/inlined/baf/elementals/bg3600.baf
IF
    Global("rr#spw01","MYAREA",0)
THEN
    RESPONSE #100
        SetGlobal("rr#spw01","MYAREA",1)
        CreateCreature("rr#enere",[175.1780],13) // Nereid (left)
        CreateCreature("rr#enere",[400.1820],8) // Nereid (right)
END
>>>>>>>>

<<<<<<<<atweaks/inlined/baf/elementals/bg1500.baf
IF
    Global("rr#spw01","MYAREA",0)
THEN
    RESPONSE #100
        SetGlobal("rr#spw01","MYAREA",1)
        CreateCreature("rr#enere",[1125.585],15) // Nereid (top)
        CreateCreature("rr#enere",[1155.730],13) // Nereid (bottom)
END
>>>>>>>>

ACTION_IF GAME_IS ~tutu_totsc~ THEN BEGIN
  EXTEND_BOTTOM ~fw1500.bcs~  ~atweaks/inlined/baf/elementals/bg1500.baf~          // extend the Balduran's Isle North area script (Tutu)
  EXTEND_BOTTOM ~fw3600.bcs~  ~atweaks/inlined/baf/elementals/bg3600.baf~          // extend the Lighthouse area script (Tutu)
END

ACTION_IF GAME_IS ~bgt~ THEN BEGIN
  EXTEND_BOTTOM ~arw500.bcs~  ~atweaks/inlined/baf/elementals/bg1500.baf~          // extend the Balduran's Isle North area script (BGT)
  EXTEND_BOTTOM ~ar9500.bcs~  ~atweaks/inlined/baf/elementals/bg3600.baf~          // extend the Lighthouse area script (BGT)
END

ACTION_IF GAME_IS ~bgee~ BEGIN
  EXTEND_BOTTOM ar1500.bcs ~atweaks/inlined/baf/elementals/bg1500.baf~
  COPY_EXISTING ar3600.are override
    READ_ASCII 0x94 script
    PATCH_IF "%script%" STRING_EQUAL_CASE ar3601 BEGIN
      SPRINT script ar3600
      WRITE_ASCIIE 0x94 "%script%" #8
    END
  BUT_ONLY
  EXTEND_BOTTOM "%script%.bcs" ~atweaks/inlined/baf/elementals/bg3600.baf~
END

ACTION_IF GAME_IS ~eet~ BEGIN
  EXTEND_BOTTOM ~bg1500.bcs~ ~atweaks/inlined/baf/elementals/bg1500.baf~          // extend the Balduran's Isle North area script (EET)
  EXTEND_BOTTOM ~bg3600.bcs~ ~atweaks/inlined/baf/elementals/bg3600.baf~          // extend the Lighthouse area script (EET)
END

<<<<<<<<atweaks/inlined/baf/elementals/ar1700.baf
IF
    Global("rr#spw01","AR1700",0)
THEN
    RESPONSE #100
        SetGlobal("rr#spw01","AR1700",1)
        CreateCreature("rr#enere",[1200.2530],0) // Nereid (top)
        CreateCreature("rr#enere",[1150.2600],14) // Nereid (middle)
        CreateCreature("rr#enere",[1240.2650],13) // Nereid (bottom)
END
>>>>>>>>

EXTEND_BOTTOM ~ar1700.bcs~  ~atweaks/inlined/baf/elementals/ar1700.baf~            // extend the Small Teeth Pass area script (BG2)

<<<<<<<<atweaks/inlined/baf/elementals/ar2300.baf
IF
    Global("rr#spw01","AR2300",0)
THEN
    RESPONSE #100
        SetGlobal("rr#spw01","AR2300",1)
        CreateCreature("rr#enere",[2470.1110],0) // Nereid (top)
        CreateCreature("rr#enere",[2340.1135],14) // Nereid (middle)
        CreateCreature("rr#enere",[2395.1220],13) // Nereid (bottom)
END
>>>>>>>>

EXTEND_BOTTOM ~ar2300.bcs~  ~atweaks/inlined/baf/elementals/ar2300.baf~            // extend the Sahuagin City area script (BG2)


// Replace regular Fire Salamanders with Salamander Nobles in the Fire Giant temple

COPY_EXISTING ~itiwall1.bcs~ ~override~
              ~itiwall2.bcs~ ~override~
               ~yssumm3.bcs~ ~override~
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~HGSAL01~ ~SALGRFIR~
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES


// Remove Fire Salamanders from Mekrath's lair since they don't get along with Frost Salamanders

COPY_EXISTING ~spwnmon.bcs~ ~override~
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~icsalfir~ ~icsalcol~
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES


// Add an Ice Paraelemental and a Salamander Noble to the Planar Sphere's ice and fire chambers

<<<<<<<<atweaks/inlined/baf/elementals/ar0412.baf
IF
    Global("rr#spw01","AR0412",0)
THEN
    RESPONSE #100
        SetGlobal("rr#spw01","AR0412",1)
        CreateCreature("rr#eicer",[850.480],0) // Ice Paraelemental
        CreateCreature("SALGRFIR",[2070.1020],4) // Salamander Noble
END
>>>>>>>>

COPY_EXISTING ~ar0412.are~ ~override~                                                                 // AR0412 is missing its area script in the unmodded game
READ_ASCII 0x94 ~areascript~
  PATCH_IF ~%areascript%~ STRING_EQUAL_CASE ~~ OR ~%areascript%~ STRING_EQUAL_CASE ~None~ THEN BEGIN  // if no area script has been assigned
    WRITE_ASCII 0x94 ~AR0412~ #8                                                                      // assign the default area script
    SPRINT ~areascript~ ~AR0412~                                                                      // assign the AR0306 string to the %areascript% variable
  END
BUT_ONLY_IF_IT_CHANGES
ACTION_IF !FILE_EXISTS_IN_GAME ~%areascript%.bcs~ THEN BEGIN                                          // if the area script doesn't exist
  COMPILE ~atweaks/inlined/baf/elementals/ar0412.baf~                                                 // compile it from scratch
END ELSE BEGIN
  EXTEND_BOTTOM ~%areascript%.bcs~ ~atweaks/inlined/baf/elementals/ar0412.baf~                        // otherwise just extend it
END


// Make the Underdark portals spawn 1 Greater Elemental and 2 regular Elementals

<<<<<<<<atweaks/inlined/baf/elementals/ar2100.baf
IF
    Global("rr#spw01","AR2100",0)
THEN
    RESPONSE #100
        SetGlobal("rr#spw01","AR2100",1)
        CreateCreature("elair01",[780.2865],12) // Air Elemental (top)
        CreateCreature("elair01",[780.2950],10) // Air Elemental (bottom)
		CreateCreature("elear01",[2500.3270],4) // Earth Elemental (top)
		CreateCreature("elear01",[2500.3350],6) // Earth Elemental (bottom)
		CreateCreature("elfir01",[2800.3040],4) // Fire Elemental (top)
		CreateCreature("elfir01",[2738.3080],6) // Fire Elemental (bottom)
END
>>>>>>>>

EXTEND_BOTTOM ~ar2100.bcs~  ~atweaks/inlined/baf/elementals/ar2100.baf~                               // add more elementals near the portals

COPY_EXISTING ~dwair.bcs~ ~override~
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~NumDeadLT("udair",11)~ ~NumDeadLT("udair",6)~ // lower spawn count to 5
  REPLACE_TEXTUALLY CASE_SENSITIVE EVALUATE_REGEXP ~^IF[%LNL%].+See(\[ANYONE\])\([%LNL%].+\)+[%LNL%]END$~ ~~ // remove the combat oriented block
  REPLACE_TEXTUALLY CASE_SENSITIVE EVALUATE_REGEXP ~RESPONSE #100[%LNL%].+CreateCreature("udair",\[842.2890\],0)~ // new spawns
~RESPONSE #20
CreateCreature("udair",[842.2890],0) CreateCreature("elair01",[780.2865],12) CreateCreature("rr#easer",[780.2950],10) // 1x greater, 1x regular, 1x Aerial Servant
RESPONSE #20
CreateCreature("udair",[842.2890],0) CreateCreature("elair01",[780.2865],12) CreateCreature("rr#easer",[780.2950],10) // 1x greater, 1x regular, 1x Aerial Servant
RESPONSE #20
CreateCreature("udair",[842.2890],0) CreateCreature("elair01",[780.2865],12) CreateCreature("rr#eaire",[780.2950],10) // 1x greater, 1x regular, 1x elder
RESPONSE #20
CreateCreature("udair",[842.2890],0) CreateCreature("elairl01",[780.2865],12) CreateCreature("elairl01",[780.2950],10) // 1x greater, 2x lesser
RESPONSE #20
CreateCreature("udair",[842.2890],0) CreateCreature("elairg01",[780.2865],12) CreateCreature("elair01",[780.2950],10)~ // 2x greater, 1x regular
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES


COPY_EXISTING ~dwearth.bcs~ ~override~
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~NumDeadLT("udearth",11)~ ~NumDeadLT("udearth",6)~ // lower spawn count to 5
  REPLACE_TEXTUALLY CASE_SENSITIVE EVALUATE_REGEXP ~^IF[%LNL%].+See(\[ANYONE\])\([%LNL%].+\)+[%LNL%]END$~ ~~ // remove the combat oriented block
  REPLACE_TEXTUALLY CASE_SENSITIVE EVALUATE_REGEXP ~RESPONSE #100[%LNL%].+CreateCreature("udearth",\[2397.3280\],0)~ // new spawns
~RESPONSE #20
CreateCreature("udearth",[2397.3280],0) CreateCreature("elear01",[2500.3270],4) CreateCreature("elear01",[2500.3350],6) // 1x greater, 2x regular
RESPONSE #20
CreateCreature("udearth",[2397.3280],0) CreateCreature("elear01",[2500.3270],4) CreateCreature("elearl01",[2500.3350],6) // 1x greater, 1x regular, 1x lesser
RESPONSE #20
CreateCreature("udearth",[2397.3280],0) CreateCreature("elear01",[2500.3270],4) CreateCreature("rr#eeare",[2500.3350],6) // 1x greater, 1x regular, 1x elder
RESPONSE #20
CreateCreature("udearth",[2397.3280],0) CreateCreature("elearl01",[2500.3270],4) CreateCreature("elearl01",[2500.3350],6) // 1x greater, 2x lesser
RESPONSE #20
CreateCreature("udearth",[2397.3280],0) CreateCreature("elearg01",[2500.3270],4) CreateCreature("elear01",[2500.3350],6)~ // 2x greater, 1x regular
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES


COPY_EXISTING ~dwfire.bcs~ ~override~
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~NumDeadLT("udfire",11)~ ~NumDeadLT("udfire",6)~ // lower spawn count to 5
  REPLACE_TEXTUALLY CASE_SENSITIVE EVALUATE_REGEXP ~^IF[%LNL%].+See(\[ANYONE\])\([%LNL%].+\)+[%LNL%]END$~ ~~ // remove the combat oriented block
  REPLACE_TEXTUALLY CASE_SENSITIVE EVALUATE_REGEXP ~RESPONSE #100[%LNL%].+CreateCreature("udfire",\[2738.2993\],0)~ // new spawns
~RESPONSE #20
CreateCreature("udfire",[2738.2993],0) CreateCreature("elfir01",[2800.3040],4) CreateCreature("elfir01",[2738.3080],6) // 1x greater, 2x regular
RESPONSE #20
CreateCreature("udfire",[2738.2993],0) CreateCreature("elfir01",[2800.3040],4) CreateCreature("elfirl01",[2738.3080],6) // 1x greater, 1x regular, 1x lesser
RESPONSE #20
CreateCreature("udfire",[2738.2993],0) CreateCreature("elfir01",[2800.3040],4) CreateCreature("rr#efire",[2738.3080],6) // 1x greater, 1x regular, 1x elder
RESPONSE #20
CreateCreature("udfire",[2738.2993],0) CreateCreature("elfirl01",[2800.3040],4) CreateCreature("elfirl01",[2738.3080],6) // 1x greater, 2x lesser
RESPONSE #20
CreateCreature("udfire",[2738.2993],0) CreateCreature("elfirg01",[2800.3040],4) CreateCreature("elfir01",[2738.3080],6)~ // 2x greater, 1x regular
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES


// Give Vithal a better chance of surviving against aTweaks' portal guardians by adding defensive sequencers and slightly changing his offensive spell repertoire

COPY_EXISTING ~dwvith.bcs~ ~override~
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~See([0.0.0.0.10])~ ~See([0.0.0.0.10]) !GlobalTimerNotExpired("RR#Cast","LOCALS")~
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES

<<<<<<<<atweaks/inlined/baf/elementals/dwvith.baf
IF
    See([0.0.0.0.10]) // elemental portal guardians
    Global("RR#Seq","LOCALS",0) // Spell Sequencer
    !GlobalTimerNotExpired("RR#Cast","LOCALS")
    !StateCheck(Myself,STATE_SILENCED)
THEN
    RESPONSE #100
        SetGlobal("RR#Seq","LOCALS",1)
        SetGlobalTimer("RR#Cast","LOCALS",6)
        FaceObject([0.0.0.0.10]) // elemental portal guardians
        SetSequence(SEQ_CAST) // Displays the proper casting animation (for cosmetic purposes)
        DisplayStringHead(Myself,25951) // Spell Sequencer
        ReallyForceSpell(Myself,WIZARD_PROTECTION_FROM_FIRE)
        ReallyForceSpell(Myself,WIZARD_MIRROR_IMAGE)
        ReallyForceSpell(Myself,WIZARD_STONE_SKIN)
END

IF
    See([0.0.0.0.10]) // elemental portal guardians
    !GlobalTimerNotExpired("RR#Cast","LOCALS")
    Global("RR#MSeq","LOCALS",0) // Minor Sequencer
	!StateCheck(Myself,STATE_MIRRORIMAGE)
    !StateCheck(Myself,STATE_SILENCED)
THEN
    RESPONSE #100
        SetGlobal("RR#MSeq","LOCALS",1)
        SetGlobalTimer("RR#Cast","LOCALS",6)
        FaceObject([0.0.0.0.10]) // elemental portal guardians
        SetSequence(SEQ_CAST) // Displays the proper casting animation (for cosmetic purposes)
        DisplayStringHead(Myself,5013) // Minor Sequencer
        ReallyForceSpell(Myself,WIZARD_BLUR)
        ReallyForceSpell(Myself,WIZARD_MIRROR_IMAGE)
END
>>>>>>>>

EXTEND_TOP ~dwvith.bcs~  ~atweaks/inlined/baf/elementals/dwvith.baf~            // extend Vithal's AI script


// Add an Ice Paraelemental to the Ice Island's dungeon in BG1

<<<<<<<<atweaks/inlined/baf/elementals/bg1009.baf
IF
    Global("rr#spw01","MYAREA",0)
THEN
    RESPONSE #100
        SetGlobal("rr#spw01","MYAREA",1)
        CreateCreature("rr#eicer",[340.680],11) // Ice Paraelemental
END
>>>>>>>>

ACTION_IF GAME_IS ~tutu_totsc~ THEN BEGIN
  EXTEND_BOTTOM ~_ar1009.bcs~  ~atweaks/inlined/baf/elementals/bg1009.baf~         // extend the Ice Island dungeon area script (Tutu)
END

ACTION_IF GAME_IS ~bgt~ THEN BEGIN
  EXTEND_BOTTOM ~aru009.bcs~  ~atweaks/inlined/baf/elementals/bg1009.baf~          // extend the Ice Island dungeon area script (BGT)
END

ACTION_IF GAME_IS ~bgee~ BEGIN
  COPY_EXISTING ar1009.are override
    READ_ASCII 0x94 script
    PATCH_IF "%script%" STRING_EQUAL_CASE "" OR
             "%script%" STRING_EQUAL_CASE "none"
    BEGIN
      SPRINT script ar1009
      WRITE_ASCIIE 0x94 "%script%" #8
    END
  BUT_ONLY
  EXTEND_BOTTOM "%script%.bcs" ~atweaks/inlined/baf/elementals/bg1009.baf~
END

ACTION_IF GAME_IS ~eet~ THEN BEGIN
  EXTEND_BOTTOM ~bg1009.bcs~  ~atweaks/inlined/baf/elementals/bg1009.baf~         // extend the Ice Island dungeon area script (EET)
END


// Slightly tweak Water Elemetal spawns in Abazigal's lair

COPY_EXISTING ~ptelew01.bcs~ ~override~
              ~ptelew02.bcs~ ~override~
              ~ptelew03.bcs~ ~override~
DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~ICRMPARI~ ~rr#envlp~ // use aTweaks visual effect
  REPLACE_TEXTUALLY EXACT_MATCH ~CreateCreatureImpassable~ ~CreateCreature~ // spawn the creatures in a passable area
  REPLACE_TEXTUALLY EXACT_MATCH ~ELWATG01~ ~rr#ewate~ // Replace Greater with Elder Water Elementals
COMPILE_BAF_TO_BCS
BUT_ONLY_IF_IT_CHANGES


// Replace the Lesser Air Elemental which occasionally spawns in Spellhold with an Aerial Servant

COPY_EXISTING ~ar1500.are~ ~override~                                              // Spellhold, outside
  READ_LONG 0x60 spawn_off
  READ_SHORT 0x64 spawn_num
  FOR (n=0; n < "%spawn_num%"; n+=1) BEGIN
  READ_ASCII  ("%spawn_off%" + "%n%"*0xc8 + 0x2c) "cre_file"
    PATCH_IF ("%cre_file%" STRING_EQUAL_CASE "ELAIRL01") BEGIN
      WRITE_ASCII ("%spawn_off%" + "%n%"*0xc8 + 0x2c) ~rr#easer~ #8
    END
  END
BUT_ONLY_IF_IT_CHANGES

// Replace the Lesser Air Elemental which occasionally spawns in Spellhold with an Aerial Servant

COPY_EXISTING ~ar1500.are~ ~override~                                              // Spellhold, outside
  READ_LONG 0x60 spawn_off
  READ_SHORT 0x64 spawn_num
  FOR (n=0; n < "%spawn_num%"; n+=1) BEGIN
  READ_ASCII  ("%spawn_off%" + "%n%"*0xc8 + 0x2c) "cre_file"
    PATCH_IF ("%cre_file%" STRING_EQUAL_CASE "ELAIRL01") BEGIN
      WRITE_ASCII ("%spawn_off%" + "%n%"*0xc8 + 0x2c) ~rr#easer~ #8
    END
  END
BUT_ONLY_IF_IT_CHANGES


// Replace the Burning Men near Imix with Elder Fire Elementals

COPY_EXISTING ~ar5204.are~ ~override~                                              // Yaga-Shura's lair
  READ_LONG  0x54 "actor_off"
  READ_SHORT 0x58 "actor_num"
  WHILE ("%actor_num%" > 0) BEGIN
    SET "actor_num" = ("%actor_num%" - 1)
    READ_ASCII ("%actor_off%" + 0x80 + ("%actor_num%" * 0x110)) "cre_file"
    PATCH_IF ("%cre_file%" STRING_EQUAL_CASE "GOLBUR01") BEGIN
      WRITE_ASCII ("%actor_off%" + 0x80 + ("%actor_num%" * 0x110)) ~rr#efire~ #8
    END
  END
BUT_ONLY_IF_IT_CHANGES

// Add two Salamander Nobles near Imix

<<<<<<<<atweaks/inlined/baf/elementals/ar5204.baf
IF
    Global("rr#spw01","AR5204",0)
THEN
    RESPONSE #100
        SetGlobal("rr#spw01","AR5204",1)
        CreateCreature("SALGRFIR",[1700.330],0) // Salamander Noble (left)
        CreateCreature("SALGRFIR",[1765.365],0) // Salamander Noble (right)
END
>>>>>>>>

EXTEND_BOTTOM ~ar5204.bcs~  ~atweaks/inlined/baf/elementals/ar5204.baf~            // extend the area script for Yaga-Shura's lair


// Replace the Greater Earth Elementals near Ogremoch with Elder Earth Elementals

COPY_EXISTING ~ar6105.are~ ~override~                                              // Ogremoch's lair in Sendai's enclave
  READ_LONG  0x54 "actor_off"
  READ_SHORT 0x58 "actor_num"
  WHILE ("%actor_num%" > 0) BEGIN
    SET "actor_num" = ("%actor_num%" - 1)
    READ_ASCII ("%actor_off%" + 0x80 + ("%actor_num%" * 0x110)) "cre_file"
    PATCH_IF ("%cre_file%" STRING_EQUAL_CASE "ELEARG01") BEGIN
      WRITE_ASCII ("%actor_off%" + 0x80 + ("%actor_num%" * 0x110)) ~rr#eeare~ #8
    END
  END
BUT_ONLY_IF_IT_CHANGES


// Replace the Lesser Earth Elementals at the enterance of Abazigal's lair with Greater Water Elementals

COPY_EXISTING ~ar6001.are~ ~override~                                              // enterance to Abazigal's lair (pool room)
  READ_LONG  0x54 "actor_off"
  READ_SHORT 0x58 "actor_num"
  WHILE ("%actor_num%" > 0) BEGIN
    SET "actor_num" = ("%actor_num%" - 1)
    READ_ASCII ("%actor_off%" + 0x80 + ("%actor_num%" * 0x110)) "cre_file"
    PATCH_IF ("%cre_file%" STRING_EQUAL_CASE "ELEARL01") BEGIN
      WRITE_ASCII ("%actor_off%" + 0x80 + ("%actor_num%" * 0x110)) ~ELWATG01~ #8
    END
  END
BUT_ONLY_IF_IT_CHANGES



/////////////////////////////
// Compatibility adjustments
/////////////////////////////

// TobEx

// Add the non-dispellable flag to aTweaks' shapechange weapons, in case ToBEx is, or will be, installed
ACTION_FOR_EACH ~file~ IN                                                          // for each of the following files
            ~rr#esher~                                                             // Earth Elemental shapeshift attack
            ~rr#eshfr~                                                             // Fire Elemental shapeshift attack
            ~rr#eshee~                                                             // Elder Earth Elemental shapeshift attack
            ~rr#eshfe~                                                             // Elder Fire Elemental shapeshift attack
            ~rr#eshsa~                                                             // Fire Salamander shapeshift attack
BEGIN                                                                              // execute the following
ACTION_IF FILE_EXISTS_IN_GAME ~%file%.itm~ BEGIN                                   // if the designated file with an ITM extension exists
COPY_EXISTING ~%file%.itm~ ~override~
  PATCH_IF (SOURCE_SIZE > 0x71) THEN BEGIN                                         // protects against invalid files
// =============================================================================== // the actual work starts from here
    WRITE_LONG 0x18 THIS | BIT24   
// =============================================================================== // the actual work ends here
END                                                                                // ends file size check
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends second ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_FOR_EACH block


// Spell Revisions

// Restore the original descriptions for spells that show SR's creature stats

ACTION_IF MOD_IS_INSTALLED spell_rev.tp2 0 BEGIN
//==================================================================================

COPY_EXISTING ~sppr601.spl~  ~override~                                            // Aerial Servant
SAY DESC #25740 SAY UNIDENTIFIED_DESC #25740                                       // restore original description
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~spwi601.spl~  ~override~                                            // Invisible Stalker
               ~scrl7e.itm~  ~override~                                            // Invisible Stalker (scroll)
SAY DESC #8062 SAY UNIDENTIFIED_DESC #8062                                         // restore original description
BUT_ONLY_IF_IT_CHANGES

COPY_EXISTING ~rr#srbk1.spl~  ~override/sppr702.spl~                               // Restore SR's Summon Shambling Mound

// Allow druids to have Conjure Air and Earth elementals as level 6 spells

COPY ~atweaks/spl/elementals/sr_cmpt/sppr621.spl~ ~override~                       // Conjure Air Elemental (SR)
SAY DESC @2205 SAY UNIDENTIFIED_DESC @2205

COPY ~atweaks/spl/elementals/sr_cmpt/sppr622.spl~ ~override~                       // Conjure Earth Elemental (SR)
SAY DESC @2212 SAY UNIDENTIFIED_DESC @2212

COPY ~atweaks/spl/elementals/sr_cmpt/sppr731.spl~ ~override~                       // Fire Elemental Transformation
SAY UNIDENTIFIED_DESC @2207 SAY DESC @2207

COPY ~atweaks/spl/elementals/sr_cmpt/sppr732.spl~ ~override~                       // Earth Elemental Transformation
SAY UNIDENTIFIED_DESC @2208 SAY DESC @2208


// Ensure that all summoned elementals are properly named, i.e. undo SR's changes
ACTION_DEFINE_ASSOCIATIVE_ARRAY sr_names BEGIN
//   rr#var0     rr#file
//    name       file
     2845  =>   elairsuw                                                           // Lesser Air Elemental (8 HD, arcane version)
     2831  =>   elairsu1                                                           // Air Elemental (12 HD, arcane version)
     2848  =>   elairsu2                                                           // Greater Air Elemental (16 HD, arcane version)
     2850  =>   elearsuw                                                           // Lesser Earth Elemental (8 HD, arcane version)
     2867  =>   elearsu2                                                           // Earth Elemental (12 HD, arcane version)
     2853  =>   elearsu3                                                           // Greater Earth Elemental (16 HD, arcane version)
     2867  =>   elearpr                                                            // Earth Elemental (12 HD, divine version)
     2853  =>   elearpr2                                                           // Greater Earth Elemental (16 HD, divine version)
     2878  =>   elfirsuw                                                           // Lesser Fire Elemental (8 HD, arcane version)
     2873  =>   elfirsu2                                                           // Fire Elemental (12 HD, arcane version)
     2876  =>   elfirsu3                                                           // Greater Fire Elemental (16 HD, arcane version)
     2873  =>   elfirpr                                                            // Fire Elemental (12 HD, divine version)
     2876  =>   elfirpr2                                                           // Greater Fire Elemental (16 HD, divine version)
END                                                                                // ends ACTION_DEFINE_ASSOCIATIVE_ARRAY
ACTION_PHP_EACH sr_names AS rr#var => rr#file BEGIN
ACTION_IF FILE_EXISTS_IN_GAME ~%rr#file%.cre~ BEGIN                                // if the designated file with a EFF extension exists
COPY_EXISTING ~%rr#file%.cre~  ~override~
  WRITE_LONG 0x08 "%rr#var_0%"                                                     // Name1
  WRITE_LONG 0x0c "%rr#var_0%"                                                     // Name2
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_PHP_EACH


// Ensure that the elemental summoning EFFs actually summon the intended creatures
// Also, make the arcane versions of the summons initially neutral, as in the unmodded game

ACTION_DEFINE_ASSOCIATIVE_ARRAY sr_effs BEGIN
//   rr#var0    rr#var1      rr#file
//   resref1    param2         file
     ELAIRSUW,    2     =>   splesair                                              // Conjure Lesser Air Elemental (8 HD, arcane version)
     ELAIRSU1,    2     =>   spair1                                                // Conjure Air Elemental (12 HD, arcane version)
     ELAIRSU2,    2     =>   spair2                                                // Conjure Greater Air Elemental (16 HD, arcane version)
     ELAIRSU3,    2     =>   spair3                                                // Conjure Elder Air Elemental (20 HD, arcane version)
       SERVSU,    0     =>   spserv                                                // Aerial Servant
       STALKE,    0     =>   spstalk                                               // Invisible Stalker
     ELEARSUW,    2     =>   splesear                                              // Conjure Lesser Earth Elemental (8 HD, arcane version)
     ELEARSU2,    2     =>   speart1                                               // Conjure Earth Elemental (12 HD, arcane version)
     ELEARSU3,    2     =>   speart2                                               // Conjure Greater Earth Elemental (16 HD, arcane version)
     ELEARSU4,    2     =>   speart3                                               // Conjure Elder Earth Elemental (20 HD, arcane version)
     ELEARPR,     0     =>   speart1p                                              // Conjure Earth Elemental (12 HD, divine version)
     ELEARPR2,    0     =>   speart2p                                              // Conjure Greater Earth Elemental (16 HD, divine version)
     ELEARPR3,    0     =>   speart3p                                              // Conjure Elder Earth Elemental (20 HD, divine version)
     ELFIRSUW,    2     =>   splesfir                                              // Conjure Lesser Fire Elemental (8 HD, arcane version)
     ELFIRSU2,    2     =>   spfir1                                                // Conjure Fire Elemental (12 HD, arcane version)
     ELFIRSU3,    2     =>   spfir2                                                // Conjure Greater Fire Elemental (16 HD, arcane version)
     ELFIRSU4,    2     =>   spfir3                                                // Conjure Elder Fire Elemental (20 HD, arcane version)
     ELFIRPR,     0     =>   spfir1p                                               // Conjure Fire Elemental (12 HD, divine version)
     ELFIRPR2,    0     =>   spfir2p                                               // Conjure Greater Fire Elemental (16 HD, divine version)
     ELFIRPR3,    0     =>   spfir3p                                               // Conjure Elder Fire Elemental (20 HD, divine version)
END                                                                                // ends ACTION_DEFINE_ASSOCIATIVE_ARRAY
ACTION_PHP_EACH sr_effs AS rr#var => rr#file BEGIN
ACTION_IF FILE_EXISTS_IN_GAME ~%rr#file%.eff~ BEGIN                                // if the designated file with a EFF extension exists
COPY_EXISTING ~%rr#file%.eff~  ~override~
  WRITE_ASCIIE 0x30 "%rr#var_0%" #8                                                // resref (creature to be summoned) 
  WRITE_LONG   0x20 EVAL "%rr#var_1%"                                              // param2: control
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_PHP_EACH

// Make sure that elementals are friendly when summoned by druids

<<<<<<<<atweaks/inlined/baf/elementals/wizelsu.baf
IF
	Global("Elementalcontrol","LOCALS",0)
    Class(LastSummonerOf(Myself),DRUID_ALL)
	Allegiance(LastSummonerOf(Myself),GOODCUTOFF)
THEN
	RESPONSE #100
        SetInterrupt(FALSE)
		SetGlobal("Elementalcontrol","LOCALS",3)
        SetGlobal("RR#Active","LOCALS",1)
        Ally()
        DestroyItem("RIDRING") // selection circle removal ring
        ChangeAIScript("",OVERRIDE) // clear the slot previously used by this script
        SetInterrupt(TRUE)
END
>>>>>>>>

EXTEND_TOP ~wizelsum.bcs~  ~atweaks/inlined/baf/elementals/wizelsu.baf~
EXTEND_TOP ~wizelsu2.bcs~  ~atweaks/inlined/baf/elementals/wizelsu.baf~
EXTEND_TOP ~rr#ewizs.bcs~  ~atweaks/inlined/baf/elementals/wizelsu.baf~


//==================================================================================
END                                                                                // ends Spell Revisions compatibility block



// Item Revisions

ACTION_IF MOD_IS_INSTALLED ITEM_REV.TP2 0 THEN BEGIN                               // Item Revisions mod check
//==================================================================================
// Lesser Elementals summoned from items shold not use CREs from the wizard spells because of mental combat issues

ACTION_DEFINE_ASSOCIATIVE_ARRAY ir_rings BEGIN                                     // Make IR's rings summon the proper elemental versions to avoid mental combat
//   rr#var0     rr#var1       rr#file
//   resref1     resref2       file
     SUMELFIR,   RR#CFIRE  =>  ring27                                              // Conjure Lesser Fire Elemental
     SUMELAIR,   SPPORTAL  =>  ring28                                              // Conjure Lesser Air Elemental
     SUMELEAR,   RR#CEART  =>  ring29                                              // Conjure Lesser Earth Elemental
END                                                                                // ends ACTION_DEFINE_ASSOCIATIVE_ARRAY
ACTION_PHP_EACH ir_rings AS rr#var => rr#file BEGIN
ACTION_IF FILE_EXISTS_IN_GAME ~%rr#file%.eff~ BEGIN                                // if the designated file with a EFF extension exists
COPY_EXISTING ~%rr#file%.eff~  ~override~
  WRITE_ASCIIE 0x30 "%rr#var_0%" #8                                                // resref (creature to be summoned) 
  WRITE_ASCIIE 0x70 "%rr#var_1%" #8                                                // resref2 (VVC to display)
BUT_ONLY_IF_IT_CHANGES
END                                                                                // ends ACTION_IF FILE_EXISTS_IN_GAME block
END                                                                                // ends ACTION_PHP_EACH
//==================================================================================
END                                                                                // ends Item Revisions compatibility block

